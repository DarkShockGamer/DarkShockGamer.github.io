<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trident Robotics — Task Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, sans-serif; }
    .dragging { opacity: 0.5; transform: scale(1.05); }
    .droppable-hover { background-color: #e0f2fe !important; }
    .dropdown { position: relative; width: 10rem; }
    .dropdown-btn { width: 100%; border: 1px solid #cfe3f5; border-radius: 0.375rem; padding: 0.5rem; background: white; cursor: pointer; text-align: left; }
    .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #cfe3f5; border-radius: 0.375rem; background: white; max-height: 200px; overflow-y: auto; display: none; z-index: 10; }
    .dropdown-list label { display: flex; align-items: center; padding: 0.25rem 0.5rem; cursor: pointer; }
    .dropdown-list label:hover { background-color: #e0f2fe; }
    .tag-chip { display: inline-block; background: #bae6fd; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; margin-right: 0.25rem; margin-bottom: 0.25rem; font-size: 0.75rem; }
  </style>
</head>
<body class="min-h-screen p-6">

<header class="max-w-6xl mx-auto mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-extrabold text-sky-800">Trident Robotics — Task Board</h1>
      <p class="text-sm text-sky-600">A page made to track team tasks</p>
    </div>
    <div class="flex gap-3 items-center">
      <input id="filterInput" placeholder="Search or filter by assignee..."
        class="px-3 py-2 rounded-lg border border-sky-200 shadow-sm text-sm" />
      <div class="text-xs text-sky-600">Theme: Robotics Blue</div>
    </div>
  </div>

  <div class="mt-4 bg-white p-4 rounded-2xl shadow-sm border border-sky-100">
    <div class="flex gap-3 flex-wrap items-center">
      <input id="newTitle" class="flex-1 rounded-md border border-sky-200 px-3 py-2"
        placeholder="Task title (e.g. prototype the intake)" />
      <input id="newAssignee" class="w-40 rounded-md border border-sky-200 px-3 py-2"
        placeholder="Assignee" />
      <input id="newDue" type="date" class="w-40 rounded-md border border-sky-200 px-3 py-2" />

      <!-- Custom multi-select dropdown -->
      <div class="dropdown" id="tagDropdown">
        <div class="dropdown-btn" id="dropdownBtn">Select tags...</div>
        <div class="dropdown-list" id="dropdownList">
          <label><input type="checkbox" value="Design" /> Design</label>
          <label><input type="checkbox" value="Mechanical" /> Mechanical</label>
          <label><input type="checkbox" value="Programming" /> Programming</label>
          <label><input type="checkbox" value="Electrical" /> Electrical</label>
          <label><input type="checkbox" value="Business" /> Business</label>
          <label><input type="checkbox" value="Misc" /> Misc</label>
        </div>
      </div>

      <button id="addTaskBtn"
        class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-md font-semibold">
        Add Task
      </button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto">
  <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Columns rendered here -->
  </div>
  <footer class="mt-12 text-center py-4 border-t border-sky-100 flex flex-col items-center gap-1">
    <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
    <span class="text-sky-600 text-sm">© 2025 Trident Robotics — Task Board</span>
    <span class="text-xs text-sky-400">Internal team dashboard • Customize as needed</span>
  </footer>
</main>

<!-- Firebase Integration -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, getDoc, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHFWZI",
    authDomain: "tridenttaskboard.firebaseapp.com",
    projectId: "tridenttaskboard",
    storageBucket: "tridenttaskboard.firebasestorage.app",
    messagingSenderId: "143400263387",
    appId: "1:143400263387:web:66ed521ae75af588e836fe",
    measurementId: "G-F12DDQCX87"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.firestoreDB = db;
</script>

<script type="module">
import { collection, getDocs, addDoc, setDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const board = document.getElementById("board");
const filterInput = document.getElementById("filterInput");
const addBtn = document.getElementById("addTaskBtn");

// Custom dropdown elements
const dropdownBtn = document.getElementById("dropdownBtn");
const dropdownList = document.getElementById("dropdownList");

// Track selected tags
let selectedTags = [];

// Toggle dropdown
dropdownBtn.addEventListener("click", e => {
  dropdownList.style.display = dropdownList.style.display === "block" ? "none" : "block";
});

// Close dropdown on click outside
document.addEventListener("click", e => {
  if (!document.getElementById("tagDropdown").contains(e.target)) {
    dropdownList.style.display = "none";
    updateDropdownBtn();
  }
});

// Update dropdown button text
function updateDropdownBtn() {
  if (selectedTags.length === 0) {
    dropdownBtn.textContent = "Select tags...";
  } else {
    dropdownBtn.textContent = selectedTags.join(", ");
  }
}

// Handle checkbox changes
dropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => {
  cb.addEventListener("change", () => {
    selectedTags = Array.from(dropdownList.querySelectorAll("input:checked")).map(c => c.value);
    updateDropdownBtn();
  });
});

// Load tasks
async function loadTasks() {
  const snapshot = await getDocs(collection(window.firestoreDB, "tasks"));
  const data = {
    columns: {
      todo: { title: "To Do", tasks: [] },
      inprogress: { title: "In Progress", tasks: [] },
      done: { title: "Done", tasks: [] }
    },
    order: ["todo","inprogress","done"]
  };
  snapshot.forEach(doc => {
    const t = doc.data();
    if (!data.columns[t.column]) data.columns[t.column] = { title: t.column, tasks: [] };
    data.columns[t.column].tasks.push({ id: doc.id, ...t });
  });
  return data;
}

async function saveTask(task, col) {
  await setDoc(doc(window.firestoreDB, "tasks", task.id), {...task, column: col});
}

async function deleteTaskFirestore(taskId) {
  await deleteDoc(doc(window.firestoreDB, "tasks", taskId));
}

async function renderBoard() {
  const data = await loadTasks();
  board.innerHTML = "";
  data.order.forEach(colId => {
    const col = data.columns[colId];
    const colEl = document.createElement("section");
    colEl.className = "bg-white rounded-2xl p-4 shadow-sm border border-sky-100 flex flex-col";
    colEl.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-sky-700">${col.title}</h2>
        <div class="text-sm text-sky-500">${col.tasks.length}</div>
      </div>
      <div class="task-list min-h-[120px] space-y-3" data-col="${colId}"></div>
    `;
    board.appendChild(colEl);

    const list = colEl.querySelector(".task-list");
    col.tasks
      .filter(t => {
        const f = filterInput.value.toLowerCase();
        return !f || t.title.toLowerCase().includes(f) || t.assignee.toLowerCase().includes(f) || (t.tags || []).join(" ").toLowerCase().includes(f);
      })
      .forEach(task => list.appendChild(createTaskEl(task, colId)));

    makeDroppable(list);
  });
}

function createTaskEl(task, colId) {
  const div = document.createElement("div");
  div.className = "bg-white border border-sky-100 rounded-lg p-3 shadow-sm";
  div.draggable = true;
  div.dataset.id = task.id;
  div.dataset.col = colId;
  div.innerHTML = `
    <div class="flex items-start justify-between gap-2">
      <div>
        <h3 class="font-medium text-sky-800">${task.title}</h3>
        <div class="text-xs text-sky-500">${task.assignee} • ${task.due || "no due"}</div>
      </div>
      <div class="flex gap-2">
        <button class="text-xs px-2 py-1 border border-sky-200 rounded-md edit-btn">Edit</button>
        <button class="text-xs px-2 py-1 border border-red-100 rounded-md text-red-600 del-btn">Delete</button>
      </div>
    </div>
    <div class="mt-2 flex gap-2 flex-wrap">
      ${(task.tags || []).map(t => `<span class="tag-chip">${t}</span>`).join("")}
    </div>
  `;

  div.querySelector(".del-btn").onclick = async () => {
    await deleteTaskFirestore(task.id);
    renderBoard();
  };

  div.querySelector(".edit-btn").onclick = () => {
    openEditModal(task, colId);
  };

  makeDraggable(div);
  return div;
}

function makeDroppable(el) {
  el.addEventListener("dragover", e => { 
    e.preventDefault(); 
    el.classList.add("droppable-hover"); 
  });
  el.addEventListener("dragleave", () => el.classList.remove("droppable-hover"));
  el.addEventListener("drop", async e => {
    e.preventDefault();
    el.classList.remove("droppable-hover");
    const { id, from } = JSON.parse(e.dataTransfer.getData("text/plain"));
    if (!id) return;
    const to = el.dataset.col;
    if (from === to) return;
    const taskDocRef = doc(window.firestoreDB, "tasks", id);
    const taskSnap = await getDoc(taskDocRef);
    if (!taskSnap.exists()) return;
    await setDoc(taskDocRef, { ...taskSnap.data(), column: to }, { merge: true });
    await renderBoard();
  });
}

function makeDraggable(el) {
  el.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", JSON.stringify({ id: el.dataset.id, from: el.dataset.col }));
    el.classList.add("dragging");
  });
  el.addEventListener("dragend", () => el.classList.remove("dragging"));
}

// Add new task
addBtn.onclick = async () => {
  const title = document.getElementById("newTitle").value.trim();
  if (!title) return;

  const assignee = document.getElementById("newAssignee").value || "Unassigned";
  const due = document.getElementById("newDue").value;

  const task = { title, assignee, due, tags: selectedTags.slice(), column: "todo" };

  const docRef = await addDoc(collection(window.firestoreDB, "tasks"), task);
  task.id = docRef.id;

  document.getElementById("newTitle").value = "";
  document.getElementById("newAssignee").value = "";
  document.getElementById("newDue").value = "";
  selectedTags = [];
  dropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
  updateDropdownBtn();

  await renderBoard();
};

filterInput.oninput = renderBoard;
renderBoard();
</script>

</body>
</html>
