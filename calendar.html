<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Pre-paint theme application to prevent FOUC -->
  <script>
    (function() {
      const theme = localStorage.getItem('site-theme') || 'system';
      if (theme !== 'system') {
        const classes = { 'light': 'theme-light', 'dark': 'theme-dark', 'high-contrast': 'theme-high-contrast' };
        const className = classes[theme];
        if (className) document.documentElement.classList.add(className);
      }
    })();
  </script>
  <title>Trident Robotics — Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Match tasks.html overall vibe */
    /* Allow full-page scrolling instead of locking to viewport */
    html, body { min-height: 100%; overflow: auto; }
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Day cell styling */
    .day-cell {
      background: white;
      border: 1px solid #e2e8f0; /* slate-200 */
      border-radius: 0.75rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      min-width: 0;
      transition: border-color 150ms, box-shadow 150ms, transform 150ms;
      cursor: pointer;
    }
    .day-cell:hover {
      border-color: #93c5fd; /* sky-300 */
      box-shadow: 0 6px 16px rgba(2,132,199,0.12);
      transform: translateY(-1px);
    }
    .day-muted { opacity: 0.45; }
    .today-dot {
      display: inline-block;
      width: 0.375rem;
      height: 0.375rem;
      background: #0ea5e9; /* sky-500 */
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    /* Presence dots for quick glance of events/tasks */
    .presence-dot {
      display: inline-block;
      width: 0.375rem;
      height: 0.375rem;
      border-radius: 9999px;
      margin-left: 0.25rem;
      border: 1px solid transparent;
    }
    .presence-event { background: #bae6fd; border-color: #7dd3fc; }   /* sky-200 / sky-300 */
    .presence-task  { background: #a7f3d0; border-color: #6ee7b7; }   /* emerald-200 / emerald-300 */

    .event-pill,
    .task-pill {
      display: block;
      font-size: 0.75rem;
      line-height: 1.1rem;
      border-radius: 0.5rem;
      padding: 0.125rem 0.375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    /* Event pill uses CSS variables so each event can have its own color (light/dark) */
    .event-pill {
      background: var(--ev-bg, #e0f2fe);
      color: var(--ev-fg, #0369a1);
      border: 1px solid var(--ev-br, #bae6fd);
    }
    .task-pill {
      background: #ecfdf5;       /* emerald-50 */
      color: #047857;            /* emerald-700 */
      border: 1px solid #a7f3d0; /* emerald-200 */
    }
    .more-pill {
      display: inline-block;
      font-size: 0.72rem;
      color: #64748b;            /* slate-500 */
    }

    .weekday {
      font-size: 0.75rem;
      color: #0369a1; /* sky-700 */
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; border-radius: 0.75rem; width: min(720px, calc(100vw - 2rem)); max-height: min(80vh, 640px); overflow: auto; border: 1px solid #e2e8f0; }

    /* Dark mode to match tasks.html */
    @media (prefers-color-scheme: dark) {
      html, body { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #0b1220, #0a0f1a); color: #e5e7eb; }
      .day-cell { background: #0f172a !important; border-color: #1f2937 !important; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.3); }
      .day-cell:hover { border-color: #0ea5e9 !important; box-shadow: 0 6px 16px rgba(14,165,233,0.18); }

      .weekday { color: #7dd3fc !important; }
      /* Event pill dark colors provided via variables, with sensible defaults */
      .event-pill {
        background: var(--ev-bg-dark, #0c4a6e) !important;
        color: var(--ev-fg-dark, #e0f2fe) !important;
        border-color: var(--ev-br-dark, #075985) !important;
      }
      .task-pill  { background: #052e2b !important; color: #a7f3d0 !important; border-color: #065f46 !important; }
      .more-pill { color: #94a3b8 !important; }
      .presence-event { background: #0c4a6e !important; border-color: #075985 !important; }
      .presence-task  { background: #052e2b !important; border-color: #065f46 !important; }

      .modal-card { background: #0f172a !important; border-color: #1f2937 !important; }
    }

    @media (max-width: 420px) {
      .today-dot, .presence-dot {
        width: 0.3rem;
        height: 0.3rem;
        margin-left: 0.2rem;
      }
      .event-pill, .task-pill {
        font-size: 0.7rem;
        padding: 0.1rem 0.3rem;
      }
    }

    /* Toasts: Slide-in + Sound-ready */
    .toast-stack {
      position: fixed;
      right: 1rem;
      top: 1rem;
      display: grid;
      gap: 0.5rem;
      z-index: 1003;
    }
    .toast {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 0.75rem;
      border-radius: 0.5rem;
      min-width: 240px;
      background: white;
      border: 1px solid #e2e8f0;
      transform: translateX(16px);
      opacity: 0;
      transition: all 200ms ease;
      box-shadow: 0 10px 24px rgba(2,132,199,0.08);
      will-change: opacity, transform;
    }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.success { border-color: #bbf7d0; background: #f0fdf4; color: #065f46; }
    .toast.info    { border-color: #bae6fd; background: #eff6ff; color: #075985; }
    .toast.warn    { border-color: #fde68a; background: #fffbea; color: #92400e; }
    .toast.error   { border-color: #fecaca; background: #fef2f2; color: #7f1d1d; }
    @media (prefers-color-scheme: dark) {
      .toast { background: #0f172a; border-color: #1f2937; color: #e5e7eb; box-shadow: 0 10px 24px rgba(14,165,233,.18); }
      .toast.success { border-color: #064e3b; background: #052e2b; color: #bbf7d0; }
      .toast.info    { border-color: #0c4a6e; background: #052335; color: #bae6fd; }
      .toast.warn    { border-color: #78350f; background: #2f1f05; color: #fde68a; }
      .toast.error   { border-color: #7f1d1d; background: #2b0b0b; color: #fecaca; }
    }

    /* --- Theme Overrides --- */
    /* Light Theme */
    html.theme-light body {
      background: linear-gradient(to bottom, #f0f9ff, white);
      color: #1e293b;
    }
    html.theme-light .day-cell {
      background: white !important;
      border-color: #e2e8f0 !important;
      box-shadow: 0 1px 2px rgba(2, 6, 23, 0.05);
    }
    html.theme-light .day-cell:hover {
      border-color: #93c5fd !important;
    }
    html.theme-light .modal-card {
      background: white !important;
      border-color: #e2e8f0 !important;
    }
    html.theme-light .weekday {
      color: #0369a1 !important;
    }

    /* Dark Theme */
    html.theme-dark body {
      background: linear-gradient(to bottom, #0b1220, #0a0f1a);
      color: #e5e7eb;
    }
    html.theme-dark .day-cell {
      background: #0f172a !important;
      border-color: #1f2937 !important;
      box-shadow: 0 1px 2px rgba(2, 6, 23, 0.3);
    }
    html.theme-dark .day-cell:hover {
      border-color: #0ea5e9 !important;
      box-shadow: 0 6px 16px rgba(14,165,233,0.18);
    }
    html.theme-dark .weekday {
      color: #7dd3fc !important;
    }
    html.theme-dark .event-pill {
      background: var(--ev-bg-dark, #0c4a6e) !important;
      color: var(--ev-fg-dark, #e0f2fe) !important;
      border-color: var(--ev-br-dark, #075985) !important;
    }
    html.theme-dark .task-pill {
      background: #052e2b !important;
      color: #a7f3d0 !important;
      border-color: #065f46 !important;
    }
    html.theme-dark .modal-card {
      background: #0f172a !important;
      border-color: #1f2937 !important;
    }
    html.theme-dark input, html.theme-dark textarea, html.theme-dark select {
      background: #0b1220 !important;
      color: #e5e7eb !important;
      border-color: #334155 !important;
    }

    /* High Contrast Theme */
    html.theme-high-contrast body {
      background: #000000;
      color: #ffffff;
    }
    html.theme-high-contrast .day-cell {
      background: #1a1a1a !important;
      border: 2px solid #ffffff !important;
      box-shadow: none;
    }
    html.theme-high-contrast .day-cell:hover {
      border-color: #ffff00 !important;
    }
    html.theme-high-contrast .weekday {
      color: #ffffff !important;
    }
    html.theme-high-contrast .event-pill {
      background: #ffff00 !important;
      color: #000000 !important;
      border: 2px solid #ffffff !important;
    }
    html.theme-high-contrast .task-pill {
      background: #00ff00 !important;
      color: #000000 !important;
      border: 2px solid #ffffff !important;
    }
    html.theme-high-contrast .modal-card {
      background: #1a1a1a !important;
      border: 2px solid #ffffff !important;
    }
    html.theme-high-contrast input, html.theme-high-contrast textarea,
    html.theme-high-contrast select {
      background: #000000 !important;
      border: 2px solid #ffffff !important;
      color: #ffffff !important;
    }
    html.theme-high-contrast button {
      border: 2px solid #ffffff !important;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <header class="max-w-7xl mx-auto mb-4 px-2">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0">
      <div class="flex flex-col gap-1 w-full md:w-auto">
        <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">Trident Robotics — Calendar</h1>
        <p class="text-sm text-sky-600 dark:text-sky-400">Public events for everyone. Team tasks appear only when signed in with Google on the home page.</p>
      </div>

      <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-end">
        <div id="taskAccessBadge" class="text-xs px-2 py-1 rounded border border-slate-300 text-slate-600 bg-white shadow-sm dark:bg-slate-900 dark:text-slate-300 dark:border-slate-700">
          Tasks hidden • Sign in on the home page
        </div>
      </div>
    </div>

    <div class="mt-3 bg-white p-3 rounded-2xl shadow-sm border border-slate-200 ring-1 ring-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:ring-slate-900/10">
      <div class="flex flex-col gap-2">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="prevBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Previous month">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div id="monthLabel" class="text-base font-semibold text-slate-700 dark:text-slate-200 min-w-[10ch]"></div>
            <button id="nextBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Next month">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>

          <!-- Desktop legend (with labels) -->
          <div class="hidden sm:flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
            <span class="inline-flex items-center gap-1">
              <span class="w-3 h-3 rounded bg-sky-200 border border-sky-300 dark:bg-[#0c4a6e] dark:border-[#075985]"></span>
              Event
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 dark:bg-[#052e2b] dark:border-[#065f46]"></span>
              Task due
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="today-dot"></span>
              Today
            </span>
          </div>

          <!-- Mobile legend (dots only, with titles) -->
          <div class="flex sm:hidden items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
            <span class="inline-flex items-center" title="Event">
              <span aria-label="Event" class="w-3 h-3 rounded bg-sky-200 border border-sky-300 dark:bg-[#0c4a6e] dark:border-[#075985]"></span>
            </span>
            <span class="inline-flex items-center" title="Task due">
              <span aria-label="Task due" class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 dark:bg-[#052e2b] dark:border-[#065f46]"></span>
            </span>
            <span class="inline-flex items-center" title="Today">
              <span aria-label="Today" class="today-dot"></span>
            </span>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="todayBtn" class="px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Today</button>
          <label class="text-sm text-slate-600 dark:text-slate-300">Jump to
            <input id="monthPicker" type="month" class="ml-2 rounded-md border border-slate-300 px-2 py-1 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
          </label>
          <button id="exportIcsBtn" class="px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Export .ics</button>

          <!-- Admin-only -->
          <div id="adminControls" class="hidden ml-auto items-center gap-2">
            <button id="addEventBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Add Event</button>
            <button id="addScheduleBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Add Schedule</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto flex flex-col">
    <!-- Weekday header -->
    <div id="weekdayHeader" class="grid grid-cols-7 px-2 py-2">
      <div class="weekday">Sun</div>
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
    </div>

    <!-- Calendar grid (7 x 6) -->
    <div id="calendarGrid" class="grid grid-cols-7 grid-rows-6 gap-2 px-2 overflow-hidden"></div>

    <footer class="mt-4 text-center py-4 border-t border-slate-100 dark:border-slate-800 flex flex-col items-center gap-1">
      <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
      <span class="text-sky-600 dark:text-sky-400 text-sm">© 2025 Trident Robotics — Calendar</span>
      <span class="text-xs text-sky-400">Public calendar • Tasks appear when signed in</span>
    </footer>
  </main>

  <!-- Day details modal -->
  <div id="dayModal" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div id="modalDate" class="text-lg font-bold text-slate-800 dark:text-slate-200"></div>
          <div class="text-xs text-slate-500 dark:text-slate-400">All items for this date</div>
        </div>
        <button id="closeModal" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div id="modalContent" class="space-y-5">
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Events</div>
          <div id="modalEvents" class="space-y-2 text-sm"></div>
        </div>
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Tasks due</div>
          <div id="modalTasks" class="space-y-2 text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event editor modal (single event) -->
  <div id="eventEditor" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold text-slate-800 dark:text-slate-200" id="eventEditorTitle">Add Event</div>
        <button id="closeEventEditor" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm">Title
          <input id="evTitle" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Robotics Meeting" />
        </label>
        <label class="text-sm">Date
          <input id="evDate" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">Start time
          <input id="evStart" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">End time
          <input id="evEnd" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm md:col-span-2">Location
          <input id="evLoc" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Room 123" />
        </label>
        <label class="text-sm">Color
          <select id="evColor" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm bg-white dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200">
            <option value="sky">Sky (Blue)</option>
            <option value="indigo">Indigo</option>
            <option value="purple">Purple</option>
            <option value="rose">Rose</option>
            <option value="orange">Orange</option>
            <option value="amber">Amber</option>
            <option value="emerald">Emerald (Green)</option>
            <option value="teal">Teal</option>
            <option value="cyan">Cyan</option>
          </select>
        </label>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="evPublic" type="checkbox" class="w-4 h-4" checked />
          Public (visible to everyone)
        </label>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="saveEventBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Schedule builder modal (recurring meetings) -->
  <div id="scheduleEditor" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold text-slate-800 dark:text-slate-200">Add Meeting Schedule</div>
        <button id="closeScheduleEditor" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm md:col-span-2">Title
          <input id="scTitle" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Robotics Meeting" />
        </label>
        <label class="text-sm">From
          <input id="scFrom" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">To
          <input id="scTo" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">Start time
          <input id="scStart" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">End time
          <input id="scEnd" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm md:col-span-2">Location
          <input id="scLoc" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Shop / Room 123" />
        </label>
        <label class="text-sm">Color
          <select id="scColor" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm bg-white dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200">
            <option value="sky">Sky (Blue)</option>
            <option value="indigo">Indigo</option>
            <option value="purple">Purple</option>
            <option value="rose">Rose</option>
            <option value="orange">Orange</option>
            <option value="amber">Amber</option>
            <option value="emerald">Emerald (Green)</option>
            <option value="teal">Teal</option>
            <option value="cyan">Cyan</option>
          </select>
        </label>
        <div class="md:col-span-2">
          <div class="text-sm font-medium mb-1">Weekdays</div>
          <div class="flex flex-wrap gap-2 text-sm">
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="0" /> Sun</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="1" /> Mon</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="2" /> Tue</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="3" /> Wed</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="4" /> Thu</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="5" /> Fri</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="6" /> Sat</label>
          </div>
        </div>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="scPublic" type="checkbox" class="w-4 h-4" checked />
          Public (visible to everyone)
        </label>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="scReplace" type="checkbox" class="w-4 h-4" />
          Replace existing events with the same title in this range
        </label>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="saveScheduleBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Create</button>
      </div>
    </div>
  </div>

  <!-- Toast stack -->
  <div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    // Same Firebase project as tasks.html
    const firebaseConfig = {
      apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHFWZI",
      authDomain: "tridenttaskboard.firebaseapp.com",
      projectId: "tridenttaskboard",
      storageBucket: "tridenttaskboard.firebasestorage.appspot.com",
      messagingSenderId: "143400263387",
      appId: "1:143400263387:web:66ed521ae75af588e836fe",
      measurementId: "G-F12DDQCX87"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Color palettes for event pills (light/dark)
    const EVENT_COLOR_MAP = {
      sky:     { light:{bg:"#e0f2fe", fg:"#0369a1", br:"#bae6fd"}, dark:{bg:"#0c4a6e", fg:"#e0f2fe", br:"#075985"} },
      indigo:  { light:{bg:"#e0e7ff", fg:"#3730a3", br:"#c7d2fe"}, dark:{bg:"#312e81", fg:"#c7d2fe", br:"#3730a3"} },
      purple:  { light:{bg:"#f3e8ff", fg:"#6b21a8", br:"#e9d5ff"}, dark:{bg:"#3b0764", fg:"#e9d5ff", br:"#6b21a8"} },
      rose:    { light:{bg:"#ffe4e6", fg:"#9f1239", br:"#fecdd3"}, dark:{bg:"#4c0519", fg:"#fecdd3", br:"#9f1239"} },
      orange:  { light:{bg:"#ffedd5", fg:"#9a3412", br:"#fed7aa"}, dark:{bg:"#7c2d12", fg:"#fed7aa", br:"#9a3412"} },
      amber:   { light:{bg:"#fef3c7", fg:"#92400e", br:"#fde68a"}, dark:{bg:"#78350f", fg:"#fde68a", br:"#92400e"} },
      emerald: { light:{bg:"#ecfdf5", fg:"#047857", br:"#a7f3d0"}, dark:{bg:"#052e2b", fg:"#a7f3d0", br:"#065f46"} },
      teal:    { light:{bg:"#ccfbf1", fg:"#115e59", br:"#99f6e4"}, dark:{bg:"#134e4a", fg:"#99f6e4", br:"#0f766e"} },
      cyan:    { light:{bg:"#cffafe", fg:"#155e75", br:"#a5f3fc"}, dark:{bg:"#164e63", fg:"#a5f3fc", br:"#0e7490"} },
    };
    const DEFAULT_EVENT_COLOR = "sky";
    const sanitizeEventColor = (c) => (EVENT_COLOR_MAP[c] ? c : DEFAULT_EVENT_COLOR);

    function applyEventColorVars(el, colorKey) {
      const c = EVENT_COLOR_MAP[sanitizeEventColor(colorKey)];
      el.style.setProperty("--ev-bg", c.light.bg);
      el.style.setProperty("--ev-fg", c.light.fg);
      el.style.setProperty("--ev-br", c.light.br);
      el.style.setProperty("--ev-bg-dark", c.dark.bg);
      el.style.setProperty("--ev-fg-dark", c.dark.fg);
      el.style.setProperty("--ev-br-dark", c.dark.br);
    }
    function styleAttrForEventColor(colorKey) {
      const c = EVENT_COLOR_MAP[sanitizeEventColor(colorKey)];
      return `style="--ev-bg:${c.light.bg};--ev-fg:${c.light.fg};--ev-br:${c.light.br};--ev-bg-dark:${c.dark.bg};--ev-fg-dark:${c.dark.fg};--ev-br-dark:${c.dark.br};"`;
    }

    // DOM
    const monthLabel = document.getElementById("monthLabel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const todayBtn = document.getElementById("todayBtn");
    const monthPicker = document.getElementById("monthPicker");
    const exportIcsBtn = document.getElementById("exportIcsBtn");
    const grid = document.getElementById("calendarGrid");
    const badge = document.getElementById("taskAccessBadge");

    // Admin UI
    const adminControls = document.getElementById("adminControls");
    const addEventBtn = document.getElementById("addEventBtn");
    const addScheduleBtn = document.getElementById("addScheduleBtn");

    // Day modal
    const modal = document.getElementById("dayModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalDateEl = document.getElementById("modalDate");
    const modalEventsEl = document.getElementById("modalEvents");
    const modalTasksEl = document.getElementById("modalTasks");

    // Event editor
    const eventEditor = document.getElementById("eventEditor");
    const evtTitleEl = document.getElementById("eventEditorTitle");
    const closeEventEditor = document.getElementById("closeEventEditor");
    const evTitle = document.getElementById("evTitle");
    const evDate = document.getElementById("evDate");
    const evStart = document.getElementById("evStart");
    const evEnd = document.getElementById("evEnd");
    const evLoc = document.getElementById("evLoc");
    const evColor = document.getElementById("evColor");
    const evPublic = document.getElementById("evPublic");
    const saveEventBtn = document.getElementById("saveEventBtn");

    // Schedule editor
    const scheduleEditor = document.getElementById("scheduleEditor");
    const closeScheduleEditor = document.getElementById("closeScheduleEditor");
    const scTitle = document.getElementById("scTitle");
    const scFrom = document.getElementById("scFrom");
    const scTo = document.getElementById("scTo");
    const scStart = document.getElementById("scStart");
    const scEnd = document.getElementById("scEnd");
    const scLoc = document.getElementById("scLoc");
    const scColor = document.getElementById("scColor");
    const scPublic = document.getElementById("scPublic");
    const scReplace = document.getElementById("scReplace");
    const saveScheduleBtn = document.getElementById("saveScheduleBtn");

    // Toasts (Slide-in + Sound hooks) with fade-out and reliable auto-dismiss
    const toastStack = document.getElementById('toastStack');
    function showToast(type, message, timeout = 10000) {
      if (!toastStack) return;
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.setAttribute('role', 'status');
      el.innerHTML = `
        <span aria-hidden="true">
          ${type === 'success' ? '✔' : type === 'info' ? 'ℹ️' : type === 'warn' ? '⚠️' : '✖'}
        </span>
        <div class="text-sm">${message}</div>
        <button class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Dismiss">✖</button>
      `;
      toastStack.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));

      try {
        if (window.Sound) {
          if (type === 'success' && Sound.success) Sound.success();
          else if (type === 'info' && Sound.info) Sound.info();
          else if (type === 'warn' && Sound.warn) Sound.warn();
          else if (type === 'error' && Sound.error) Sound.error();
        }
      } catch {}

      const removeAfterTransition = () => {
        const onEnd = (e) => {
          if (e.target === el) {
            el.removeEventListener('transitionend', onEnd);
            el.remove();
          }
        };
        el.addEventListener('transitionend', onEnd);
        el.classList.remove('show'); // triggers fade-out via CSS transition
      };

      el.querySelector('button')?.addEventListener('click', removeAfterTransition);

      let start = Date.now();
      let remaining = timeout;
      let timer = setTimeout(removeAfterTransition, remaining);
      const pause = () => { clearTimeout(timer); remaining -= (Date.now() - start); };
      const resume = () => { start = Date.now(); clearTimeout(timer); timer = setTimeout(removeAfterTransition, Math.max(0, remaining)); };

      el.addEventListener('mouseenter', pause);
      el.addEventListener('mouseleave', resume);

      window.showToast = showToast;
    }

    // Google Sign-In state (read-only from index.html)
    const G_CRED_KEY = "g_credential_v1";
    const allowedDomains = ["wths.net"]; // from index.html
    const allowedEmails = ["blackshocktrooper@gmail.com"]; // from index.html

    // Event editors (coach/admins) - only these can add/edit/delete events
    const allowedEventEditors = ["blackshocktrooper@gmail.com", "sveselack@wths.net", "palm4215@wths.net"];

    function decodeJwtPayload(raw) {
      try {
        const parts = String(raw).split(".");
        if (parts.length < 2) return null;
        const base64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = atob(base64);
        try {
          const decoded = decodeURIComponent(Array.prototype.map.call(json, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
          return JSON.parse(decoded);
        } catch {
          return JSON.parse(json);
        }
      } catch {
        return null;
      }
    }

    function getGoogleProfile() {
      const raw = localStorage.getItem(G_CRED_KEY);
      if (!raw) return null;
      return decodeJwtPayload(raw);
    }

    function isTaskAccessAllowed() {
      const prof = getGoogleProfile();
      if (!prof || !prof.email) return false;
      const email = String(prof.email).toLowerCase();
      const domainAllowed = allowedDomains.some(d => email.endsWith("@" + d));
      const emailAllowed = allowedEmails.map(e => e.toLowerCase()).includes(email);
      return domainAllowed || emailAllowed;
    }

    function isEventEditor() {
      const prof = getGoogleProfile();
      if (!prof || !prof.email) return false;
      const email = String(prof.email).toLowerCase();
      return allowedEventEditors.map(e => e.toLowerCase()).includes(email);
    }

    function setBadgesAndAdminUI() {
      const tasksAllowed = isTaskAccessAllowed();
      if (tasksAllowed) {
        badge.textContent = "Tasks visible • Signed in";
        badge.classList.remove("border-slate-300", "text-slate-600");
        badge.classList.add("border-emerald-300", "text-emerald-700");
      } else {
        badge.textContent = "Tasks hidden • Sign in on the home page";
        badge.classList.remove("border-emerald-300", "text-emerald-700");
        badge.classList.add("border-slate-300", "text-slate-600");
      }

      if (isEventEditor()) {
        adminControls.classList.remove("hidden");
        adminControls.classList.add("flex");
      } else {
        adminControls.classList.add("hidden");
        adminControls.classList.remove("flex");
      }
    }

    // Date state
    let current = new Date();
    current.setDate(1); // focus on first of month

    // Data caches
    let events = [];  // {id,title,date,time,startTime,endTime,location,isPublic,color,createdBy,createdAt}
    let tasks = [];   // only if task access allowed

    function pad(n) { return String(n).padStart(2, "0"); }
    function fmtDateKey(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function monthMatrix(year, month) {
      // Build 42 day objects for a 6-row calendar
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevDays = new Date(year, month, 0).getDate();

      const cells = [];
      for (let i = 0; i < startDay; i++) {
        const day = prevDays - startDay + 1 + i;
        cells.push({ date: new Date(year, month - 1, day), inMonth: false });
      }
      for (let d = 1; d <= daysInMonth; d++) {
        cells.push({ date: new Date(year, month, d), inMonth: true });
      }
      while (cells.length < 42) {
        const last = cells[cells.length - 1].date;
        cells.push({ date: new Date(last.getFullYear(), last.getMonth(), last.getDate() + 1), inMonth: false });
      }
      return cells;
    }

    function groupByDate(items, getKey) {
      const map = new Map();
      for (const it of items) {
        const k = getKey(it);
        if (!k) continue;
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }

    function formatTimeRange(e) {
      const s = (e.startTime || "").trim();
      const en = (e.endTime || "").trim();
      if (!s && !en) return "";
      const to12 = (t) => {
        if (!t) return "";
        const [hh, mm] = t.split(":").map(x => parseInt(x, 10));
        const ampm = hh >= 12 ? "p" : "a";
        const h = ((hh + 11) % 12) + 1;
        return `${h}${mm ? ":" + String(mm).padStart(2, "0") : ""}${ampm}`;
      };
      if (s && en) return `${to12(s)}-${to12(en)}`;
      return to12(s || en);
    }

    // ========== U.S. Federal Holidays ==========
    // Helper: Get the nth occurrence of a weekday in a month
    // weekday: 0=Sun, 1=Mon, ..., 6=Sat
    // n: 1=first, 2=second, 3=third, 4=fourth
    function getNthWeekdayOfMonth(year, month, weekday, n) {
      const firstDay = new Date(year, month, 1);
      const firstWeekday = firstDay.getDay();
      // Calculate days until the first occurrence of target weekday
      let daysUntilTarget = (weekday - firstWeekday + 7) % 7;
      // Calculate the date of the nth occurrence
      const targetDate = 1 + daysUntilTarget + (n - 1) * 7;
      return new Date(year, month, targetDate);
    }

    // Helper: Get the last occurrence of a weekday in a month
    function getLastWeekdayOfMonth(year, month, weekday) {
      const lastDay = new Date(year, month + 1, 0);
      const lastDate = lastDay.getDate();
      const lastWeekday = lastDay.getDay();
      // Calculate days back to the last occurrence of target weekday
      let daysBack = (lastWeekday - weekday + 7) % 7;
      const targetDate = lastDate - daysBack;
      return new Date(year, month, targetDate);
    }

    // Helper: Apply observed date rules (if Sat→Fri, if Sun→Mon)
    function getObservedDate(year, month, day) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();
      if (dayOfWeek === 6) { // Saturday
        date.setDate(date.getDate() - 1); // Observed on Friday
      } else if (dayOfWeek === 0) { // Sunday
        date.setDate(date.getDate() + 1); // Observed on Monday
      }
      return date;
    }

    // Generate U.S. federal holidays for a given year
    function generateUSHolidays(year) {
      const holidays = [];
      let id = 0;

      // New Year's Day (Jan 1, observed)
      const newYear = getObservedDate(year, 0, 1);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "New Year's Day",
        date: fmtDateKey(newYear),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Martin Luther King Jr. Day (3rd Monday in January)
      const mlkDay = getNthWeekdayOfMonth(year, 0, 1, 3);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Martin Luther King Jr. Day",
        date: fmtDateKey(mlkDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Presidents Day (3rd Monday in February)
      const presidentsDay = getNthWeekdayOfMonth(year, 1, 1, 3);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Presidents Day",
        date: fmtDateKey(presidentsDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Memorial Day (last Monday in May)
      const memorialDay = getLastWeekdayOfMonth(year, 4, 1);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Memorial Day",
        date: fmtDateKey(memorialDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Juneteenth (June 19, observed)
      const juneteenth = getObservedDate(year, 5, 19);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Juneteenth National Independence Day",
        date: fmtDateKey(juneteenth),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Independence Day (July 4, observed)
      const independenceDay = getObservedDate(year, 6, 4);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Independence Day",
        date: fmtDateKey(independenceDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Labor Day (1st Monday in September)
      const laborDay = getNthWeekdayOfMonth(year, 8, 1, 1);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Labor Day",
        date: fmtDateKey(laborDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Columbus Day / Indigenous Peoples' Day (2nd Monday in October)
      const columbusDay = getNthWeekdayOfMonth(year, 9, 1, 2);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Columbus / Indigenous Peoples' Day",
        date: fmtDateKey(columbusDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Veterans Day (Nov 11, observed)
      const veteransDay = getObservedDate(year, 10, 11);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Veterans Day",
        date: fmtDateKey(veteransDay),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Thanksgiving (4th Thursday in November)
      const thanksgiving = getNthWeekdayOfMonth(year, 10, 4, 4);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Thanksgiving Day",
        date: fmtDateKey(thanksgiving),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      // Christmas Day (Dec 25, observed)
      const christmas = getObservedDate(year, 11, 25);
      holidays.push({
        id: `holiday-${year}-${id++}`,
        title: "Christmas Day",
        date: fmtDateKey(christmas),
        startTime: "",
        endTime: "",
        location: "",
        isPublic: true,
        color: "amber",
        createdBy: "system",
        createdAt: 0,
        isHoliday: true
      });

      return holidays;
    }

    async function loadEvents() {
      try {
        const snap = await getDocs(collection(db, "events"));
        const arr = [];
        snap.forEach(docSnap => {
          const e = docSnap.data() || {};
          const date = typeof e.date === "string" ? e.date : "";
          if (!date) return;
          arr.push({
            id: docSnap.id,
            title: e.title || "(Untitled)",
            date,
            time: e.time || "",           // legacy "time" field
            startTime: e.startTime || "", // new fields preferred
            endTime: e.endTime || "",
            location: e.location || "",
            isPublic: e.isPublic !== false,
            color: sanitizeEventColor(e.color || DEFAULT_EVENT_COLOR),
            createdBy: e.createdBy || "",
            createdAt: e.createdAt || 0,
            comments: Array.isArray(e.comments) ? e.comments : []
          });
        });
        events = arr;
      } catch (err) {
        console.warn("Failed to load events:", err);
        events = [];
      }
    }

    async function loadTasksIfAllowed() {
      if (!isTaskAccessAllowed()) { tasks = []; return; }
      try {
        const snap = await getDocs(collection(db, "tasks"));
        const arr = [];
        snap.forEach(docSnap => {
          const t = docSnap.data() || {};
          if (t.deleted || t.archived) return;
          arr.push({
            id: docSnap.id,
            title: t.title || "(Untitled)",
            assignee: t.assignee || "Unassigned",
            due: typeof t.due === "string" ? t.due : "",
            comments: Array.isArray(t.comments) ? t.comments : []
          });
        });
        tasks = arr;
      } catch (err) {
        console.warn("Failed to load tasks:", err);
        tasks = [];
      }
    }

    function renderMonthLabel(year, month) {
      const dtf = new Intl.DateTimeFormat([], { month: "long", year: "numeric" });
      monthLabel.textContent = dtf.format(new Date(year, month, 1));
      monthPicker.value = `${year}-${pad(month+1)}`;
    }

    function isToday(d) {
      const now = new Date();
      return d.getFullYear() === now.getFullYear() &&
             d.getMonth() === now.getMonth() &&
             d.getDate() === now.getDate();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function openModal(dateObj, dayEvents, dayTasks) {
      modalDateEl.textContent = dateObj.toLocaleDateString([], { weekday: "long", year: "numeric", month: "long", day: "numeric" });

      const canEdit = isEventEditor();

      const userProfile = getGoogleProfile();
      const isSignedIn = !!userProfile;

      modalEventsEl.innerHTML = (dayEvents.length
        ? dayEvents.map((e, eventIdx) => {
            const tr = formatTimeRange(e) || e.time || "";
            const timeStr = tr ? ` • ${escapeHtml(tr)}` : "";
            const locStr = e.location ? ` • ${escapeHtml(e.location)}` : "";
            // Don't show edit/delete buttons for holidays
            const adminBtns = (canEdit && !e.isHoliday) ? `
              <div class="flex items-center gap-1 shrink-0">
                <button class="edit-ev px-2 py-0.5 text-xs border border-slate-300 rounded hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800" data-id="${e.id}">Edit</button>
                <button class="del-ev px-2 py-0.5 text-xs border border-red-200 text-red-600 rounded hover:bg-red-50 dark:border-red-900 dark:text-red-400 dark:hover:bg-red-950" data-id="${e.id}">Delete</button>
              </div>
            ` : "";
            const styleAttr = styleAttrForEventColor(e.color || DEFAULT_EVENT_COLOR);
            
            // Don't show comments section for holidays
            const commentsSection = e.isHoliday ? "" : `
              <div class="mt-2">
                <button class="text-xs text-sky-600 dark:text-sky-400 underline toggle-event-comments" data-event-id="${e.id}">Show Comments</button>
                <div class="event-comments-section hidden mt-2 border-t border-slate-200 dark:border-slate-800 pt-2" data-event-id="${e.id}">
                  <div class="event-comments-list space-y-2 text-sm">
                    ${(e.comments || []).map((c, idx) => {
                      const dateStr = c.timestamp
                        ? new Date(c.timestamp).toLocaleString([], { month: "short", day: "numeric", year: "numeric", hour: "2-digit", minute: "2-digit" })
                        : "";
                      const authorDisplay = c.author || "Anonymous";
                      return `
                        <div class="text-xs text-slate-600 dark:text-slate-400 border-l-2 border-sky-300 dark:border-sky-700 pl-2">
                          <div>${escapeHtml(c.text || "")}</div>
                          <div class="text-slate-400 mt-0.5">${escapeHtml(authorDisplay)} • ${dateStr}</div>
                        </div>
                      `;
                    }).join("")}
                    ${(e.comments || []).length === 0 ? '<div class="text-xs text-slate-400">No comments yet</div>' : ''}
                  </div>
                  <div class="mt-2">
                    ${isSignedIn ? `
                      <div class="flex gap-2">
                        <input type="text" placeholder="Add a comment..." 
                          class="event-comment-input flex-1 border border-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-sky-200"
                          data-event-id="${e.id}" />
                        <button class="add-event-comment px-2 py-1 bg-sky-600 text-white rounded-md text-xs hover:bg-sky-700" data-event-id="${e.id}">Add</button>
                      </div>
                    ` : `
                      <div class="text-xs text-slate-500 dark:text-slate-400 italic">Sign in on the home page to add a comment</div>
                    `}
                  </div>
                </div>
              </div>
            `;
            
            return `
              <div class="event-card border border-slate-200 dark:border-slate-800 rounded bg-slate-50 dark:bg-slate-900 p-2" data-event-id="${e.id}">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1">
                    <div class="event-pill" ${styleAttr}>${escapeHtml(e.title)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(e.date)}${timeStr}${locStr}</div>
                  </div>
                  ${adminBtns}
                </div>
                ${commentsSection}
              </div>
            `;
          }).join("")
        : '<div class="text-slate-400 text-sm">No events</div>'
      );

      modalTasksEl.innerHTML = (dayTasks.length
        ? dayTasks.map(t => {
            const who = t.assignee ? ` • ${escapeHtml(t.assignee)}` : "";
            // Get up to 3 comments with showOnCalendar=true
            const calendarComments = (t.comments || [])
              .filter(c => c.showOnCalendar === true)
              .slice(0, 3);
            const commentsHtml = calendarComments.length > 0
              ? `<div class="mt-2 space-y-1">
                  ${calendarComments.map(c => 
                    `<div class="text-xs italic text-slate-500 dark:text-slate-400 pl-2 border-l-2 border-slate-300 dark:border-slate-700">
                      ${escapeHtml(c.text || "")}
                    </div>`
                  ).join("")}
                </div>`
              : "";
            return `
              <div class="p-2 border border-slate-200 dark:border-slate-800 rounded bg-slate-50 dark:bg-slate-900">
                <div class="task-pill">${escapeHtml(t.title)}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(t.due)}${who}</div>
                ${commentsHtml}
              </div>
            `;
          }).join("")
        : '<div class="text-slate-400 text-sm">No tasks due</div>'
      );

      // Wire admin edit/delete
      if (canEdit) {
        modalEventsEl.querySelectorAll(".edit-ev").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-id");
            const ev = events.find(x => x.id === id);
            if (ev) openEventEditor(ev);
          });
        });
        modalEventsEl.querySelectorAll(".del-ev").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-id");
            if (!confirm("Delete this event?")) return;
            try {
              await deleteDoc(doc(db, "events", id));
              showToast('success', 'Event deleted.');
              await render(); // reload
              closeModal();
            } catch (err) {
              const msg = "Delete failed: " + (err?.message || err);
              console.error(msg);
              showToast('error', msg);
            }
          });
        });
      }

      // Wire event comment toggles
      modalEventsEl.querySelectorAll(".toggle-event-comments").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const eventId = btn.getAttribute("data-event-id");
          const section = modalEventsEl.querySelector(`.event-comments-section[data-event-id="${eventId}"]`);
          if (section) {
            const isHidden = section.classList.toggle("hidden");
            btn.textContent = isHidden ? "Show Comments" : "Hide Comments";
          }
        });
      });

      // Wire add comment buttons
      modalEventsEl.querySelectorAll(".add-event-comment").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const eventId = btn.getAttribute("data-event-id");
          const input = modalEventsEl.querySelector(`.event-comment-input[data-event-id="${eventId}"]`);
          if (!input) return;

          const text = (input.value || "").trim();
          if (!text) {
            showToast('warn', 'Please enter a comment.');
            return;
          }

          btn.disabled = true;
          const originalText = btn.textContent;
          btn.textContent = "Adding...";

          try {
            const prof = getGoogleProfile();
            const author = prof?.name || prof?.email || "Anonymous";
            const newComment = { timestamp: Date.now(), author, text };

            // Find the event in dayEvents (passed to openModal)
            const event = dayEvents.find(ev => ev.id === eventId);
            if (!event) {
              showToast('error', 'Event not found.');
              return;
            }

            const updatedComments = [...(event.comments || []), newComment];

            // Merge-update the event document
            await setDoc(doc(db, "events", eventId), { comments: updatedComments }, { merge: true });

            showToast('success', 'Comment added.');
            input.value = "";

            // Re-open modal with updated data
            await render();
            const updatedEvent = events.find(ev => ev.id === eventId);
            if (updatedEvent) {
              const updatedDayEvents = dayEvents.map(ev => ev.id === eventId ? updatedEvent : ev);
              openModal(dateObj, updatedDayEvents, dayTasks);
            }
          } catch (err) {
            const msg = "Failed to add comment: " + (err?.message || err);
            console.error(msg);
            showToast('error', msg);
          } finally {
            btn.disabled = false;
            btn.textContent = originalText;
          }
        });
      });

      modal.classList.add("open");
    }

    function closeModal() { modal.classList.remove("open"); }
    closeModalBtn.onclick = closeModal;
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    function renderGrid(year, month) {
      renderMonthLabel(year, month);
      grid.innerHTML = "";

      const cells = monthMatrix(year, month);

      // Merge U.S. federal holidays for the current year into events
      const holidays = generateUSHolidays(year);
      const allEvents = [...events.filter(e => e.isPublic === true), ...holidays];

      const eventsByDate = groupByDate(allEvents, e => e.date);
      const canSeeTasks = isTaskAccessAllowed();
      const tasksByDate = canSeeTasks ? groupByDate(tasks, t => t.due) : new Map();

      // Responsive cap for inline pills (cells remain square; page can scroll)
      const MAX_VISIBLE = window.innerWidth < 640 ? 2 : 3;

      for (const { date, inMonth } of cells) {
        const key = fmtDateKey(date);
        const dayEvents = (eventsByDate.get(key) || []);
        const dayTasks = canSeeTasks ? (tasksByDate.get(key) || []) : [];
        const total = dayEvents.length + dayTasks.length;

        const cell = document.createElement("div");
        cell.className = "day-cell text-left";
        cell.setAttribute("data-date", key);
        if (!inMonth) cell.classList.add("day-muted");

        const head = document.createElement("div");
        head.className = "flex items-center justify-start gap-1 flex-wrap shrink-0 sm:justify-between sm:flex-nowrap sm:gap-2";
        const num = document.createElement("div");
        num.className = "text-sm font-semibold text-slate-700 dark:text-slate-200";
        num.textContent = date.getDate();
        head.appendChild(num);
        if (isToday(date)) {
          const dot = document.createElement("span");
          dot.className = "today-dot";
          head.appendChild(dot);
        }
        // Presence dots
        if (dayEvents.length > 0) {
          const dotE = document.createElement("span");
          dotE.className = "presence-dot presence-event";
          head.appendChild(dotE);
        }
        if (dayTasks.length > 0) {
          const dotT = document.createElement("span");
          dotT.className = "presence-dot presence-task";
          head.appendChild(dotT);
        }
        cell.appendChild(head);

        const items = document.createElement("div");
        items.className = "flex flex-col gap-1 min-h-0 overflow-hidden";

        const addPill = (txt, cls, title, opts = {}) => {
          const span = document.createElement("span");
          span.className = cls;
          span.title = title || txt;
          span.textContent = txt;
          if (cls.includes("event-pill")) {
            applyEventColorVars(span, opts.evColor || DEFAULT_EVENT_COLOR);
          }
          items.appendChild(span);
        };

        // Ensure a task pill shows when both events and tasks exist
        let shown = 0;
        let shownEvents = 0;
        let shownTasks = 0;

        if (dayEvents.length && dayTasks.length) {
          // First show one event
          const e0 = dayEvents[0];
          const tr0 = formatTimeRange(e0) || e0.time || "";
          const label0 = tr0 ? `${tr0} ${e0.title}` : e0.title;
          addPill(label0, "event-pill", `${e0.title}${tr0 ? " • " + tr0 : ""}${e0.location ? " • " + e0.location : ""}`, { evColor: e0.color || DEFAULT_EVENT_COLOR });
          shown++; shownEvents++;

          // Then show one task if room
          if (shown < MAX_VISIBLE) {
            const t0 = dayTasks[0];
            addPill(t0.title, "task-pill", `${t0.title} • ${t0.assignee || ""}`);
            shown++; shownTasks++;
          }
        }

        // Fill remaining visible slots
        for (let i = shownEvents; i < dayEvents.length && shown < MAX_VISIBLE; i++) {
          const e = dayEvents[i];
          const tr = formatTimeRange(e) || e.time || "";
          const label = tr ? `${tr} ${e.title}` : e.title;
          addPill(label, "event-pill", `${e.title}${tr ? " • " + tr : ""}${e.location ? " • " + e.location : ""}`, { evColor: e.color || DEFAULT_EVENT_COLOR });
          shown++;
        }
        for (let j = shownTasks; j < dayTasks.length && shown < MAX_VISIBLE; j++) {
          const t = dayTasks[j];
          addPill(t.title, "task-pill", `${t.title} • ${t.assignee || ""}`);
          shown++;
        }

        if (total > shown) {
          const more = document.createElement("span");
          more.className = "more-pill";
          more.textContent = `+${total - shown} more`;
          items.appendChild(more);
        }

        cell.appendChild(items);

        cell.addEventListener("click", () => openModal(date, dayEvents, dayTasks));
        grid.appendChild(cell);
      }
    }

    // Keep day cells square based on column width, but let the page scroll
    function setSquareRows() {
      const cs = getComputedStyle(grid);
      const colGap = parseFloat(cs.columnGap) || 0;
      const gridWidth = grid.clientWidth || grid.offsetWidth;

      const colWidth = (gridWidth - colGap * 6) / 7; // 7 columns, 6 gaps
      const rowPx = Math.floor(colWidth);
      grid.style.gridAutoRows = `${rowPx}px`;
    }

    async function render() {
      setBadgesAndAdminUI();
      await Promise.all([loadEvents(), loadTasksIfAllowed()]);
      renderGrid(current.getFullYear(), current.getMonth());
      setSquareRows();
    }

    prevBtn.onclick = () => {
      current.setMonth(current.getMonth() - 1);
      renderGrid(current.getFullYear(), current.getMonth());
      setSquareRows();
    };
    nextBtn.onclick = () => {
      current.setMonth(current.getMonth() + 1);
      renderGrid(current.getFullYear(), current.getMonth());
      setSquareRows();
    };
    todayBtn.onclick = () => {
      const now = new Date();
      current = new Date(now.getFullYear(), now.getMonth(), 1);
      renderGrid(current.getFullYear(), current.getMonth());
      setSquareRows();
    };
    monthPicker.addEventListener("change", () => {
      const val = monthPicker.value; // yyyy-mm
      if (!val) return;
      const [y, m] = val.split("-").map(x => parseInt(x, 10));
      current = new Date(y, m - 1, 1);
      renderGrid(current.getFullYear(), current.getMonth());
      setSquareRows();
    });

    window.addEventListener("resize", setSquareRows);

    // ICS export for visible month
    function exportVisibleMonthICS() {
      const y = current.getFullYear();
      const m = current.getMonth();
      const start = new Date(y, m, 1);
      const end = new Date(y, m + 1, 0);

      const startKey = fmtDateKey(start);
      const endKey = fmtDateKey(end);
      const inRange = events.filter(e => e.isPublic !== false && e.date >= startKey && e.date <= endKey);

      const lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Trident Robotics//Calendar//EN",
      ];

      const toICSDate = (dateStr, timeStr) => {
        if (!timeStr) return dateStr.replace(/-/g, "") + "T000000";
        const [hh, mm] = timeStr.split(":");
        return dateStr.replace(/-/g, "") + "T" + String(hh).padStart(2, "0") + String(mm).padStart(2, "0") + "00";
      };

      for (const e of inRange) {
        const title = e.title || "Event";
        const startTime = e.startTime || e.time || "";
        const endTime = e.endTime || "";
        const dtStart = toICSDate(e.date, startTime);
        let dtEnd = "";
        if (endTime) {
          dtEnd = toICSDate(e.date, endTime);
        } else if (startTime) {
          const [hh, mm] = startTime.split(":").map(x => parseInt(x, 10));
          const d = new Date(e.date + "T" + String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0") + ":00");
          d.setHours(d.getHours() + 1);
          dtEnd = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}T${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}00`;
        } else {
          dtEnd = e.date.replace(/-/g, "") + "T235900";
        }

        lines.push("BEGIN:VEVENT");
        lines.push("SUMMARY:" + title.replace(/\n/g, "\\n"));
        lines.push("DTSTART:" + dtStart);
        lines.push("DTEND:" + dtEnd);
        if (e.location) lines.push("LOCATION:" + e.location.replace(/[\n,]/g, " ").trim());
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");

      const blob = new Blob([lines.join("\r\n")], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const monthName = new Intl.DateTimeFormat([], { month: "long" }).format(new Date(y, m, 1));
      a.href = url;
      a.download = `Trident-${monthName}-${y}.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    exportIcsBtn.addEventListener("click", exportVisibleMonthICS);

    // Admin-only: Add/Edit single event
    function openEventEditor(ev = null) {
      if (!isEventEditor()) return alert("You are not authorized to manage events.");

      evtTitleEl.textContent = ev ? "Edit Event" : "Add Event";
      evTitle.value = ev?.title || "";
      const today = new Date();
      evDate.value = ev?.date || `${current.getFullYear()}-${pad(current.getMonth()+1)}-${pad(today.getDate())}`;
      evStart.value = ev?.startTime || (ev?.time || "");
      evEnd.value = ev?.endTime || "";
      evLoc.value = ev?.location || "";
      evColor.value = sanitizeEventColor(ev?.color || DEFAULT_EVENT_COLOR);
      evPublic.checked = ev?.isPublic !== false;

      eventEditor.classList.add("open");

      saveEventBtn.onclick = async () => {
        const title = evTitle.value.trim();
        const date = evDate.value;
        const startTime = evStart.value || "";
        const endTime = evEnd.value || "";
        const location = evLoc.value.trim();
        const color = sanitizeEventColor(evColor.value);
        const isPublic = !!evPublic.checked;

        if (!title || !date) { showToast('warn', 'Title and date are required.'); return; }

        const prof = getGoogleProfile();
        try {
          if (ev && ev.id) {
            await setDoc(doc(db, "events", ev.id), {
              title, date, startTime, endTime, location, isPublic, color,
              createdBy: ev.createdBy || (prof?.email || ""),
              createdAt: ev.createdAt || Date.now()
            }, { merge: true });
            showToast('success', 'Event saved.');
          } else {
            await addDoc(collection(db, "events"), {
              title, date, startTime, endTime, location, isPublic, color,
              createdBy: (prof?.email || ""),
              createdAt: Date.now()
            });
            showToast('success', 'Event added.');
          }
          eventEditor.classList.remove("open");
          await render();
        } catch (err) {
          const msg = 'Failed to save event: ' + (err?.message || err);
          console.error(msg);
          showToast('error', msg);
        }
      };
    }

    // Openers and closers
    addEventBtn?.addEventListener('click', () => openEventEditor());
    closeEventEditor?.addEventListener('click', () => eventEditor.classList.remove('open'));
    eventEditor.addEventListener('click', (e) => { if (e.target === eventEditor) eventEditor.classList.remove('open'); });

    // Schedule builder
    function openScheduleEditor() {
      if (!isEventEditor()) return alert("You are not authorized to manage events.");

      const now = new Date();
      const y = current.getFullYear();
      const m = current.getMonth();
      scTitle.value = "";
      scFrom.value = `${y}-${pad(m+1)}-01`;
      scTo.value = `${y}-${pad(m+1)}-${pad(new Date(y, m+1, 0).getDate())}`;
      scStart.value = "";
      scEnd.value = "";
      scLoc.value = "";
      scColor.value = DEFAULT_EVENT_COLOR;
      scPublic.checked = true;
      scReplace.checked = false;
      document.querySelectorAll('#scheduleEditor .sc-wd').forEach(cb => cb.checked = false);

      scheduleEditor.classList.add('open');

      saveScheduleBtn.onclick = async () => {
        const title = scTitle.value.trim();
        const from = scFrom.value;
        const to = scTo.value;
        const startTime = scStart.value || "";
        const endTime = scEnd.value || "";
        const location = scLoc.value.trim();
        const color = sanitizeEventColor(scColor.value);
        const isPublic = !!scPublic.checked;
        const replace = !!scReplace.checked;
        const selectedDays = Array.from(document.querySelectorAll('#scheduleEditor .sc-wd:checked')).map(cb => parseInt(cb.value, 10));

        if (!title || !from || !to || selectedDays.length === 0) {
          showToast('warn', 'Title, date range, and at least one weekday are required.');
          return;
        }

        try {
          // Optionally remove existing events in range with same title
          if (replace) {
            const snap = await getDocs(collection(db, "events"));
            const toDelete = [];
            snap.forEach(d => {
              const e = d.data() || {};
              if (!e.date || typeof e.date !== 'string') return;
              if (e.title === title && e.date >= from && e.date <= to) toDelete.push(d.id);
            });
            for (const id of toDelete) await deleteDoc(doc(db, "events", id));
          }

          // Create events for each matching day
          const start = new Date(from + "T00:00:00");
          const end = new Date(to + "T00:00:00");
          let count = 0;
          const prof = getGoogleProfile();

          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            if (!selectedDays.includes(d.getDay())) continue;
            const dateStr = fmtDateKey(d);
            await addDoc(collection(db, "events"), {
              title,
              date: dateStr,
              startTime,
              endTime,
              location,
              isPublic,
              color,
              createdBy: (prof?.email || ""),
              createdAt: Date.now()
            });
            count++;
          }

          showToast('success', `Schedule created (${count} event${count === 1 ? '' : 's'}).`);
          scheduleEditor.classList.remove('open');
          await render();
        } catch (err) {
          const msg = 'Failed to save schedule: ' + (err?.message || err);
          console.error(msg);
          showToast('error', msg);
        }
      };
    }

    addScheduleBtn?.addEventListener('click', () => openScheduleEditor());
    closeScheduleEditor?.addEventListener('click', () => scheduleEditor.classList.remove('open'));
    scheduleEditor.addEventListener('click', (e) => { if (e.target === scheduleEditor) scheduleEditor.classList.remove('open'); });

    // Initial render
    await render();
  </script>
  <script src="/assets/js/theme.js"></script>
  <script src="/assets/js/sound.js" defer></script>
</body>
</html>
