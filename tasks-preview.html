<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atlas Studio — Task Board</title>
  <link rel="preconnect" href="https://rsms.me" />
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ease-spring: cubic-bezier(.22,.9,.33,1);
      --ease-soft-out: cubic-bezier(.18,.72,.42,1);
      --ease-soft-in: cubic-bezier(.6,.04,.98,.34);
      --dur-xfast: 90ms;
      --dur-fast: 150ms;
      --dur-medium: 280ms;
      --dur-slow: 560ms;

      --surface: #ffffff;
      --ink-1: #0f172a;
      --ink-2: #334155;
      --ink-3: #64748b;

      --accent: #0ea5e9; /* sky-500 */
      --accent-2: #38bdf8; /* sky-400 */
      --accent-3: #0369a1; /* sky-700 */

      --card-radius: 16px;
      --col-radius: 18px;

      --glass-alpha: .55;
      --border-strong: rgba(0,0,0,.06);
    }

    html,body { height: 100%; }
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background:
        radial-gradient(1200px 600px at 0% -10%, rgba(14,165,233,.16), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(56,189,248,.14), transparent 60%),
        linear-gradient(to bottom, #f0f9ff, #ffffff 50%, #f8fafc);
      color: var(--ink-1);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --surface: #0b1220;
        --ink-1: #e5e7eb;
        --ink-2: #cbd5e1;
        --ink-3: #94a3b8;
        --border-strong: rgba(255,255,255,.08);
      }
      body {
        background:
          radial-gradient(1200px 600px at -10% -10%, rgba(14,165,233,.16), transparent 60%),
          radial-gradient(1000px 700px at 110% -10%, rgba(56,189,248,.12), transparent 60%),
          linear-gradient(to bottom, #0b1220, #0a0f1a 50%, #0b1220);
      }
    }

    /* Glass column */
    .column-section {
      position: relative;
      padding: 14px;
      border-radius: var(--col-radius);
      background: rgba(255,255,255,var(--glass-alpha));
      border: 1px solid var(--border-strong);
      backdrop-filter: saturate(160%) blur(18px);
      -webkit-backdrop-filter: saturate(160%) blur(18px);
      box-shadow:
        0 8px 34px rgba(2,6,23,.08),
        0 1px 0 rgba(255,255,255,.08) inset;
      transition: box-shadow var(--dur-medium) var(--ease-soft-out),
                  border-color var(--dur-fast) linear,
                  background-color var(--dur-fast) linear;
      overflow: hidden;
      isolation: isolate;
    }
    @media (prefers-color-scheme: dark) {
      .column-section { background: rgba(15,23,42,var(--glass-alpha)); }
    }
    /* Gradient border ring via ::before */
    .column-section::before{
      content:"";
      position:absolute; inset:0; border-radius: inherit; padding:1px;
      background: linear-gradient(135deg, rgba(14,165,233,.6), rgba(56,189,248,.3), rgba(3,105,161,.4));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.18; pointer-events:none;
    }
    /* Noise overlay */
    .column-section::after{
      content:"";
      position:absolute; inset:-40%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/></svg>');
      mix-blend-mode: soft-light; pointer-events:none;
    }
    .column-section.drag-target {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgb(14 165 233 / .18), 0 16px 52px rgb(2 132 199 / .20);
    }

    .column-header {
      display:flex; align-items:center; justify-content:space-between;
      gap:.75rem; margin-bottom:.85rem;
      padding:.5rem .75rem;
      border-radius: 14px;
      border: 1px solid var(--border-strong);
      background: linear-gradient(180deg, rgba(241,245,249,.85), rgba(241,245,249,.6));
    }
    @media (prefers-color-scheme: dark){
      .column-header { background: linear-gradient(180deg, rgba(15,23,42,.72), rgba(15,23,42,.55)); }
    }
    .column-title { font-weight: 800; letter-spacing: -0.01em; }
    .column-count {
      font-size:.75rem; line-height:1.25rem; padding:0 .5rem; border-radius:999px;
      border:1px solid #bae6fd; background:#e0f2fe; color:#0369a1;
    }
    @media (prefers-color-scheme: dark) {
      .column-count { background:#083344; color:#7dd3fc; border-color:#075985; }
    }

    .task-list { min-height: 144px; display:grid; gap: .9rem; }

    /* Card */
    .task-card {
      position: relative;
      border-radius: var(--card-radius);
      border: 1px solid #e2e8f0;
      background:
        linear-gradient(0deg, rgba(255,255,255,.6), rgba(255,255,255,.6)),
        linear-gradient(180deg, #ffffff, #fbfdff);
      padding: 12px;
      box-shadow: 0 1px 1px rgba(2,6,23,.04);
      transition:
        transform var(--dur-medium) var(--ease-spring),
        box-shadow var(--dur-medium) var(--ease-soft-out),
        border-color var(--dur-fast) linear,
        opacity var(--dur-fast) linear,
        background-color var(--dur-fast) linear;
      will-change: transform, box-shadow;
      transform-origin: 50% 50%;
      cursor: default;
      overflow: clip;
      isolation: isolate;
    }
    @media (prefers-color-scheme: dark){
      .task-card {
        border-color:#1f2937;
        background:
          linear-gradient(0deg, rgba(11,18,32,.5), rgba(11,18,32,.5)),
          linear-gradient(180deg, #0b1220, #0d1424);
        box-shadow: 0 1px 1px rgba(2,6,23,.6);
      }
    }

    /* Accent cap */
    .task-card::before{
      content:"";
      position:absolute; left:0; right:0; top:0; height:3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2) 60%, var(--accent-3));
      opacity:.65;
    }

    /* Inner wrap for tilt so drag transform doesn't conflict */
    .tilt-wrap { transition: transform var(--dur-fast) var(--ease-soft-out); transform-style: preserve-3d; }

    .task-card:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 16px 44px -12px rgba(2,132,199,.28), 0 8px 24px rgba(2,6,23,.10);
      border-color: #93c5fd;
    }
    .task-meta { color: var(--ink-3); }

    /* Drag handle */
    .drag-handle {
      display:flex; align-items:center; justify-content:center;
      width: 30px; height: 30px;
      border:1px solid rgba(148,163,184,.35);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(248,250,252,.7));
      cursor: grab;
      transition: transform var(--dur-fast) var(--ease-soft-out), border-color var(--dur-fast), background-color var(--dur-fast);
      touch-action: none;
    }
    .drag-handle:hover { transform: scale(1.06); border-color: #93c5fd; }
    .drag-handle:active { cursor: grabbing; }
    @media (prefers-color-scheme: dark) {
      .drag-handle { border-color:#334155; background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.7)); }
      .drag-handle:hover { border-color: var(--accent); }
    }
    .grip { width:15px; height:15px; opacity:.75;
      background:
        radial-gradient(currentColor 2px, transparent 3px) 0 0/7px 7px,
        radial-gradient(currentColor 2px, transparent 3px) 7px 7px/7px 7px;
      color:#64748b;
    }
    @media (prefers-color-scheme: dark){ .grip { color:#94a3b8; } }

    /* Dragging state */
    .task-card.dragging {
      pointer-events: none;
      z-index: 1000;
      transform: scale(1.045) rotateX(3deg) rotateY(2deg);
      opacity: .97;
      border-color: var(--accent);
      box-shadow: 0 24px 64px -16px rgba(2,132,199,.40), 0 12px 28px rgba(0,0,0,.38);
    }
    .task-card.dragging::after{
      content:""; position:absolute; inset:0; border-radius:inherit; padding:2px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.55; animation: ringFlow 3s linear infinite;
      pointer-events:none;
    }
    @keyframes ringFlow { 0%{ filter:hue-rotate(0deg) } 100%{ filter:hue-rotate(360deg) } }

    /* Placeholder with shimmer */
    .task-placeholder{
      height: var(--ph-h, 80px);
      border:2px dashed var(--accent);
      border-radius: var(--card-radius);
      background:
        linear-gradient(100deg, rgba(14,165,233,.12) 8%, rgba(14,165,233,.24) 18%, rgba(14,165,233,.12) 33%),
        rgba(14,165,233,.08);
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }
    @keyframes shimmer { 0%{background-position: 180% 0} 100%{background-position: -20% 0} }

    /* FLIP */
    .task-card.flipping { transition: transform var(--dur-medium) var(--ease-spring); }

    /* Tags */
    .tag-chip {
      display:inline-block; background:#e0f2fe; color:#0369a1;
      padding: 2px 8px; border-radius:999px; border:1px solid #bae6fd;
      font-size:.75rem; line-height:1.25rem;
      transition: transform var(--dur-fast) var(--ease-soft-out), background-color var(--dur-fast);
    }
    .tag-chip:hover { transform: translateY(-1px); background:#dbeafe; }
    @media (prefers-color-scheme: dark){ .tag-chip{ background:#0c4a6e; color:#e0f2fe; border-color:#075985; } .tag-chip:hover{ background:#0b3e59; } }

    /* Comments expand: grid 0fr -> 1fr trick for height animation */
    .collapsible {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows var(--dur-medium) var(--ease-spring), opacity var(--dur-medium) var(--ease-soft-out);
      opacity: 0.0;
    }
    .collapsible.open { grid-template-rows: 1fr; opacity: 1; }
    .collapsible > .content { overflow: hidden; }

    /* Due colors */
    .due-overdue { color:#dc2626 }
    .due-soon { color:#d97706 }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .task-card, .collapsible, .tag-chip { animation:none !important; transition:none !important; }
      .task-placeholder { animation:none !important; }
    }
  </style>
</head>
<body class="p-6">
  <header class="max-w-7xl mx-auto mb-6 px-2">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
      <div class="flex flex-col gap-1">
        <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">Atlas Studio — Task Board</h1>
        <p class="text-sm text-sky-600 dark:text-sky-400">Glassy columns, tilt-hover, handle-only drag, springy FLIP reordering</p>
      </div>
      <div class="text-sm text-slate-600 dark:text-slate-300">Drag from the grip; everything else is clickable</div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto">
    <div id="board" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    <footer class="mt-12 text-center py-4 border-t border-slate-200/70 dark:border-slate-800">
      <span class="text-sky-600 dark:text-sky-400 text-sm">Preview only • No data saved</span>
    </footer>
  </main>

  <script>
    // ---------- Local sample data ----------
    const state = {
      order: ['backlog', 'todo', 'inprogress', 'done'],
      columns: {
        backlog: { title: 'Backlog', tasks: [
          t('Design chassis layout','Sam', d(14), ['Mechanical','Design'], '- [ ] Gather specs\\n- [ ] First draft\\nRemember mounting points.'),
          t('Research motor options','Alex', d(5), ['Electrical'], 'Brushless vs brushed.\\n- [ ] Compare torque\\n- [x] Vendor quotes'),
          t('Evaluation matrix','Sam', d(9), ['Business'], '- [ ] Scoring\\n- [ ] Stakeholder review')
        ]},
        todo: { title: 'To Do', tasks: [
          t('Set up firmware repo', 'Jordan', d(2), ['Programming'], '- [ ] Repo scaffolding\\n- [ ] CI checks'),
          t('Website landing copy', 'Taylor', d(1), ['Website'], 'Punchy headline.\\n- [ ] Draft 1\\n- [ ] Review')
        ]},
        inprogress: { title: 'In Progress', tasks: [
          t('Assemble prototype v1', 'Riley', d(3), ['Mechanical'], '- [ ] Frame\\n- [ ] Wiring\\n- [ ] Smoke test'),
          t('Sensor bring-up', 'Alex', d(4), ['Electrical','Programming'], '- [ ] SPI test\\n- [ ] ADC tune')
        ]},
        done: { title: 'Done', tasks: [
          t('Procure dev kits', 'Casey', d(-2), ['Misc'], '- [x] Ordered\\n- [x] Received')
        ]}
      }
    };
    function t(title, assignee, due, tags, description){
      return { id: crypto.randomUUID(), title, assignee, due, tags, description, comments:[
        { author:'System', text:'Sample note for preview', timestamp: Date.now()-3600_000 }
      ], order:0 };
    }
    function d(n){ const x = new Date(Date.now()+n*864e5); return x.toISOString().slice(0,10); }

    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&quot;').replaceAll('`','&#39;');
    }
    function dueHTML(dueStr){
      if(!dueStr) return '<span class="text-xs text-slate-500 dark:text-slate-400">no due</span>';
      const dt = new Date(dueStr + 'T23:59:59');
      const diffMs = dt - new Date();
      const diffH = diffMs / 36e5;
      let cls = 'text-xs text-slate-500 dark:text-slate-400';
      if (diffMs < 0) cls = 'text-xs due-overdue';
      else if (diffH <= 24) cls = 'text-xs due-soon';
      return `<span class="${cls}">${esc(dueStr)}</span>`;
    }
    function descHTML(desc, id){
      const text = String(desc||''); if(!text.trim()) return '';
      const lines = text.split(/\r?\n/);
      const re = /^\s*-\s*\[([ xX])\]\s*(.*)$/;
      return lines.map((line, idx)=>{
        const m = line.match(re);
        if(m){
          const checked = m[1].toLowerCase()==='x';
          const item = m[2] || '';
          return `
            <label class="flex items-start gap-2 py-0.5 select-none">
              <input type="checkbox" class="desc-checkbox mt-0.5" data-task-id="${esc(id)}" data-line-index="${idx}" ${checked?'checked':''} />
              <span class="leading-tight whitespace-pre-wrap break-words">${esc(item)}</span>
            </label>`;
        }
        return `<div class="leading-tight py-0.5 whitespace-pre-wrap break-words">${esc(line)}</div>`;
      }).join('');
    }

    const board = document.getElementById('board');

    function renderBoard(){
      board.innerHTML = '';
      state.order.forEach(colId=>{
        const col = state.columns[colId];
        col.tasks.forEach((t,i)=>t.order=i);
        const sec = document.createElement('section');
        sec.className = 'column-section';
        sec.innerHTML = `
          <div class="column-header">
            <h2 class="column-title text-base">${esc(col.title)}</h2>
            <div class="column-count">${col.tasks.length}</div>
          </div>
          <div class="task-list" data-col="${colId}"></div>`;
        board.appendChild(sec);

        const list = sec.querySelector('.task-list');
        col.tasks.sort((a,b)=>(a.order??0)-(b.order??0)).forEach(task=>{
          list.appendChild(card(task, colId));
        });
      });
      bindPointerDnD();
      bindTilt();
    }

    function card(task, colId){
      const el = document.createElement('div');
      el.className = 'task-card';
      el.dataset.id = task.id;
      el.dataset.col = colId;

      const tags = (task.tags||[]).map(tag=>`<span class="tag-chip">${esc(tag)}</span>`).join('');
      const desc = descHTML(task.description||'', task.id);

      el.innerHTML = `
        <div class="tilt-wrap">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <h3 class="font-semibold text-slate-800 dark:text-slate-100 truncate">${esc(task.title)}</h3>
              <div class="task-meta text-xs">
                ${esc(task.assignee||'Unassigned')} • ${dueHTML(task.due||'')}
              </div>
            </div>
            <button class="drag-handle shrink-0" aria-label="Drag task" title="Drag task">
              <span class="grip"></span>
            </button>
          </div>

          ${tags ? `<div class="mt-2 flex gap-2 flex-wrap">${tags}</div>` : ''}

          ${desc ? `
            <div class="mt-3 border border-slate-200/80 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900" data-role="description">
              ${desc}
            </div>` : ''}

          <div class="mt-3">
            <button class="text-xs text-sky-600 dark:text-sky-400 underline toggle-comments">Show Notes</button>
            <div class="collapsible">
              <div class="content">
                <div class="text-sm text-slate-800 dark:text-slate-200 space-y-2 mt-2">
                  ${(task.comments||[]).map(c=>{
                    const dateStr = c.timestamp ? new Date(c.timestamp).toLocaleString([], {month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
                    return `
                      <div class="border border-slate-200/80 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900">
                        <div class="mb-1">${esc(c.text||'')}</div>
                        <div class="text-xs text-slate-400">${esc(c.author||'Anonymous')} • ${dateStr}</div>
                      </div>`;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>`;

      // Comments expand/collapse (grid 0fr -> 1fr)
      const toggle = el.querySelector('.toggle-comments');
      const coll = el.querySelector('.collapsible');
      toggle.onclick = ()=>{
        const opening = !coll.classList.contains('open');
        coll.classList.toggle('open', opening);
        toggle.textContent = opening ? 'Hide Notes' : 'Show Notes';
      };

      // Checklist toggle (local)
      el.addEventListener('change', (e)=>{
        const cb = e.target.closest('.desc-checkbox'); if(!cb) return;
        const idx = parseInt(cb.getAttribute('data-line-index'),10);
        const lines = String(task.description||'').split(/\r?\n/);
        const line = lines[idx]; if (typeof line !== 'string') return;
        const m = line.match(/^(\s*-\s*\[)([ xX])(\]\s*)(.*)$/);
        if(!m) return;
        const mark = m[2].toLowerCase()==='x' ? ' ' : 'x';
        lines[idx] = `${m[1]}${mark}${m[3]}${m[4]}`;
        task.description = lines.join('\n');
        const container = el.querySelector('[data-role="description"]');
        if(container) container.innerHTML = descHTML(task.description, task.id);
      });

      return el;
    }

    // ---------- Tilt hover following pointer (desktop only) ----------
    function bindTilt(){
      const cards = document.querySelectorAll('.task-card');
      cards.forEach(c=>{
        if (c.dataset.tiltBound) return;
        c.dataset.tiltBound = '1';
        const wrap = c.querySelector('.tilt-wrap');
        let raf = 0;
        let targetRx = 0, targetRy = 0;

        function onMove(e){
          if (e.pointerType === 'touch') return; // disable on touch
          if (c.classList.contains('dragging')) return;
          const r = c.getBoundingClientRect();
          const x = (e.clientX - r.left) / r.width;   // 0..1
          const y = (e.clientY - r.top) / r.height;   // 0..1
          const max = 6; // deg
          targetRy = (x - 0.5) * max; // rotateY
          targetRx = (0.5 - y) * max; // rotateX
          if (!raf) raf = requestAnimationFrame(applyTilt);
        }
        function applyTilt(){
          raf = 0;
          wrap.style.transform = `perspective(900px) rotateX(${targetRx}deg) rotateY(${targetRy}deg)`;
        }
        function resetTilt(){
          targetRx = targetRy = 0;
          wrap.style.transform = '';
        }

        c.addEventListener('pointermove', onMove);
        c.addEventListener('pointerleave', resetTilt);
      });
    }

    // ---------- FLIP helper ----------
    function flipAnimate(elements){
      const first = new Map();
      elements.forEach(el=>first.set(el, el.getBoundingClientRect()));
      requestAnimationFrame(()=>{
        elements.forEach(el=>{
          const last = el.getBoundingClientRect();
          const f = first.get(el); if(!f) return;
          const dx = f.left - last.left;
          const dy = f.top - last.top;
          if(Math.abs(dx)>0.5 || Math.abs(dy)>0.5){
            el.classList.add('flipping');
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            el.style.willChange = 'transform';
            requestAnimationFrame(()=>{
              el.style.transform = '';
              el.addEventListener('transitionend', ()=>{
                el.classList.remove('flipping');
                el.style.willChange = '';
              }, {once:true});
            });
          }
        });
      });
    }

    // ---------- Pointer-based drag (handle only) ----------
    let drag = null;
    const MOVE_THRESHOLD = 6;
    const LIFT_DELAY = 90;

    function bindPointerDnD(){
      document.querySelectorAll('.task-card .drag-handle').forEach(handle=>{
        if(handle.dataset.bound) return;
        handle.dataset.bound = '1';
        handle.addEventListener('pointerdown', onPointerDown);
      });
    }

    function onPointerDown(e){
      if(e.button!==0) return;
      const handle = e.currentTarget;
      const card = handle.closest('.task-card');
      const rect = card.getBoundingClientRect();
      drag = {
        card, handle,
        startX: e.clientX, startY: e.clientY,
        rect, started: false,
        originCol: card.dataset.col, currentCol: card.dataset.col,
        currentList: card.closest('.task-list'),
        pointerId: e.pointerId,
        timeout: setTimeout(()=>maybeStart(e), LIFT_DELAY)
      };
      handle.setPointerCapture(e.pointerId);
      document.addEventListener('pointermove', onPointerMove);
      document.addEventListener('pointerup', onPointerUp, {once:true});
    }

    function maybeStart(e){
      if(!drag || drag.started) return;
      const moved = Math.hypot(e.clientX - drag.startX, e.clientY - drag.startY);
      if(moved < MOVE_THRESHOLD) return;
      drag.started = true;
      liftCard(drag.card, drag.rect);
      createPlaceholder(drag.card, drag.rect);
    }

    function liftCard(card, rect){
      card.classList.add('dragging');
      Object.assign(card.style, {
        position:'fixed',
        left: rect.left+'px',
        top: rect.top+'px',
        width: rect.width+'px',
        height: rect.height+'px',
        pointerEvents:'none'
      });
    }

    function createPlaceholder(card, rect){
      const ph = document.createElement('div');
      ph.className = 'task-placeholder';
      ph.style.setProperty('--ph-h', rect.height+'px');
      drag.placeholder = ph;
      card.parentElement.insertBefore(ph, card.nextSibling);
    }

    function onPointerMove(e){
      if(!drag) return;
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;

      if(!drag.started && Math.hypot(dx,dy) >= MOVE_THRESHOLD){
        clearTimeout(drag.timeout);
        drag.started = true;
        liftCard(drag.card, drag.rect);
        createPlaceholder(drag.card, drag.rect);
      }
      if(!drag.started) return;

      drag.card.style.transform = `translate(${dx}px, ${dy}px)`;

      const lists = [...document.querySelectorAll('.task-list')];
      let over = null;
      for(const l of lists){
        const r = l.getBoundingClientRect();
        if(e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom){ over = l; break; }
      }
      document.querySelectorAll('.column-section').forEach(s=>s.classList.remove('drag-target'));
      if(over) over.closest('.column-section').classList.add('drag-target');

      if(over){
        const cards = [...over.querySelectorAll('.task-card:not(.dragging)')];
        let inserted = false;
        for(const c of cards){
          const cr = c.getBoundingClientRect();
          if(e.clientY < cr.top + cr.height/2){ over.insertBefore(drag.placeholder, c); inserted = true; break; }
        }
        if(!inserted) over.appendChild(drag.placeholder);
        drag.currentCol = over.dataset.col;
        drag.currentList = over;
      }
    }

    function onPointerUp(){
      if(!drag) return;
      clearTimeout(drag.timeout);

      const {card, placeholder, currentCol, originCol, currentList} = drag;

      if(!drag.started){
        cleanupDrag();
        return;
      }

      const srcList = card.closest('.task-list');
      const dstList = currentList || srcList;

      const affected = new Set([
        ...srcList.querySelectorAll('.task-card:not(.dragging)'),
        ...dstList.querySelectorAll('.task-card:not(.dragging)')
      ]);
      flipAnimate([...affected]);

      dstList.insertBefore(card, placeholder);
      placeholder.remove();

      card.classList.remove('dragging');
      Object.assign(card.style, { position:'', left:'', top:'', width:'', height:'', transform:'', pointerEvents:'' });
      document.querySelectorAll('.column-section').forEach(s=>s.classList.remove('drag-target'));

      // Update dataset and model ordering
      card.dataset.col = currentCol;

      const fromArr = state.columns[originCol].tasks;
      const toArr = state.columns[currentCol].tasks;
      const movedIdx = fromArr.findIndex(t=>t.id===card.dataset.id);
      const moved = fromArr.splice(movedIdx,1)[0];
      const ids = [...dstList.querySelectorAll('.task-card')].map(n=>n.dataset.id);
      const newIndex = ids.indexOf(card.dataset.id);
      toArr.splice(newIndex, 0, moved);

      resyncModelFromDOM();
      pulse(card);

      cleanupDrag();
    }

    function resyncModelFromDOM(){
      document.querySelectorAll('.task-list').forEach(list=>{
        const colId = list.dataset.col;
        const ids = [...list.querySelectorAll('.task-card')].map(n=>n.dataset.id);
        const arr = state.columns[colId].tasks;
        arr.sort((a,b)=> ids.indexOf(a.id) - ids.indexOf(b.id));
        arr.forEach((t,i)=> t.order=i);
        const countEl = list.parentElement.querySelector('.column-count');
        if(countEl) countEl.textContent = arr.length;
      });
    }

    function pulse(el){
      try{ el.animate([{transform:'scale(1.045)'},{transform:'scale(1)'}], {duration:220, easing:'cubic-bezier(.22,.9,.33,1)'}); }catch{}
    }

    function cleanupDrag(){
      if(!drag) return;
      try{ drag.handle.releasePointerCapture(drag.pointerId); }catch{}
      document.removeEventListener('pointermove', onPointerMove);
      drag = null;
    }

    // Start
    renderBoard();
  </script>
</body>
</html>
