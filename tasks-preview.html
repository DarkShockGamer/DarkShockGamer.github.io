<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UI Lab — Task Board Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --ease-spring: cubic-bezier(.22, .9, .33, 1);
      --ease-soft-out: cubic-bezier(.18, .72, .42, 1);
      --ease-soft-in: cubic-bezier(.6, .04, .98, .34);
      --dur-fast: 120ms;
      --dur-medium: 260ms;
      --dur-slow: 520ms;
      --card-radius: 0.75rem;
    }
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    @media (prefers-color-scheme: dark) {
      html, body { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #0b1220, #0a0f1a); color: #e5e7eb; }
    }

    /* Column styling (glassy) */
    @media (prefers-color-scheme: dark) {
      :root { --glass-bg: rgba(15,23,42,0.55); --glass-border: rgba(255,255,255,0.08); }
    }
    @media (prefers-color-scheme: light) {
      :root { --glass-bg: rgba(255,255,255,0.55); --glass-border: rgba(0,0,0,0.06); }
    }
    .column-section {
      position: relative;
      backdrop-filter: saturate(160%) blur(18px);
      -webkit-backdrop-filter: saturate(160%) blur(18px);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(2, 6, 23, 0.10);
      transition: border-color var(--dur-fast) var(--ease-soft-out),
                  background-color var(--dur-medium) var(--ease-soft-out);
      padding: 1rem;
    }
    .column-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.75rem;
      background: rgba(241,245,249,0.6);
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
    }
    @media (prefers-color-scheme: dark) {
      .column-header { background: rgba(15,23,42,0.6); border-color: #1f2937; }
    }
    .column-count {
      color: #0369a1; background: #e0f2fe; border: 1px solid #bae6fd;
      border-radius: 9999px; padding: 0 0.5rem; font-size: 0.75rem; line-height: 1.25rem;
    }
    @media (prefers-color-scheme: dark) {
      .column-count { color: #7dd3fc; background: #083344; border-color: #075985; }
    }
    .column-section.drag-target {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14,165,233,0.15);
    }

    /* Task cards */
    .task-card {
      position: relative;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
      padding: 0.75rem;
      box-shadow: 0 1px 1px rgba(2, 6, 23, 0.04);
      transition:
        transform var(--dur-medium) var(--ease-spring),
        box-shadow var(--dur-medium) var(--ease-soft-out),
        background-color var(--dur-fast) linear,
        border-color var(--dur-fast) linear,
        opacity var(--dur-fast) linear;
      will-change: transform, box-shadow;
      transform-origin: 50% 50%;
      touch-action: none;
    }
    .task-card:not(.dragging):hover {
      transform: translateY(-2px) scale(1.015);
      box-shadow: 0 12px 32px -8px rgba(2,132,199,0.25), 0 4px 12px rgba(0,0,0,0.06);
      border-color: #93c5fd;
    }
    @media (prefers-color-scheme: dark) {
      .task-card { background: #0b1220; border-color: #1f2937; box-shadow: 0 1px 1px rgba(2, 6, 23, 0.6); }
      .task-card:not(.dragging):hover { border-color: #0ea5e9; box-shadow: 0 6px 16px rgba(14,165,233,0.18); }
    }

    .task-card.dragging {
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 20px 44px -12px rgba(2,132,199,0.35), 0 6px 18px rgba(0,0,0,0.3);
      transform: scale(1.045) rotateX(3deg) rotateY(2deg);
      opacity: 0.92;
      border-color: #0ea5e9;
    }
    .task-card.dragging::after {
      content: "";
      position: absolute; inset: 0; border-radius: inherit; padding: 2px;
      background: linear-gradient(135deg,#0ea5e9,#38bdf8,#0369a1);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity: .55;
      animation: ringFlow 3s linear infinite;
    }
    @keyframes ringFlow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

    /* Placeholder */
    .task-placeholder {
      height: var(--ph-height, 72px);
      border: 2px dashed #0ea5e9;
      border-radius: var(--card-radius);
      background: rgba(14,165,233,0.06);
      animation: pulsePlaceholder 1.8s ease-in-out infinite;
    }
    @keyframes pulsePlaceholder {
      0%, 100% { background: rgba(14,165,233,0.06); }
      50% { background: rgba(14,165,233,0.12); }
    }
    .task-list { min-height: 120px; display: grid; gap: 0.75rem; }

    /* FLIP helper */
    .task-card.flipping {
      transition: transform var(--dur-medium) var(--ease-spring);
    }

    /* Comments expand */
    .comments-section {
      border-top: 1px solid #e2e8f0;
      margin-top: 0.5rem; padding-top: 0.5rem;
      transition: opacity var(--dur-fast) var(--ease-soft-out),
                  transform var(--dur-fast) var(--ease-soft-out);
      transform-origin: top;
    }
    .comments-section.entering { opacity: 0; transform: scaleY(.92); }
    .comments-section.open { opacity: 1; transform: scaleY(1); }
    @media (prefers-color-scheme: dark) {
      .comments-section { border-color: #1f2937; }
    }

    /* Tags */
    .tag-chip {
      display: inline-block; background: #e0f2fe; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; margin-right: 0.25rem; margin-bottom: 0.25rem;
      font-size: 0.75rem; line-height: 1.25rem; white-space: nowrap; border: 1px solid #bae6fd;
      animation: chipIn var(--dur-fast) var(--ease-soft-out);
    }
    @media (prefers-color-scheme: dark) {
      .tag-chip { background: #0c4a6e; color: #e0f2fe; border-color: #075985; }
    }
    @keyframes chipIn { from { transform: translateY(4px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Due date colors */
    .due-overdue { color: #dc2626; }
    .due-soon { color: #d97706; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .task-card, .comments-section, .tag-chip { animation: none !important; transition: none !important; }
      .task-placeholder { animation: none !important; }
    }
  </style>
</head>
<body class="min-h-screen p-6">
  <header class="max-w-7xl mx-auto mb-6 px-2">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
      <div class="flex flex-col gap-1">
        <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">UI Lab — Task Board Preview</h1>
        <p class="text-sm text-sky-600 dark:text-sky-400">Previewing smooth drag, glass columns, and modern motion</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
        <span>prefers-color-scheme respected • pointer-based drag • FLIP reorder</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto">
    <div id="board" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
    <footer class="mt-12 text-center py-4 border-t border-slate-100 dark:border-slate-800">
      <span class="text-sky-600 dark:text-sky-400 text-sm">This is a local UI lab; no data is saved.</span>
    </footer>
  </main>

  <script>
    // Sample data (no backend)
    const state = {
      order: ['backlog', 'todo', 'inprogress', 'done'],
      columns: {
        backlog: {
          title: 'Backlog',
          tasks: [
            makeTask('Design chassis layout', 'Sam', daysFromNow(14), ['Mechanical','Design'], '- [ ] Gather specs\n- [ ] First draft\nRemember mounting points.'),
            makeTask('Research motor options', 'Alex', daysFromNow(5), ['Electrical'], 'Brushless vs brushed.\n- [ ] Compare torque\n- [x] Gather vendor quotes')
          ]
        },
        todo: {
          title: 'To Do',
          tasks: [
            makeTask('Set up firmware repo', 'Jordan', daysFromNow(2), ['Programming'], '- [ ] Repo scaffolding\n- [ ] CI checks'),
            makeTask('Website landing copy', 'Taylor', daysFromNow(1), ['Business','Website'], 'Punchy headline.\n- [ ] Draft 1\n- [ ] Review')
          ]
        },
        inprogress: {
          title: 'In Progress',
          tasks: [
            makeTask('Assemble prototype v1', 'Riley', daysFromNow(3), ['Mechanical'], '- [ ] Frame\n- [ ] Wiring\n- [ ] Smoke test')
          ]
        },
        done: {
          title: 'Done',
          tasks: [
            makeTask('Procure dev kits', 'Casey', daysFromNow(-2), ['Misc'], '- [x] Ordered\n- [x] Received')
          ]
        }
      }
    };
    function makeTask(title, assignee, dueStr, tags, description) {
      return {
        id: crypto.randomUUID(),
        title, assignee, due: dueStr, tags, description,
        comments: [
          { author: 'System', text: 'Sample note for preview', timestamp: Date.now() - 3600_000 }
        ],
        order: 0
      };
    }
    function daysFromNow(n) {
      const d = new Date(Date.now() + n*24*3600*1000);
      return d.toISOString().slice(0,10);
    }
    function formatDueDate(dueStr) {
      if (!dueStr) return '<span class="text-xs text-slate-500 dark:text-slate-400">no due</span>';
      const dueDate = new Date(dueStr + 'T23:59:59');
      const now = new Date();
      const diffMs = dueDate - now;
      const diffHours = diffMs / 36e5;
      let cls = 'text-xs text-slate-500 dark:text-slate-400';
      if (diffMs < 0) cls = 'text-xs due-overdue';
      else if (diffHours <= 24) cls = 'text-xs due-soon';
      return `<span class="${cls}">${dueStr}</span>`;
    }
    function escHtml(str) {
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll("'",'&quot;')
        .replaceAll('"','&quot;')
        .replaceAll('`','&#39;');
    }
    function renderDescriptionHTML(desc, taskId) {
      const text = String(desc || '');
      if (!text.trim()) return '';
      const lines = text.split(/\r?\n/);
      return lines.map((line, idx) => {
        const m = line.match(/^\s*-\s*\[([ xX])\]\s*(.*)$/);
        if (m) {
          const checked = m[1].toLowerCase() === 'x';
          const item = m[2] || '';
          return `
            <label class="flex items-start gap-2 py-0.5 select-none">
              <input type="checkbox" class="desc-checkbox mt-0.5" data-task-id="${escHtml(taskId)}" data-line-index="${idx}" ${checked ? 'checked' : ''} />
              <span class="leading-tight whitespace-pre-wrap break-words">${escHtml(item)}</span>
            </label>
          `;
        }
        return `<div class="leading-tight py-0.5 whitespace-pre-wrap break-words">${escHtml(line)}</div>`;
      }).join('');
    }

    const board = document.getElementById('board');

    function renderBoard() {
      board.innerHTML = '';
      state.order.forEach(colId => {
        const col = state.columns[colId];
        col.tasks.forEach((t, i) => t.order = i);
        const section = document.createElement('section');
        section.className = 'column-section';
        section.innerHTML = `
          <div class="column-header">
            <h2 class="text-base font-semibold text-slate-700 dark:text-slate-200">${col.title}</h2>
            <div class="column-count">${col.tasks.length}</div>
          </div>
          <div class="task-list" data-col="${colId}"></div>
        `;
        board.appendChild(section);

        const list = section.querySelector('.task-list');
        col.tasks.sort((a,b) => (a.order ?? 0) - (b.order ?? 0)).forEach(task => {
          list.appendChild(createTaskEl(task, colId));
        });
      });
      initPointerDnD();
    }

    function createTaskEl(task, colId) {
      const div = document.createElement('div');
      div.className = 'task-card';
      div.dataset.id = task.id;
      div.dataset.col = colId;

      const descHtml = renderDescriptionHTML(task.description || '', task.id);
      const tagsHtml = (task.tags || []).map(t => `<span class="tag-chip">${escHtml(t)}</span>`).join('');

      div.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <h3 class="font-medium text-slate-800 dark:text-slate-200">${escHtml(task.title)}</h3>
            <div class="text-xs text-slate-500 dark:text-slate-400">${escHtml(task.assignee || 'Unassigned')} • ${formatDueDate(task.due || '')}</div>
          </div>
          <div class="shrink-0">
            <button class="text-xs px-2 py-1 border border-slate-300 rounded-md hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">⋯</button>
          </div>
        </div>

        <div class="mt-2 flex gap-2 flex-wrap">${tagsHtml}</div>

        ${descHtml ? `
          <div class="mt-3 border border-slate-100 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900" data-role="description">
            ${descHtml}
          </div>
        ` : ''}

        <div class="mt-3">
          <button class="text-xs text-sky-600 dark:text-sky-400 underline toggle-comments">Show Notes</button>
          <div class="comments-section hidden">
            <div class="text-sm text-slate-800 dark:text-slate-200 space-y-2 mt-2">
              ${(task.comments || []).map(c => {
                const dateStr = c.timestamp ? new Date(c.timestamp).toLocaleString([], { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
                return `
                  <div class="border border-slate-100 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900">
                    <div class="mb-1">${escHtml(c.text || '')}</div>
                    <div class="text-xs text-slate-400">${escHtml(c.author || 'Anonymous')} • ${dateStr}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      // Comments expand/collapse animation
      div.querySelector('.toggle-comments').onclick = (e) => {
        const section = div.querySelector('.comments-section');
        if (section.classList.contains('hidden')) {
          section.classList.remove('hidden');
          section.classList.add('entering');
          requestAnimationFrame(() => {
            section.classList.add('open');
            section.classList.remove('entering');
          });
          e.target.textContent = 'Hide Notes';
        } else {
          section.classList.remove('open');
          section.addEventListener('transitionend', () => {
            section.classList.add('hidden');
          }, { once: true });
          e.target.textContent = 'Show Notes';
        }
      };

      // Checklist toggle (local only)
      div.addEventListener('change', (e) => {
        const cb = e.target.closest('.desc-checkbox');
        if (!cb) return;
        const lineIndex = parseInt(cb.getAttribute('data-line-index'), 10);
        const lines = String(task.description || '').split(/\r?\n/);
        if (lineIndex < 0 || lineIndex >= lines.length) return;
        const line = lines[lineIndex];
        const m = line.match(/^(\s*-\s*\[)([ xX])(\]\s*)(.*)$/);
        if (!m) return;
        const newMark = m[2].toLowerCase() === 'x' ? ' ' : 'x';
        lines[lineIndex] = `${m[1]}${newMark}${m[3]}${m[4]}`;
        task.description = lines.join('\n');
        const container = div.querySelector('[data-role="description"]');
        if (container) container.innerHTML = renderDescriptionHTML(task.description, task.id);
      });

      return div;
    }

    // FLIP animation helper
    function flipAnimate(elements) {
      const first = new Map();
      elements.forEach(el => first.set(el, el.getBoundingClientRect()));
      requestAnimationFrame(() => {
        elements.forEach(el => {
          const last = el.getBoundingClientRect();
          const f = first.get(el); if (!f) return;
          const dx = f.left - last.left;
          const dy = f.top - last.top;
          if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
            el.classList.add('flipping');
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            el.style.willChange = 'transform';
            requestAnimationFrame(() => {
              el.style.transform = '';
              el.addEventListener('transitionend', () => {
                el.classList.remove('flipping');
                el.style.willChange = '';
              }, { once: true });
            });
          }
        });
      });
    }

    // Pointer-based drag
    let activeDrag = null;

    function enablePointerDrag(cardEl) {
      cardEl.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        const rect = cardEl.getBoundingClientRect();
        activeDrag = {
          el: cardEl,
          startX: e.clientX,
          startY: e.clientY,
          rect,
          originCol: cardEl.dataset.col,
          currentCol: cardEl.dataset.col
        };

        // Lift
        cardEl.classList.add('dragging');
        cardEl.style.position = 'fixed';
        cardEl.style.left = rect.left + 'px';
        cardEl.style.top = rect.top + 'px';
        cardEl.style.width = rect.width + 'px';
        cardEl.style.height = rect.height + 'px';
        cardEl.style.pointerEvents = 'none';

        // Placeholder
        const ph = document.createElement('div');
        ph.className = 'task-placeholder';
        ph.style.setProperty('--ph-height', rect.height + 'px');
        activeDrag.placeholder = ph;
        cardEl.parentElement.insertBefore(ph, cardEl.nextSibling);

        cardEl.setPointerCapture(e.pointerId);
        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', onPointerUp, { once: true });
      });
    }

    function onPointerMove(e) {
      if (!activeDrag) return;
      const dx = e.clientX - activeDrag.startX;
      const dy = e.clientY - activeDrag.startY;
      activeDrag.el.style.transform = `translate(${dx}px, ${dy}px)`;

      // Column under pointer
      const lists = [...document.querySelectorAll('.task-list')];
      let overList = null;
      for (const l of lists) {
        const r = l.getBoundingClientRect();
        if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom) {
          overList = l; break;
        }
      }
      document.querySelectorAll('.column-section').forEach(sec => sec.classList.remove('drag-target'));
      if (overList) overList.closest('.column-section').classList.add('drag-target');

      // Reorder placeholder inside the hovered list
      if (overList) {
        const cards = [...overList.querySelectorAll('.task-card:not(.dragging)')];
        let inserted = false;
        for (const c of cards) {
          const cr = c.getBoundingClientRect();
          if (e.clientY < cr.top + cr.height / 2) {
            overList.insertBefore(activeDrag.placeholder, c);
            inserted = true; break;
          }
        }
        if (!inserted) overList.appendChild(activeDrag.placeholder);
        activeDrag.currentCol = overList.dataset.col;
        activeDrag.currentList = overList;
      } else {
        activeDrag.currentCol = activeDrag.originCol;
        activeDrag.currentList = activeDrag.el.closest('.task-list');
      }
    }

    function pulseCard(el) {
      try {
        el.animate([{ transform: 'scale(1.045)' }, { transform: 'scale(1)' }], { duration: 220, easing: 'cubic-bezier(.22,.9,.33,1)' });
      } catch {}
    }

    function updateCounts() {
      document.querySelectorAll('.task-list').forEach(list => {
        const colId = list.dataset.col;
        const count = list.querySelectorAll('.task-card').length;
        const headerCount = list.parentElement.querySelector('.column-count');
        if (headerCount) headerCount.textContent = count;
        // Sync model orders
        if (state.columns[colId]) {
          const ids = [...list.querySelectorAll('.task-card')].map(n => n.dataset.id);
          state.columns[colId].tasks.sort((a,b) => ids.indexOf(a.id) - ids.indexOf(b.id));
          state.columns[colId].tasks.forEach((t,i) => t.order = i);
        }
      });
    }

    async function onPointerUp() {
      if (!activeDrag) return;
      const { el, placeholder, currentCol, originCol } = activeDrag;

      const srcList = el.closest('.task-list');
      const dstList = placeholder.closest('.task-list');

      // Elements to FLIP before DOM change
      const affected = new Set([
        ...srcList.querySelectorAll('.task-card:not(.dragging)'),
        ...dstList.querySelectorAll('.task-card:not(.dragging)')
      ]);
      flipAnimate([...affected]);

      // Place card into placeholder
      dstList.insertBefore(el, placeholder);
      placeholder.remove();

      // Reset lifted styles
      el.classList.remove('dragging');
      Object.assign(el.style, { position:'', left:'', top:'', width:'', height:'', transform:'', pointerEvents:'' });

      // Update dataset and model
      el.dataset.col = currentCol;

      // Update model arrays
      const findById = (arr, id) => arr.findIndex(t => t.id === id);
      const srcArr = state.columns[originCol].tasks;
      const dstArr = state.columns[currentCol].tasks;

      const srcIdx = findById(srcArr, el.dataset.id);
      const moving = srcArr.splice(srcIdx, 1)[0];
      moving && (moving.order = 0);

      const dstIds = [...dstList.querySelectorAll('.task-card')].map(n => n.dataset.id);
      const newIndex = dstIds.indexOf(el.dataset.id);
      dstArr.splice(newIndex, 0, moving);

      // Reindex orders and update counts
      updateCounts();

      // Visual feedback
      document.querySelectorAll('.column-section').forEach(sec => sec.classList.remove('drag-target'));
      pulseCard(el);

      activeDrag = null;
      document.removeEventListener('pointermove', onPointerMove);
    }

    function initPointerDnD() {
      document.querySelectorAll('.task-card').forEach(card => {
        if (!card.dataset.pointerBound) {
          enablePointerDrag(card);
          card.dataset.pointerBound = '1';
        }
      });
    }

    // Kick off
    renderBoard();
  </script>
</body>
</html>
