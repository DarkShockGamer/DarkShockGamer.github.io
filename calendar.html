<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trident Robotics — Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Match tasks.html overall vibe */
    html, body { height: 100%; overflow: hidden; }
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Day cell styling */
    .day-cell {
      background: white;
      border: 1px solid #e2e8f0; /* slate-200 */
      border-radius: 0.75rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      min-width: 0;
      transition: border-color 150ms, box-shadow 150ms, transform 150ms;
      cursor: pointer;
    }
    .day-cell:hover {
      border-color: #93c5fd; /* sky-300 */
      box-shadow: 0 6px 16px rgba(2,132,199,0.12);
      transform: translateY(-1px);
    }
    .day-muted { opacity: 0.45; }
    .today-dot {
      display: inline-block;
      width: 0.375rem;
      height: 0.375rem;
      background: #0ea5e9; /* sky-500 */
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    .event-pill,
    .task-pill {
      display: block;
      font-size: 0.75rem;
      line-height: 1.1rem;
      border-radius: 0.5rem;
      padding: 0.125rem 0.375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .event-pill {
      background: #e0f2fe;      /* sky-100 */
      color: #0369a1;           /* sky-700 */
      border: 1px solid #bae6fd;/* sky-200 */
    }
    .task-pill {
      background: #ecfdf5;       /* emerald-50 */
      color: #047857;            /* emerald-700 */
      border: 1px solid #a7f3d0; /* emerald-200 */
    }
    .more-pill {
      display: inline-block;
      font-size: 0.72rem;
      color: #64748b;            /* slate-500 */
    }

    .weekday {
      font-size: 0.75rem;
      color: #0369a1; /* sky-700 */
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; border-radius: 0.75rem; width: min(720px, calc(100vw - 2rem)); max-height: min(80vh, 640px); overflow: auto; border: 1px solid #e2e8f0; }

    /* Dark mode to match tasks.html */
    @media (prefers-color-scheme: dark) {
      html, body { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #0b1220, #0a0f1a); color: #e5e7eb; }
      .day-cell { background: #0f172a !important; border-color: #1f2937 !important; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.3); }
      .day-cell:hover { border-color: #0ea5e9 !important; box-shadow: 0 6px 16px rgba(14,165,233,0.18); }

      .weekday { color: #7dd3fc !important; }
      .event-pill { background: #0c4a6e !important; color: #e0f2fe !important; border-color: #075985 !important; }
      .task-pill  { background: #052e2b !important; color: #a7f3d0 !important; border-color: #065f46 !important; }
      .more-pill { color: #94a3b8 !important; }

      .modal-card { background: #0f172a !important; border-color: #1f2937 !important; }
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <header class="max-w-7xl mx-auto mb-4 px-2">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0">
      <div class="flex flex-col gap-1 w-full md:w-auto">
        <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">Trident Robotics — Calendar</h1>
        <p class="text-sm text-sky-600 dark:text-sky-400">Public events for everyone. Team tasks appear only when signed in with Google on the home page.</p>
      </div>

      <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-end">
        <div id="taskAccessBadge" class="text-xs px-2 py-1 rounded border border-slate-300 text-slate-600 bg-white shadow-sm dark:bg-slate-900 dark:text-slate-300 dark:border-slate-700">
          Tasks hidden • Sign in on the home page
        </div>
      </div>
    </div>

    <div class="mt-3 bg-white p-3 rounded-2xl shadow-sm border border-slate-200 ring-1 ring-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:ring-slate-900/10">
      <div class="flex flex-col gap-2">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="prevBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Previous month" aria-label="Previous month">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div id="monthLabel" class="text-base font-semibold text-slate-700 dark:text-slate-200 min-w-[10ch]"></div>
            <button id="nextBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Next month" aria-label="Next month">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>

          <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-sky-200 border border-sky-300 dark:bg-[#0c4a6e] dark:border-[#075985]"></span> Event</span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 dark:bg-[#052e2b] dark:border-[#065f46]"></span> Task due</span>
            <span class="inline-flex items-center gap-1"><span class="today-dot"></span> Today</span>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="todayBtn" class="px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Today</button>
          <label class="text-sm text-slate-600 dark:text-slate-300">Jump to
            <input id="monthPicker" type="month" class="ml-2 rounded-md border border-slate-300 px-2 py-1 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
          </label>
          <button id="exportIcsBtn" class="px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 text-sm dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Export .ics (this month)</button>

          <!-- Admin-only -->
          <div id="adminControls" class="hidden ml-auto flex items-center gap-2">
            <button id="addEventBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Add Event</button>
            <button id="addScheduleBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Add Schedule</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto flex flex-col">
    <!-- Weekday header -->
    <div id="weekdayHeader" class="grid grid-cols-7 px-2 py-2">
      <div class="weekday">Sun</div>
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
    </div>

    <!-- Calendar grid (7 x 6) -->
    <div id="calendarGrid" class="grid grid-cols-7 grid-rows-6 gap-2 px-2 overflow-hidden"></div>

    <footer class="mt-4 text-center py-4 border-t border-slate-100 dark:border-slate-800 flex flex-col items-center gap-1">
      <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
      <span class="text-sky-600 dark:text-sky-400 text-sm">© 2025 Trident Robotics — Calendar</span>
      <span class="text-xs text-sky-400">Public calendar • Tasks appear when signed in</span>
    </footer>
  </main>

  <!-- Day details modal -->
  <div id="dayModal" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div id="modalDate" class="text-lg font-bold text-slate-800 dark:text-slate-200"></div>
          <div class="text-xs text-slate-500 dark:text-slate-400">All items for this date</div>
        </div>
        <button id="closeModal" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div id="modalContent" class="space-y-5">
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Events</div>
          <div id="modalEvents" class="space-y-2 text-sm"></div>
        </div>
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Tasks due</div>
          <div id="modalTasks" class="space-y-2 text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event editor modal (single event) -->
  <div id="eventEditor" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold text-slate-800 dark:text-slate-200" id="eventEditorTitle">Add Event</div>
        <button id="closeEventEditor" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm">Title
          <input id="evTitle" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Robotics Meeting" />
        </label>
        <label class="text-sm">Date
          <input id="evDate" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">Start time
          <input id="evStart" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">End time
          <input id="evEnd" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm md:col-span-2">Location
          <input id="evLoc" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Room 123" />
        </label>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="evPublic" type="checkbox" class="w-4 h-4" checked />
          Public (visible to everyone)
        </label>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="saveEventBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Schedule builder modal (recurring meetings) -->
  <div id="scheduleEditor" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold text-slate-800 dark:text-slate-200">Add Meeting Schedule</div>
        <button id="closeScheduleEditor" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm md:col-span-2">Title
          <input id="scTitle" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Robotics Meeting" />
        </label>
        <label class="text-sm">From
          <input id="scFrom" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">To
          <input id="scTo" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">Start time
          <input id="scStart" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm">End time
          <input id="scEnd" type="time" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
        </label>
        <label class="text-sm md:col-span-2">Location
          <input id="scLoc" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Shop / Room 123" />
        </label>
        <div class="md:col-span-2">
          <div class="text-sm font-medium mb-1">Weekdays</div>
          <div class="flex flex-wrap gap-2 text-sm">
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="0" /> Sun</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="1" /> Mon</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="2" /> Tue</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="3" /> Wed</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="4" /> Thu</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="5" /> Fri</label>
            <label class="inline-flex items-center gap-1"><input type="checkbox" class="sc-wd" value="6" /> Sat</label>
          </div>
        </div>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="scPublic" type="checkbox" class="w-4 h-4" checked />
          Public (visible to everyone)
        </label>
        <label class="text-sm inline-flex items-center gap-2 md:col-span-2">
          <input id="scReplace" type="checkbox" class="w-4 h-4" />
          Replace existing events with the same title in this range
        </label>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="saveScheduleBtn" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Create</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    // Same Firebase project as tasks.html
    const firebaseConfig = {
      apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHFWZI",
      authDomain: "tridenttaskboard.firebaseapp.com",
      projectId: "tridenttaskboard",
      storageBucket: "tridenttaskboard.firebasestorage.appspot.com",
      messagingSenderId: "143400263387",
      appId: "1:143400263387:web:66ed521ae75af588e836fe",
      measurementId: "G-F12DDQCX87"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const monthLabel = document.getElementById("monthLabel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const todayBtn = document.getElementById("todayBtn");
    const monthPicker = document.getElementById("monthPicker");
    const exportIcsBtn = document.getElementById("exportIcsBtn");
    const grid = document.getElementById("calendarGrid");
    const badge = document.getElementById("taskAccessBadge");

    // Admin UI
    const adminControls = document.getElementById("adminControls");
    const addEventBtn = document.getElementById("addEventBtn");
    const addScheduleBtn = document.getElementById("addScheduleBtn");

    // Day modal
    const modal = document.getElementById("dayModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalDateEl = document.getElementById("modalDate");
    const modalEventsEl = document.getElementById("modalEvents");
    const modalTasksEl = document.getElementById("modalTasks");

    // Event editor
    const eventEditor = document.getElementById("eventEditor");
    const evtTitleEl = document.getElementById("eventEditorTitle");
    const closeEventEditor = document.getElementById("closeEventEditor");
    const evTitle = document.getElementById("evTitle");
    const evDate = document.getElementById("evDate");
    const evStart = document.getElementById("evStart");
    const evEnd = document.getElementById("evEnd");
    const evLoc = document.getElementById("evLoc");
    const evPublic = document.getElementById("evPublic");
    const saveEventBtn = document.getElementById("saveEventBtn");

    // Schedule editor
    const scheduleEditor = document.getElementById("scheduleEditor");
    const closeScheduleEditor = document.getElementById("closeScheduleEditor");
    const scTitle = document.getElementById("scTitle");
    const scFrom = document.getElementById("scFrom");
    const scTo = document.getElementById("scTo");
    const scStart = document.getElementById("scStart");
    const scEnd = document.getElementById("scEnd");
    const scLoc = document.getElementById("scLoc");
    const scPublic = document.getElementById("scPublic");
    const scReplace = document.getElementById("scReplace");

    // Google Sign-In state from index.html
    const G_CRED_KEY = "g_credential_v1";
    const allowedDomains = ["wths.net"]; // from index.html
    const allowedEmails = ["blackshocktrooper@gmail.com"]; // from index.html

    // Event editors (coach/admins) - only these can add/edit/delete events
    const allowedEventEditors = ["blackshocktrooper@gmail.com", "sveselack@wths.net"];

    function decodeJwtPayload(raw) {
      try {
        const parts = String(raw).split(".");
        if (parts.length < 2) return null;
        const base64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = atob(base64);
        try {
          // handle unicode
          const decoded = decodeURIComponent(Array.prototype.map.call(json, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
          return JSON.parse(decoded);
        } catch {
          return JSON.parse(json);
        }
      } catch {
        return null;
      }
    }

    function getGoogleProfile() {
      const raw = localStorage.getItem(G_CRED_KEY);
      if (!raw) return null;
      return decodeJwtPayload(raw);
    }

    function isTaskAccessAllowed() {
      const prof = getGoogleProfile();
      if (!prof || !prof.email) return false;
      const email = String(prof.email).toLowerCase();
      const domainAllowed = allowedDomains.some(d => email.endsWith("@" + d));
      const emailAllowed = allowedEmails.map(e => e.toLowerCase()).includes(email);
      return domainAllowed || emailAllowed;
    }

    function isEventEditor() {
      const prof = getGoogleProfile();
      if (!prof || !prof.email) return false;
      const email = String(prof.email).toLowerCase();
      return allowedEventEditors.map(e => e.toLowerCase()).includes(email);
    }

    function setBadgesAndAdminUI() {
      const tasksAllowed = isTaskAccessAllowed();
      if (tasksAllowed) {
        badge.textContent = "Tasks visible • Signed in";
        badge.classList.remove("border-slate-300", "text-slate-600");
        badge.classList.add("border-emerald-300", "text-emerald-700");
      } else {
        badge.textContent = "Tasks hidden • Sign in on the home page";
        badge.classList.remove("border-emerald-300", "text-emerald-700");
        badge.classList.add("border-slate-300", "text-slate-600");
      }

      if (isEventEditor()) {
        adminControls.classList.remove("hidden");
        adminControls.classList.add("flex");
      } else {
        adminControls.classList.add("hidden");
        adminControls.classList.remove("flex");
      }
    }

    // Date state
    let current = new Date();
    current.setDate(1); // focus on first of month

    // Data caches
    let events = [];  // {id,title,date,time,location,isPublic,createdBy,createdAt}
    let tasks = [];   // only if task access allowed

    function pad(n) { return String(n).padStart(2, "0"); }
    function fmtDateKey(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function monthMatrix(year, month) {
      // Build 42 day objects for a 6-row calendar
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevDays = new Date(year, month, 0).getDate();

      const cells = [];
      for (let i = 0; i < startDay; i++) {
        const day = prevDays - startDay + 1 + i;
        cells.push({ date: new Date(year, month - 1, day), inMonth: false });
      }
      for (let d = 1; d <= daysInMonth; d++) {
        cells.push({ date: new Date(year, month, d), inMonth: true });
      }
      while (cells.length < 42) {
        const last = cells[cells.length - 1].date;
        cells.push({ date: new Date(last.getFullYear(), last.getMonth(), last.getDate() + 1), inMonth: false });
      }
      return cells;
    }

    function groupByDate(items, getKey) {
      const map = new Map();
      for (const it of items) {
        const k = getKey(it);
        if (!k) continue;
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }

    function formatTimeRange(e) {
      const s = (e.startTime || "").trim();
      const en = (e.endTime || "").trim();
      if (!s && !en) return "";
      const to12 = (t) => {
        if (!t) return "";
        const [hh, mm] = t.split(":").map(x => parseInt(x, 10));
        const ampm = hh >= 12 ? "p" : "a";
        const h = ((hh + 11) % 12) + 1;
        return `${h}${mm ? ":" + String(mm).padStart(2, "0") : ""}${ampm}`;
      };
      if (s && en) return `${to12(s)}-${to12(en)}`;
      return to12(s || en);
    }

    async function loadEvents() {
      try {
        const snap = await getDocs(collection(db, "events"));
        const arr = [];
        snap.forEach(docSnap => {
          const e = docSnap.data() || {};
          const date = typeof e.date === "string" ? e.date : "";
          if (!date) return;
          arr.push({
            id: docSnap.id,
            title: e.title || "(Untitled)",
            date,
            time: e.time || "",           // legacy "time" field
            startTime: e.startTime || "", // new fields preferred
            endTime: e.endTime || "",
            location: e.location || "",
            isPublic: e.isPublic !== false,
            createdBy: e.createdBy || "",
            createdAt: e.createdAt || 0
          });
        });
        events = arr;
      } catch (err) {
        console.warn("Failed to load events:", err);
        events = [];
      }
    }

    async function loadTasksIfAllowed() {
      if (!isTaskAccessAllowed()) { tasks = []; return; }
      try {
        const snap = await getDocs(collection(db, "tasks"));
        const arr = [];
        snap.forEach(docSnap => {
          const t = docSnap.data() || {};
          if (t.deleted || t.archived) return;
          arr.push({
            id: docSnap.id,
            title: t.title || "(Untitled)",
            assignee: t.assignee || "Unassigned",
            due: typeof t.due === "string" ? t.due : ""
          });
        });
        tasks = arr;
      } catch (err) {
        console.warn("Failed to load tasks:", err);
        tasks = [];
      }
    }

    function renderMonthLabel(year, month) {
      const dtf = new Intl.DateTimeFormat([], { month: "long", year: "numeric" });
      monthLabel.textContent = dtf.format(new Date(year, month, 1));
      monthPicker.value = `${year}-${pad(month+1)}`;
    }

    function isToday(d) {
      const now = new Date();
      return d.getFullYear() === now.getFullYear() &&
             d.getMonth() === now.getMonth() &&
             d.getDate() === now.getDate();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function openModal(dateObj, dayEvents, dayTasks) {
      modalDateEl.textContent = dateObj.toLocaleDateString([], { weekday: "long", year: "numeric", month: "long", day: "numeric" });

      const canEdit = isEventEditor();

      modalEventsEl.innerHTML = (dayEvents.length
        ? dayEvents.map(e => {
            const tr = formatTimeRange(e) || e.time || "";
            const timeStr = tr ? ` • ${escapeHtml(tr)}` : "";
            const locStr = e.location ? ` • ${escapeHtml(e.location)}` : "";
            const adminBtns = canEdit ? `
              <div class="flex items-center gap-1 shrink-0">
                <button class="edit-ev px-2 py-0.5 text-xs border border-slate-300 rounded hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800" data-id="${e.id}">Edit</button>
                <button class="del-ev px-2 py-0.5 text-xs border border-red-200 text-red-600 rounded hover:bg-red-50 dark:border-red-900 dark:text-red-400 dark:hover:bg-red-950" data-id="${e.id}">Delete</button>
              </div>
            ` : "";
            return `
              <div class="p-2 border border-slate-200 dark:border-slate-800 rounded bg-slate-50 dark:bg-slate-900 flex items-start justify-between gap-2">
                <div>
                  <div class="event-pill">${escapeHtml(e.title)}</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(e.date)}${timeStr}${locStr}</div>
                </div>
                ${adminBtns}
              </div>
            `;
          }).join("")
        : '<div class="text-slate-400 text-sm">No events</div>'
      );

      modalTasksEl.innerHTML = (dayTasks.length
        ? dayTasks.map(t => {
            const who = t.assignee ? ` • ${escapeHtml(t.assignee)}` : "";
            return `
              <div class="p-2 border border-slate-200 dark:border-slate-800 rounded bg-slate-50 dark:bg-slate-900">
                <div class="task-pill">${escapeHtml(t.title)}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(t.due)}${who}</div>
              </div>
            `;
          }).join("")
        : '<div class="text-slate-400 text-sm">No tasks due</div>'
      );

      // Wire admin edit/delete
      if (canEdit) {
        modalEventsEl.querySelectorAll(".edit-ev").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-id");
            const ev = events.find(x => x.id === id);
            if (ev) openEventEditor(ev);
          });
        });
        modalEventsEl.querySelectorAll(".del-ev").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-id");
            if (!confirm("Delete this event?")) return;
            try {
              await deleteDoc(doc(db, "events", id));
              await render(); // reload
              closeModal();
            } catch (err) {
              alert("Delete failed: " + (err?.message || err));
            }
          });
        });
      }

      modal.classList.add("open");
    }

    function closeModal() { modal.classList.remove("open"); }
    closeModalBtn.onclick = closeModal;
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    function renderGrid(year, month) {
      renderMonthLabel(year, month);
      grid.innerHTML = "";

      const cells = monthMatrix(year, month);

      const eventsByDate = groupByDate(events.filter(e => e.isPublic === true), e => e.date);
      const canSeeTasks = isTaskAccessAllowed();
      const tasksByDate = canSeeTasks ? groupByDate(tasks, t => t.due) : new Map();

      // Responsive cap to prevent overflow
      const MAX_VISIBLE = window.innerWidth < 640 ? 2 : 3;

      for (const { date, inMonth } of cells) {
        const key = fmtDateKey(date);
        const dayEvents = (eventsByDate.get(key) || []);
        const dayTasks = canSeeTasks ? (tasksByDate.get(key) || []) : [];
        const total = dayEvents.length + dayTasks.length;

        const cell = document.createElement("div");
        cell.className = "day-cell text-left";
        cell.setAttribute("data-date", key);
        if (!inMonth) cell.classList.add("day-muted");

        const head = document.createElement("div");
        head.className = "flex items-center justify-between gap-2 shrink-0";
        const num = document.createElement("div");
        num.className = "text-sm font-semibold text-slate-700 dark:text-slate-200";
        num.textContent = date.getDate();
        head.appendChild(num);
        if (isToday(date)) {
          const dot = document.createElement("span");
          dot.className = "today-dot";
          head.appendChild(dot);
        }
        cell.appendChild(head);

        const items = document.createElement("div");
        items.className = "flex flex-col gap-1 min-h-0 overflow-hidden";

        const addPill = (txt, cls, title) => {
          const span = document.createElement("span");
          span.className = cls;
          span.title = title || txt;
          span.textContent = txt;
          items.appendChild(span);
        };

        let shown = 0;
        for (const e of dayEvents) {
          if (shown >= MAX_VISIBLE) break;
          const tr = formatTimeRange(e) || e.time || "";
          const label = tr ? `${tr} ${e.title}` : e.title;
          addPill(label, "event-pill", `${e.title}${tr ? " • " + tr : ""}${e.location ? " • " + e.location : ""}`);
          shown++;
        }
        for (const t of dayTasks) {
          if (shown >= MAX_VISIBLE) break;
          addPill(t.title, "task-pill", `${t.title} • ${t.assignee || ""}`);
          shown++;
        }

        if (total > shown) {
          const more = document.createElement("span");
          more.className = "more-pill";
          more.textContent = `+${total - shown} more`;
          items.appendChild(more);
        }

        cell.appendChild(items);

        cell.addEventListener("click", () => openModal(date, dayEvents, dayTasks));
        grid.appendChild(cell);
      }
    }

    function layoutHeights() {
      const viewport = window.innerHeight;
      const outerHeader = document.querySelector("header");
      const main = document.querySelector("main");
      const weekHeader = document.getElementById("weekdayHeader");
      const footer = main.querySelector("footer");

      const headerH = outerHeader.offsetHeight;
      const footerH = footer.offsetHeight;
      const vhRemaining = Math.max(0, viewport - headerH - 24); // small spacing

      // Main fills remaining space
      main.style.height = `${vhRemaining}px`;
      main.style.minHeight = `${vhRemaining}px`;

      // Calendar grid exact height (no page scroll)
      const gridH = Math.max(180, vhRemaining - weekHeader.offsetHeight - footerH - 16);
      grid.style.height = `${gridH}px`;
      grid.style.gridAutoRows = "minmax(0, 1fr)";
    }

    async function render() {
      setBadgesAndAdminUI();
      await Promise.all([loadEvents(), loadTasksIfAllowed()]);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    }

    prevBtn.onclick = () => {
      current.setMonth(current.getMonth() - 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    };
    nextBtn.onclick = () => {
      current.setMonth(current.getMonth() + 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    };
    todayBtn.onclick = () => {
      const now = new Date();
      current = new Date(now.getFullYear(), now.getMonth(), 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    };
    monthPicker.addEventListener("change", () => {
      const val = monthPicker.value; // yyyy-mm
      if (!val) return;
      const [y, m] = val.split("-").map(x => parseInt(x, 10));
      current = new Date(y, m - 1, 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    });

    window.addEventListener("resize", layoutHeights);

    // ICS export for visible month
    function exportVisibleMonthICS() {
      const y = current.getFullYear();
      const m = current.getMonth();
      const start = new Date(y, m, 1);
      const end = new Date(y, m + 1, 0);
      const startKey = fmtDateKey(start);
      const endKey = fmtDateKey(end);

      const inRange = events.filter(e => e.isPublic !== false && e.date >= startKey && e.date <= endKey);
      const lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Trident Robotics//Calendar//EN",
      ];

      const toICSDate = (dateStr, timeStr) => {
        // Use local time (floating) to avoid timezone surprises on import
        if (!timeStr) return dateStr.replace(/-/g, "") + "T000000";
        const [hh, mm] = timeStr.split(":");
        return dateStr.replace(/-/g, "") + "T" + hh.padStart(2, "0") + mm.padStart(2, "0") + "00";
      };

      for (const e of inRange) {
        const title = e.title || "Event";
        const startTime = e.startTime || e.time || "";
        const endTime = e.endTime || "";
        const dtStart = toICSDate(e.date, startTime);
        // If no endTime, set default +1h
        let dtEnd = "";
        if (endTime) {
          dtEnd = toICSDate(e.date, endTime);
        } else if (startTime) {
          const [hh, mm] = startTime.split(":").map(x => parseInt(x, 10));
          const d = new Date(e.date + "T" + pad(hh) + ":" + pad(mm) + ":00");
          d.setHours(d.getHours() + 1);
          dtEnd = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
        } else {
          // all-day
          dtEnd = e.date.replace(/-/g, "") + "T235900";
        }

        lines.push("BEGIN:VEVENT");
        lines.push("SUMMARY:" + title.replace(/\n/g, "\\n"));
        lines.push("DTSTART:" + dtStart);
        lines.push("DTEND:" + dtEnd);
        if (e.location) lines.push("LOCATION:" + e.location.replace(/[\n,]/g, " ").trim());
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");

      const blob = new Blob([lines.join("\r\n")], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const monthName = new Intl.DateTimeFormat([], { month: "long" }).format(new Date(y, m, 1));
      a.href = url;
      a.download = `Trident-${monthName}-${y}.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    exportIcsBtn.addEventListener("click", exportVisibleMonthICS);

    // Admin-only: Add/Edit single event
    function openEventEditor(ev = null) {
      if (!isEventEditor()) return alert("You are not authorized to manage events.");

      evtTitleEl.textContent = ev ? "Edit Event" : "Add Event";
      evTitle.value = ev?.title || "";
      evDate.value = ev?.date || `${current.getFullYear()}-${pad(current.getMonth()+1)}-${pad(new Date().getDate())}`;
      evStart.value = ev?.startTime || (ev?.time || "");
      evEnd.value = ev?.endTime || "";
      evLoc.value = ev?.location || "";
      evPublic.checked = ev?.isPublic !== false;

      saveEventBtn.onclick = async () => {
        const title = evTitle.value.trim();
        const date = evDate.value;
        const startTime = evStart.value || "";
        const endTime = evEnd.value || "";
        const location = evLoc.value.trim();
        const isPublic = !!evPublic.checked;

        if (!title || !date) { alert("Title and date are required."); return; }

        const prof = getGoogleProfile();
        try {
          if (ev && ev.id) {
            await setDoc(doc(db, "events", ev.id), {
              title, date, startTime, endTime, location, isPublic,
              updatedAt: Date.now(),
              updatedBy: prof?.email || ""
            }, { merge: true });
          } else {
            await addDoc(collection(db, "events"), {
              title, date, startTime, endTime, location, isPublic,
              createdAt: Date.now(),
              createdBy: prof?.email || ""
            });
          }
          eventEditor.classList.remove("open");
          await render();
        } catch (err) {
          alert("Save failed: " + (err?.message || err));
        }
      };

      eventEditor.classList.add("open");
    }
    function closeEventEditorModal() { eventEditor.classList.remove("open"); }
    closeEventEditor.onclick = closeEventEditorModal;
    eventEditor.addEventListener("click", (e) => { if (e.target === eventEditor) closeEventEditorModal(); });

    addEventBtn?.addEventListener("click", () => openEventEditor());

    // Admin-only: Schedule (recurring)
    function openScheduleEditor() {
      if (!isEventEditor()) return alert("You are not authorized to manage schedules.");

      scTitle.value = "Robotics Meeting";
      const y = current.getFullYear();
      const m = current.getMonth();
      scFrom.value = `${y}-${pad(m+1)}-01`;
      scTo.value = `${y}-${pad(m+1)}-${pad(new Date(y, m+1, 0).getDate())}`;
      scStart.value = "15:30";
      scEnd.value = "18:00";
      scLoc.value = "Shop / Room 123";
      scPublic.checked = true;
      scReplace.checked = false;

      scheduleEditor.classList.add("open");
    }
    function closeScheduleEditorModal() { scheduleEditor.classList.remove("open"); }
    closeScheduleEditor.onclick = closeScheduleEditorModal;
    scheduleEditor.addEventListener("click", (e) => { if (e.target === scheduleEditor) closeScheduleEditorModal(); });

    async function createSchedule() {
      const title = scTitle.value.trim();
      const from = scFrom.value;
      const to = scTo.value;
      const startTime = scStart.value || "";
      const endTime = scEnd.value || "";
      const location = scLoc.value.trim();
      const isPublic = !!scPublic.checked;
      const replace = !!scReplace.checked;

      if (!title || !from || !to) { alert("Title, From, and To are required."); return; }

      const weekdays = Array.from(scheduleEditor.querySelectorAll(".sc-wd:checked")).map(cb => parseInt(cb.value, 10));
      if (weekdays.length === 0) { alert("Select at least one weekday."); return; }

      const startDate = new Date(from + "T00:00:00");
      const endDate = new Date(to + "T00:00:00");
      if (endDate < startDate) { alert("To date must be after From date."); return; }

      const prof = getGoogleProfile();
      const batch = writeBatch(db);

      // Optionally replace: delete existing events with same title in range
      if (replace) {
        for (const e of events) {
          if (e.title === title && e.date >= from && e.date <= to) {
            batch.delete(doc(db, "events", e.id));
          }
        }
      }

      // Create new events for each matching weekday in range
      const cursor = new Date(startDate);
      while (cursor <= endDate) {
        if (weekdays.includes(cursor.getDay())) {
          const dateStr = fmtDateKey(cursor);
          const ref = doc(collection(db, "events"));
          batch.set(ref, {
            title, date: dateStr,
            startTime, endTime,
            location, isPublic,
            createdAt: Date.now(),
            createdBy: prof?.email || ""
          });
        }
        cursor.setDate(cursor.getDate() + 1);
      }

      try {
        await batch.commit();
        scheduleEditor.classList.remove("open");
        await render();
      } catch (err) {
        alert("Schedule creation failed: " + (err?.message || err));
      }
    }
    document.getElementById("saveScheduleBtn")?.addEventListener("click", createSchedule);
    addScheduleBtn?.addEventListener("click", openScheduleEditor);

    // Initial mount
    render();
  </script>
</body>
</html>
