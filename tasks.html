<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trident Robotics — Task Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, sans-serif; }
    .dragging { opacity: 0.5; transform: scale(1.02); }
    .droppable-hover { outline: 2px dashed rgba(2,132,199,0.35); outline-offset: 4px; background-color: rgba(2,132,199,0.06) !important; }

    /* Drawer styles */
    .drawer { position: fixed; top: 0; right: -100%; width: 100%; max-width: 480px; height: 100vh; background: white; box-shadow: -4px 0 24px rgba(0,0,0,0.15); transition: right 0.3s ease-in-out; z-index: 1000; overflow-y: auto; }
    .drawer.open { right: 0; }
    .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
    .drawer-overlay.active { display: block; }

    /* Due date colors */
    .due-overdue { color: #dc2626 !important; } /* red-600 */
    .due-soon { color: #d97706 !important; }    /* amber-600 */

    /* Dropdown layout */
    .dropdown { position: relative; width: 12rem; }
    .dropdown-btn {
      width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; background: white; cursor: pointer; text-align: left;
      display: flex; align-items: center; gap: 0.25rem; flex-wrap: wrap; min-height: 2.25rem;
    }
    .dropdown-btn:hover { border-color: #93c5fd; }
    .dropdown-list {
      position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white;
      max-height: 220px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 8px 24px rgba(2, 132, 199, 0.15); margin-top: 0.25rem;
    }
    .dropdown-list label {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.625rem; cursor: pointer; width: 100%; user-select: none; line-height: 1.1;
    }
    .dropdown-list label:hover { background-color: #e0f2fe; }
    .dropdown-list input[type="checkbox"] { margin: 0; }

    /* Tag chips */
    .tag-chip {
      display: inline-block; background: #e0f2fe; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; margin-right: 0.25rem; margin-bottom: 0.25rem;
      font-size: 0.75rem; line-height: 1.25rem; white-space: nowrap; border: 1px solid #bae6fd;
    }
    .dropdown-btn .placeholder { color: #94a3b8; }

    /* Column styling */
    .column-section { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.05); padding: 1rem; }
    .column-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; background: rgba(241,245,249,0.6);
      border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.5rem 0.75rem;
    }
    .column-count { color: #0369a1; background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 9999px; padding: 0 0.5rem; font-size: 0.75rem; line-height: 1.25rem; }

    /* Task card */
    .task-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem; box-shadow: 0 1px 1px rgba(2, 6, 23, 0.04); transition: box-shadow 150ms, border-color 150ms; }
    .task-card:hover { box-shadow: 0 6px 16px rgba(2,132,199,0.12); border-color: #93c5fd; transform: translateY(-1px); }

    /* Custom checkbox styling for description checklist */
    .desc-checkbox {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 1rem;
      height: 1rem;
      border: 2px solid #d1d5db;
      border-radius: 0.25rem;
      background-color: white;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 150ms;
    }
    .desc-checkbox:hover {
      border-color: #10b981;
    }
    .desc-checkbox:checked {
      background-color: #10b981;
      border-color: #10b981;
    }
    .desc-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 0.25rem;
      top: 0.0625rem;
      width: 0.375rem;
      height: 0.625rem;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      html, body { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #0b1220, #0a0f1a); color: #e5e7eb; }

      .dropdown-btn { background: #0b1220 !important; border-color: #334155 !important; color: #e5e7eb !important; }
      .dropdown-btn:hover { border-color: #0ea5e9 !important; }
      .dropdown-list { background: #0b1220 !important; border-color: #334155 !important; box-shadow: 0 8px 24px rgba(14, 165, 233, 0.12); }
      .dropdown-list label:hover { background-color: rgba(14,165,233,0.1) !important; }
      .dropdown-list input[type="checkbox"] { accent-color: #0ea5e9; }
      .dropdown-btn .placeholder { color: #94a3b8 !important; }

      .tag-chip { background: #0c4a6e !important; color: #e0f2fe !important; border-color: #075985 !important; }
      .column-section { background: #0f172a !important; border-color: #1f2937 !important; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.3); }
      .column-header { background: rgba(15,23,42,0.6) !important; border-color: #1f2937 !important; }
      .column-count { color: #7dd3fc !important; background: #083344 !important; border-color: #075985 !important; }

      .task-card { background: #0b1220 !important; border-color: #1f2937 !important; box-shadow: 0 1px 1px rgba(2, 6, 23, 0.6); }
      .task-card:hover { border-color: #0ea5e9 !important; box-shadow: 0 6px 16px rgba(14,165,233,0.18); }

      .droppable-hover { outline-color: rgba(125, 211, 252, 0.35) !important; background-color: rgba(14, 165, 233, 0.08) !important; }

      input[type="text"], input[type="date"], input:not([type]), .comment-input, textarea {
        background: #0b1220 !important; color: #e5e7eb !important; border-color: #334155 !important;
      }
      input::placeholder { color: #94a3b8 !important; }

      .modal-panel { background: #0f172a !important; border-color: #1f2937 !important; }
      .drawer { background: #0f172a !important; border-left: 1px solid #1f2937 !important; }

      /* Dark mode for description checkboxes */
      .desc-checkbox {
        background-color: #0b1220 !important;
        border-color: #475569 !important;
      }
      .desc-checkbox:hover {
        border-color: #10b981 !important;
      }
      .desc-checkbox:checked {
        background-color: #10b981 !important;
        border-color: #10b981 !important;
      }
    }

    /* Description styling utilities */
    .desc-hl { background-color: #fef08a; padding: 0 0.125rem; border-radius: 0.125rem; }
    .desc-color-red { color: #dc2626; }
    .desc-color-orange { color: #ea580c; }
    .desc-color-yellow { color: #ca8a04; }
    .desc-color-green { color: #16a34a; }
    .desc-color-blue { color: #2563eb; }
    .desc-color-purple { color: #9333ea; }
    .desc-color-slate { color: #475569; }
    .desc-underline { text-decoration: underline; }
    .desc-size-xs { font-size: 0.75rem; line-height: 1rem; }
    .desc-size-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .desc-size-base { font-size: 1rem; line-height: 1.5rem; }
    .desc-size-lg { font-size: 1.125rem; line-height: 1.75rem; }

    /* Dark mode for description styling */
    @media (prefers-color-scheme: dark) {
      .desc-hl { background-color: #854d0e; color: #fef08a; }
      .desc-color-red { color: #f87171; }
      .desc-color-orange { color: #fb923c; }
      .desc-color-yellow { color: #facc15; }
      .desc-color-green { color: #4ade80; }
      .desc-color-blue { color: #60a5fa; }
      .desc-color-purple { color: #c084fc; }
      .desc-color-slate { color: #94a3b8; }
    }

    /* Formatting toolbar */
    .format-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .format-btn {
      padding: 0.25rem 0.5rem;
      border: 1px solid #cbd5e1;
      border-radius: 0.25rem;
      background: white;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 150ms;
      min-width: 2rem;
      text-align: center;
    }
    .format-btn:hover {
      background: #e0f2fe;
      border-color: #38bdf8;
    }
    .format-btn.active {
      background: #0ea5e9;
      color: white;
      border-color: #0284c7;
    }
    .format-dropdown {
      position: relative;
      display: inline-block;
    }
    .format-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 0.375rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
      margin-top: 0.25rem;
      min-width: 8rem;
    }
    .format-dropdown-menu.show {
      display: block;
    }
    .format-dropdown-item {
      padding: 0.375rem 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 150ms;
      border-bottom: 1px solid #f1f5f9;
    }
    .format-dropdown-item:last-child {
      border-bottom: none;
    }
    .format-dropdown-item:hover {
      background: #e0f2fe;
    }
    .color-swatch {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border-radius: 0.125rem;
      border: 1px solid #cbd5e1;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    /* Dark mode for formatting toolbar */
    @media (prefers-color-scheme: dark) {
      .format-toolbar {
        background: #1e293b;
        border-color: #334155;
      }
      .format-btn {
        background: #0f172a;
        border-color: #475569;
        color: #e5e7eb;
      }
      .format-btn:hover {
        background: #334155;
        border-color: #0ea5e9;
      }
      .format-btn.active {
        background: #0ea5e9;
        color: white;
        border-color: #0284c7;
      }
      .format-dropdown-menu {
        background: #0f172a;
        border-color: #475569;
      }
      .format-dropdown-item {
        color: #e5e7eb;
        border-bottom-color: #334155;
      }
      .format-dropdown-item:hover {
        background: #334155;
      }
    }

    /* Toasts: Slide-in + Sound-ready */
    .toast-stack {
      position: fixed;
      right: 1rem;
      top: 1rem;
      display: grid;
      gap: 0.5rem;
      z-index: 10050;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.75rem;
      min-width: 240px;
      border-radius: 0.5rem;
      background: #ffffff;
      border: 1px solid #e6eef7;
      color: #073047;
      transform: translateX(16px);
      opacity: 0;
      transition: transform 200ms ease, opacity 200ms ease;
      box-shadow: 0 10px 24px rgba(2,132,199,0.08);
      will-change: transform, opacity;
    }
    .toast.show { transform: translateX(0); opacity: 1; }

    /* icon sizing */
    .toast-icon { width: 20px; height: 20px; flex: 0 0 20px; }

    /* variant color tokens */
    .toast.success { background: #f0fdf4; border-color: #bbf7d0; color: #065f46; }
    .toast.info    { background: #eff6ff; border-color: #bae6fd; color: #075985; }
    .toast.warn    { background: #fff7ed; border-color: #fde68a; color: #92400e; }
    .toast.error   { background: #fff1f2; border-color: #fecaca; color: #7f1d1d; }

    /* dismiss button */
    .toast button {
      background: transparent;
      border: none;
      padding: 0.25rem;
      cursor: pointer;
      color: inherit;
      opacity: 0.9;
    }
    .toast button:hover { opacity: 1; background: rgba(0,0,0,0.03); border-radius: 4px; }

    /* Dark theme */
    @media (prefers-color-scheme: dark) {
      .toast {
        background: #0b1220;
        border-color: #1f2937;
        color: #e6eef6;
        box-shadow: 0 10px 24px rgba(14,165,233,0.18);
      }
      .toast.success { background: #052e2b; border-color: #064e3b; color: #bbf7d0; }
      .toast.info    { background: #052335; border-color: #0c4a6e; color: #bae6fd; }
      .toast.warn    { background: #281a05; border-color: #78350f; color: #fde68a; }
      .toast.error   { background: #2b0b0b; border-color: #7f1d1d; color: #fecaca; }
    }
  </style>
</head>
<body class="min-h-screen p-6">

<header class="max-w-7xl mx-auto mb-6 px-2">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0">
    <div class="flex flex-col gap-1 w-full md:w-auto">
      <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">Trident Robotics — Task Board</h1>
      <p class="text-sm text-sky-600 dark:text-sky-400">A page made to track team tasks</p>
    </div>

    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
      <input id="filterInput" placeholder="Search tasks..." class="flex-1 sm:flex-none px-3 py-2 rounded-lg border border-slate-300 shadow-sm text-sm w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />
      <!-- Added data-sound="whoosh" so only the whoosh plays (no default click) -->
      <button id="menuBtn" data-sound="whoosh" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-md font-semibold w-full sm:w-auto shadow-sm">Menu</button>
    </div>
  </div>

  <!-- Add Task section -->
  <div class="mt-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 ring-1 ring-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:ring-slate-900/10">
    <div class="flex flex-col sm:flex-row gap-3 flex-wrap items-start sm:items-center">
      <input id="newTitle" class="flex-1 rounded-md border border-slate-300 px-3 py-2 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Task title..." />
      <input id="newAssign" class="w-full sm:w-44 rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Assignee..." />
      <input id="newDue" type="date" class="w-full sm:w-44 rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />

      <!-- Custom dropdown -->
      <div class="dropdown w-full sm:w-48" id="tagDropdown">
        <div class="dropdown-btn" id="dropdownBtn"><span class="placeholder">Select tags...</span></div>
        <div class="dropdown-list" id="dropdownList">
          <label><input type="checkbox" value="Design" /> <span>Design</span></label>
          <label><input type="checkbox" value="Mechanical" /> <span>Mechanical</span></label>
          <label><input type="checkbox" value="Programming" /> <span>Programming</span></label>
          <label><input type="checkbox" value="Electrical" /> <span>Electrical</span></label>
          <label><input type="checkbox" value="Business" /> <span>Business</span></label>
          <label><input type="checkbox" value="Misc" /> <span>Misc</span></label>
          <!-- Added per request -->
          <label><input type="checkbox" value="Webiste" /> <span>Webiste</span></label>
        </div>
      </div>

      <!-- New: Description with formatting toolbar (supports - [ ] and - [x] checklist lines) -->
      <div class="w-full">
        <div class="format-toolbar" id="newDescToolbar">
          <button class="format-btn" data-format="bold" title="Bold (Ctrl+B)"><b>B</b></button>
          <button class="format-btn" data-format="italic" title="Italic (Ctrl+I)"><i>I</i></button>
          <button class="format-btn" data-format="underline" title="Underline (Ctrl+U)">U̲</button>
          <button class="format-btn" data-format="highlight" title="Highlight">⬛</button>
          
          <div class="format-dropdown">
            <button class="format-btn" data-format="color" title="Text Color">A</button>
            <div class="format-dropdown-menu" id="newDescColorMenu">
              <div class="format-dropdown-item" data-color="red"><span class="color-swatch" style="background-color: #dc2626;"></span>Red</div>
              <div class="format-dropdown-item" data-color="orange"><span class="color-swatch" style="background-color: #ea580c;"></span>Orange</div>
              <div class="format-dropdown-item" data-color="yellow"><span class="color-swatch" style="background-color: #ca8a04;"></span>Yellow</div>
              <div class="format-dropdown-item" data-color="green"><span class="color-swatch" style="background-color: #16a34a;"></span>Green</div>
              <div class="format-dropdown-item" data-color="blue"><span class="color-swatch" style="background-color: #2563eb;"></span>Blue</div>
              <div class="format-dropdown-item" data-color="purple"><span class="color-swatch" style="background-color: #9333ea;"></span>Purple</div>
              <div class="format-dropdown-item" data-color="slate"><span class="color-swatch" style="background-color: #475569;"></span>Slate</div>
            </div>
          </div>
          
          <div class="format-dropdown">
            <button class="format-btn" data-format="size" title="Font Size">Size</button>
            <div class="format-dropdown-menu" id="newDescSizeMenu">
              <div class="format-dropdown-item" data-size="xs">Extra Small</div>
              <div class="format-dropdown-item" data-size="sm">Small</div>
              <div class="format-dropdown-item" data-size="base">Normal</div>
              <div class="format-dropdown-item" data-size="lg">Large</div>
            </div>
          </div>
          
          <span class="text-xs text-slate-500 dark:text-slate-400 ml-2" title="Select text and apply formatting">ℹ️ Select text to format</span>
        </div>
        <textarea id="newDescription" rows="3" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="- [ ] Subtask 1
- [ ] Subtask 2
Notes line without a checkbox"></textarea>
      </div>

      <button id="addTaskBtn" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-md font-semibold w-full sm:w-auto shadow-sm">Add Task</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto">
  <div id="board" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
  <footer class="mt-12 text-center py-4 border-t border-slate-100 dark:border-slate-800 flex flex-col items-center gap-1">
    <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
    <span class="text-sky-600 dark:text-sky-400 text-sm">© 2025 Trident Robotics — Task Board</span>
    <span class="text-xs text-sky-400">Internal team dashboard</span>
  </footer>
</main>

<!-- Toast stack -->
<div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

<!-- Drawer -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-slate-800 dark:text-slate-300">Menu</h2>
      <button id="closeDrawerBtn" class="text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <div>
      <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-3">Trash</h3>
      <div id="trashList" class="space-y-2"></div>
    </div>
    <div>
      <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-3">Archive</h3>
      <div id="archiveList" class="space-y-2"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHGWZI",
  authDomain: "tridenttaskboard.firebaseapp.com",
  projectId: "tridenttaskboard",
  storageBucket: "tridenttaskboard.firebasestorage.appspot.com",
  messagingSenderId: "143400263387",
  appId: "1:143400263387:web:66ed521ae75af588e836fe",
  measurementId: "G-F12DRDCX87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firestoreDB = db;

/* DOM refs */
const board = document.getElementById("board");
const filterInput = document.getElementById("filterInput");
const addBtn = document.getElementById("addTaskBtn");
const menuBtn = document.getElementById("menuBtn");
const drawer = document.getElementById("drawer");
const drawerOverlay = document.getElementById("drawerOverlay");
const closeDrawerBtn = document.getElementById("closeDrawerBtn");

/* Drawer toggle */
menuBtn.onclick = () => {
  drawer.classList.add("open");
  drawerOverlay.classList.add("active");
  // Removed manual Sound.whoosh(); it's now handled by data-sound="whoosh"
  renderDrawer();
};
closeDrawerBtn.onclick = () => { drawer.classList.remove("open"); drawerOverlay.classList.remove("active"); };
drawerOverlay.onclick = () => { drawer.classList.remove("open"); drawerOverlay.classList.remove("active"); };

/* Tag dropdown */
const dropdownBtn = document.getElementById("dropdownBtn");
const dropdownList = document.getElementById("dropdownList");
let selectedTags = [];

/* Due date formatter with coloring */
function formatDueDate(dueStr) {
  if (!dueStr) return '<span class="text-xs text-slate-500 dark:text-slate-400">no due</span>';
  const dueDate = new Date(dueStr + "T23:59:59");
  const now = new Date();
  const diffMs = dueDate - now;
  const diffHours = diffMs / 36e5;
  let cls = "text-xs text-slate-500 dark:text-slate-400";
  if (diffMs < 0) cls = "text-xs due-overdue";
  else if (diffHours <= 24) cls = "text-xs due-soon";
  return `<span class="${cls}">${dueStr}</span>`;
}

/* Dropdown behavior */
dropdownBtn.addEventListener("click", () => {
  dropdownList.style.display = dropdownList.style.display === "block" ? "none" : "block";
});
document.addEventListener("click", e => {
  const root = document.getElementById("tagDropdown");
  if (!root.contains(e.target)) { dropdownList.style.display = "none"; updateDropdownBtn(); }
});
function updateDropdownBtn() {
  dropdownBtn.innerHTML = selectedTags.length ? chipsHTML(selectedTags) : '<span class="placeholder">Select tags...</span>';
}
dropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => {
  cb.addEventListener("change", () => {
    selectedTags = Array.from(dropdownList.querySelectorAll("input:checked")).map(c => c.value);
    updateDropdownBtn();
  });
});

/* Description helpers (Markdown-style checklist with styled HTML support) */
function escHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("'", "&#39;")
    .replaceAll('"', "&quot;")
    .replaceAll("`", "&#96;");
}

/* Sanitize HTML - only allow whitelisted inline tags and classes */
function sanitizeHTML(html) {
  const text = String(html || "");
  // Create a temporary container
  const temp = document.createElement('div');
  temp.innerHTML = text;
  
  // Whitelist: span, b, i, u tags
  const allowedTags = ['SPAN', 'B', 'I', 'U'];
  const allowedClasses = [
    'desc-hl', 'desc-color-red', 'desc-color-orange', 'desc-color-yellow',
    'desc-color-green', 'desc-color-blue', 'desc-color-purple', 'desc-color-slate',
    'desc-underline', 'desc-size-xs', 'desc-size-sm', 'desc-size-base', 'desc-size-lg'
  ];
  
  function sanitizeNode(node) {
    if (node.nodeType === Node.TEXT_NODE) {
      return node.textContent;
    }
    
    if (node.nodeType === Node.ELEMENT_NODE) {
      const tagName = node.tagName.toUpperCase();
      
      // If tag not allowed, just return its text content
      if (!allowedTags.includes(tagName)) {
        return Array.from(node.childNodes).map(sanitizeNode).join('');
      }
      
      // Filter classes to only allowed ones
      const classList = Array.from(node.classList || []).filter(cls => allowedClasses.includes(cls));
      const classAttr = classList.length > 0 ? ` class="${classList.join(' ')}"` : '';
      
      // Recursively sanitize children
      const content = Array.from(node.childNodes).map(sanitizeNode).join('');
      
      return `<${tagName.toLowerCase()}${classAttr}>${content}</${tagName.toLowerCase()}>`;
    }
    
    return '';
  }
  
  return Array.from(temp.childNodes).map(sanitizeNode).join('');
}

function renderDescriptionHTML(desc, taskId) {
  const text = String(desc || "");
  if (!text.trim()) return "";
  const lines = text.split(/\r?\n/);
  return lines.map((line, idx) => {
    const m = line.match(/^\s*-\s*\[([ xX])\]\s*(.*)$/);
    if (m) {
      const checked = m[1].toLowerCase() === "x";
      const item = m[2] || "";
      // Sanitize the item content to allow styled HTML
      const sanitizedItem = sanitizeHTML(item);
      return `
        <label class="flex items-start gap-2 py-0.5 select-none cursor-pointer">
          <input type="checkbox" class="desc-checkbox mt-0.5"
            data-task-id="${escHtml(taskId)}" data-line-index="${idx}" ${checked ? "checked" : ""} />
          <span class="leading-tight whitespace-pre-wrap break-words">${sanitizedItem}</span>
        </label>
      `;
    }
    // For non-checklist lines, also sanitize to support styled HTML
    const sanitizedLine = sanitizeHTML(line);
    return `<div class="leading-tight py-0.5 whitespace-pre-wrap break-words">${sanitizedLine}</div>`;
  }).join("");
}
function toggleChecklistLine(desc, lineIndex) {
  const lines = String(desc || "").split(/\r?\n/);
  if (lineIndex < 0 || lineIndex >= lines.length) return desc;
  const line = lines[lineIndex];
  const m = line.match(/^(\s*-\s*\[)([ xX])(\]\s*)(.*)$/);
  if (!m) return desc;
  const newMark = m[2].toLowerCase() === "x" ? " " : "x";
  lines[lineIndex] = `${m[1]}${newMark}${m[3]}${m[4]}`;
  return lines.join("\n");
}

/* Data loading */
async function loadTasks() {
  const snapshot = await getDocs(collection(db, "tasks"));
  const data = {
    columns: {
      backlog: { title: "Backlog", tasks: [] },
      todo: { title: "To Do", tasks: [] },
      inprogress: { title: "In Progress", tasks: [] },
      done: { title: "Done", tasks: [] }
    },
    order: ["backlog", "todo", "inprogress", "done"]
  };

  snapshot.forEach(docSnap => {
    const t = docSnap.data();
    if (t.deleted || t.archived) return; // hide from board
    const col = t.column || "backlog";
    (data.columns[col] ??= { title: col, tasks: [] }).tasks.push({ id: docSnap.id, ...t });
  });

  await checkAutoArchive(data);
  return data;
}

/* Auto-archive done > 7 days */
async function checkAutoArchive(data) {
  const now = Date.now();
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  const batch = writeBatch(db);
  let needsUpdate = false;

  for (const task of (data.columns.done?.tasks || [])) {
    if (task.completedAt && (now - task.completedAt) > sevenDays && !task.archived) {
      batch.update(doc(db, "tasks", task.id), { archived: true, archivedAt: now });
      needsUpdate = true;
    }
  }
  if (needsUpdate) await batch.commit();
}

/* Save task (safe payload) */
async function saveTask(task, col) {
  const payload = {
    id: task.id,
    title: task.title || "",
    assignee: task.assignee || "Unassigned",
    due: task.due || "",
    tags: Array.isArray(task.tags) ? task.tags : [],
    order: typeof task.order === "number" ? task.order : 0,
    column: col,
    description: task.description || ""
  };
  if (Array.isArray(task.comments) && task.comments.length > 0) payload.comments = task.comments;
  await setDoc(doc(db, "tasks", task.id), payload, { merge: true });
}

async function deleteTaskFirestore(taskId) { await deleteDoc(doc(db, "tasks", taskId)); }

/* Render board */
async function renderBoard() {
  const data = await loadTasks();
  board.innerHTML = "";
  data.order.forEach(colId => {
    const col = data.columns[colId];
    const colEl = document.createElement("section");
    colEl.className = "column-section";
    colEl.innerHTML = `
      <div class="column-header">
        <h2 class="text-base font-semibold text-slate-700 dark:text-slate-200">${col.title}</h2>
        <div class="column-count">${col.tasks.length}</div>
      </div>
      <div class="task-list min-h-[120px] space-y-3" data-col="${colId}"></div>
    `;
    board.appendChild(colEl);

    const list = colEl.querySelector(".task-list");
    col.tasks
      .filter(t => {
        const f = (filterInput.value || "").toLowerCase();
        return !f
          || (t.title || "").toLowerCase().includes(f)
          || (t.assignee || "").toLowerCase().includes(f)
          || (t.description || "").toLowerCase().includes(f)
          || (t.tags || []).some(tag => tag.toLowerCase().includes(f));
      })
      .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
      .forEach(task => list.appendChild(createTaskEl(task, colId)));

    makeDroppable(list);
  });
}

/* Create Task Card */
function createTaskEl(task, colId) {
  const div = document.createElement("div");
  div.className = "task-card";
  div.draggable = true;
  div.dataset.id = task.id;
  div.dataset.col = colId;

  const assignee = task.assignee || "Unassigned";
  const descHtml = renderDescriptionHTML(task.description || "", task.id);

  div.innerHTML = `
    <div class="flex items-start justify-between gap-2">
      <div>
        <h3 class="font-medium text-slate-800 dark:text-slate-200">${task.title}</h3>
        <div class="text-xs text-slate-500 dark:text-slate-400">${assignee} • ${formatDueDate(task.due || "")}</div>
      </div>
      <div class="flex gap-2 shrink-0">
        <button class="text-xs px-2 py-1 border border-slate-300 rounded-md hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 edit-btn">Edit</button>
        <button class="text-xs px-2 py-1 border border-red-200 rounded-md text-red-600 hover:bg-red-50 dark:border-red-900 dark:text-red-400 dark:hover:bg-red-950 del-btn">Delete</button>
      </div>
    </div>

    <div class="mt-2 flex gap-2 flex-wrap">
      ${(task.tags || []).map(t => `<span class="tag-chip">${t}</span>`).join("")}
    </div>

    ${descHtml ? `
      <div class="mt-3 border border-slate-100 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900" data-role="description">
        ${descHtml}
      </div>
    ` : ""}

    <div class="mt-3">
      <button class="text-xs text-sky-600 dark:text-sky-400 underline toggle-comments">Show Notes</button>
      <div class="comments-section hidden mt-2 border-t border-slate-100 dark:border-slate-800 pt-2 space-y-2">
        <div class="comments-list text-sm text-slate-800 dark:text-slate-200">
          ${(task.comments || []).map((c, idx) => {
            const dateStr = c.timestamp
              ? new Date(c.timestamp).toLocaleString([], { month: "short", day: "numeric", year: "numeric", hour: "2-digit", minute: "2-digit" })
              : "";
            const authorStr = c.author || "Anonymous";
            const safeText = c.text || "";
            const textHtml = safeText ? `<span class="block">${safeText}</span>` : "";
            return `
              <div class="border border-slate-100 dark:border-slate-800 rounded-md p-2 bg-slate-50 dark:bg-slate-900 comment-item" data-ts="${c.timestamp || ''}" data-idx="${idx}">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    ${textHtml}
                    <span class="text-xs text-slate-400">${authorStr} • ${dateStr}</span>
                  </div>
                  <div class="flex items-center gap-1 shrink-0">
                    <button class="comment-edit p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Edit">
                      <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11 5h2m-9 9l2 2 12-12a2.121 2.121 0 10-3-3L3 13l-1 4 4-1z" />
                      </svg>
                    </button>
                    <button class="comment-delete p-1 rounded hover:bg-red-50 dark:hover:bg-red-950" title="Delete">
                      <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
        <div class="flex gap-2 mt-2">
          <input type="text" placeholder="Add note..."
            class="comment-input flex-1 border border-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-200 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200" />
          <button class="add-comment px-2 py-1 bg-sky-600 text-white rounded-md text-xs hover:bg-sky-700">Add</button>
        </div>
      </div>
    </div>
  `;

  /* Delete (soft) */
  div.querySelector(".del-btn").onclick = async () => {
    if (!confirm(`Delete "${task.title}"?`)) return;
    div.classList.add("transition", "duration-300", "opacity-0", "translate-x-4");
    setTimeout(async () => {
      await setDoc(doc(db, "tasks", task.id), {
        deleted: true,
        deletedAt: Date.now(),
        deletedBy: getCurrentUserName()
      }, { merge: true });
      div.remove();
      renderBoard();
    }, 300);
  };

  /* Edit task */
  div.querySelector(".edit-btn").onclick = () => openEditModal(task, colId);

  /* Toggle comments visibility */
  div.querySelector(".toggle-comments").onclick = (e) => {
    const section = div.querySelector(".comments-section");
    const isHidden = section.classList.toggle("hidden");
    e.target.textContent = isHidden ? "Show Notes" : "Hide Notes";
  };

  /* Add comment (text-only) */
  div.querySelector(".add-comment").onclick = async () => {
    const input = div.querySelector(".comment-input");
    const text = (input.value || "").trim();
    if (!text) return;

    const button = div.querySelector(".add-comment");
    button.disabled = true;
    const originalLabel = button.textContent;
    button.textContent = "Adding...";

    try {
      const newComment = { timestamp: Date.now(), author: getCurrentUserName(), text };
      const updatedComments = [ ...(task.comments || []), newComment ];
      await setDoc(doc(db, "tasks", task.id), { comments: updatedComments }, { merge: true });

      task.comments = updatedComments;
      input.value = "";
      renderBoard();
    } catch (err) {
      console.error("Failed to add comment:", err);
      alert(`Failed to add comment: ${err.message || err}`);
    } finally {
      button.disabled = false;
      button.textContent = originalLabel || "Add";
    }
  };

  /* Edit an existing comment (pencil icon) */
  div.querySelectorAll(".comment-edit").forEach(btn => {
    btn.onclick = async () => {
      const container = btn.closest(".comment-item");
      if (!container) return;
      const ts = parseInt(container.dataset.ts || "0", 10);
      const idx = parseInt(container.dataset.idx || "-1", 10);

      let existing = null;
      if (ts) existing = (task.comments || []).find(c => c.timestamp === ts);
      if (!existing && idx >= 0) existing = (task.comments || [])[idx];

      const newText = prompt("Edit note:", existing?.text || "");
      if (newText === null) return; // cancel
      const trimmed = newText.trim();
      if (!trimmed) return;

      const updated = (task.comments || []).map((c, i) =>
        (ts ? c.timestamp === ts : i === idx) ? { ...c, text: trimmed } : c
      );

      try {
        await setDoc(doc(db, "tasks", task.id), { comments: updated }, { merge: true });
        task.comments = updated;
        renderBoard();
      } catch (err) {
        console.error("Failed to edit comment:", err);
        alert(`Failed to edit comment: ${err.message || err}`);
      }
    };
  });

  /* Delete an existing comment (red X) */
  div.querySelectorAll(".comment-delete").forEach(btn => {
    btn.onclick = async () => {
      const container = btn.closest(".comment-item");
      if (!container) return;
      const ts = parseInt(container.dataset.ts || "0", 10);
      const idx = parseInt(container.dataset.idx || "-1", 10);

      if (!confirm("Delete this note?")) return;

      const updated = (task.comments || []).filter((c, i) => ts ? c.timestamp !== ts : i !== idx);

      try {
        await setDoc(doc(db, "tasks", task.id), { comments: updated }, { merge: true });
        task.comments = updated;
        renderBoard();
      } catch (err) {
        console.error("Failed to delete comment:", err);
        alert(`Failed to delete comment: ${err.message || err}`);
      }
    };
  });

  /* Description checkbox toggles (event delegation within card) */
  div.addEventListener("change", async (e) => {
    const cb = e.target.closest(".desc-checkbox");
    if (!cb) return;
    const lineIndex = parseInt(cb.getAttribute("data-line-index"), 10);
    if (Number.isNaN(lineIndex)) return;

    const newDesc = toggleChecklistLine(task.description || "", lineIndex);
    try {
      await setDoc(doc(db, "tasks", task.id), { description: newDesc }, { merge: true });
      task.description = newDesc;
      const container = div.querySelector('[data-role="description"]');
      if (container) container.innerHTML = renderDescriptionHTML(newDesc, task.id);
    } catch (err) {
      console.error("Failed to update description:", err);
      alert(`Failed to update description: ${err.message || err}`);
      cb.checked = !cb.checked;
    }
  });

  makeDraggable(div);
  return div;
}

/* Edit modal */
function openEditModal(task, colId) {
  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black/30 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-xl w-80 space-y-3 border border-slate-200 ring-1 ring-slate-100 modal-panel dark:bg-slate-900 dark:border-slate-800">
      <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-2">Edit Task</h3>
      <input id="editTitle" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Title" />
      <input id="editAssign" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="Assignee" />
      <input id="editDue" type="date" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" />

      <!-- New: Description editor with formatting toolbar -->
      <label class="block text-sm text-slate-600 dark:text-slate-300 mt-1">Description</label>
      <div class="format-toolbar" id="editDescToolbar">
        <button class="format-btn" data-format="bold" title="Bold (Ctrl+B)"><b>B</b></button>
        <button class="format-btn" data-format="italic" title="Italic (Ctrl+I)"><i>I</i></button>
        <button class="format-btn" data-format="underline" title="Underline (Ctrl+U)">U̲</button>
        <button class="format-btn" data-format="highlight" title="Highlight">⬛</button>
        
        <div class="format-dropdown">
          <button class="format-btn" data-format="color" title="Text Color">A</button>
          <div class="format-dropdown-menu" id="editDescColorMenu">
            <div class="format-dropdown-item" data-color="red"><span class="color-swatch" style="background-color: #dc2626;"></span>Red</div>
            <div class="format-dropdown-item" data-color="orange"><span class="color-swatch" style="background-color: #ea580c;"></span>Orange</div>
            <div class="format-dropdown-item" data-color="yellow"><span class="color-swatch" style="background-color: #ca8a04;"></span>Yellow</div>
            <div class="format-dropdown-item" data-color="green"><span class="color-swatch" style="background-color: #16a34a;"></span>Green</div>
            <div class="format-dropdown-item" data-color="blue"><span class="color-swatch" style="background-color: #2563eb;"></span>Blue</div>
            <div class="format-dropdown-item" data-color="purple"><span class="color-swatch" style="background-color: #9333ea;"></span>Purple</div>
            <div class="format-dropdown-item" data-color="slate"><span class="color-swatch" style="background-color: #475569;"></span>Slate</div>
          </div>
        </div>
        
        <div class="format-dropdown">
          <button class="format-btn" data-format="size" title="Font Size">Size</button>
          <div class="format-dropdown-menu" id="editDescSizeMenu">
            <div class="format-dropdown-item" data-size="xs">Extra Small</div>
            <div class="format-dropdown-item" data-size="sm">Small</div>
            <div class="format-dropdown-item" data-size="base">Normal</div>
            <div class="format-dropdown-item" data-size="lg">Large</div>
          </div>
        </div>
        
        <span class="text-xs text-slate-500 dark:text-slate-400 ml-2" title="Select text and apply formatting">ℹ️ Select text to format</span>
      </div>
      <textarea id="editDescription" rows="6" class="w-full rounded-md border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200 text-sm dark:bg-slate-950 dark:border-slate-700 dark:text-slate-200" placeholder="- [ ] Subtask 1
- [x] Completed item
Free-form notes line"></textarea>

      <div class="dropdown mt-2" id="editTagDropdown">
        <div class="dropdown-btn" id="editDropdownBtn"><span class="placeholder">Select tags...</span></div>
        <div class="dropdown-list" id="editDropdownList">
          <label><input type="checkbox" value="Design" /> <span>Design</span></label>
          <label><input type="checkbox" value="Mechanical" /> <span>Mechanical</span></label>
          <label><input type="checkbox" value="Programming" /> <span>Programming</span></label>
          <label><input type="checkbox" value="Electrical" /> <span>Electrical</span></label>
          <label><input type="checkbox" value="Business" /> <span>Business</span></label>
          <label><input type="checkbox" value="Misc" /> <span>Misc</span></label>
          <!-- Added per request -->
          <label><input type="checkbox" value="Webiste" /> <span>Webiste</span></label>
        </div>
      </div>

      <div class="flex gap-2 pt-2">
        <button id="saveEdit" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700">Save</button>
        <button id="cancelEdit" class="px-3 py-1 border border-slate-300 rounded-md text-sm hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector("#editTitle").value = task.title || "";
  modal.querySelector("#editAssign").value = task.assignee || "";
  modal.querySelector("#editDue").value = task.due || "";
  modal.querySelector("#editDescription").value = task.description || "";

  let editSelectedTags = Array.isArray(task.tags) ? task.tags.slice() : [];
  const editDropdownBtn = modal.querySelector("#editDropdownBtn");
  const editDropdownList = modal.querySelector("#editDropdownList");

  function updateEditDropdownBtn() {
    editDropdownBtn.innerHTML = editSelectedTags.length ? chipsHTML(editSelectedTags) : '<span class="placeholder">Select tags...</span>';
  }

  editDropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => {
    cb.checked = editSelectedTags.includes(cb.value);
    cb.addEventListener("change", () => {
      editSelectedTags = Array.from(editDropdownList.querySelectorAll("input:checked")).map(c => c.value);
      updateEditDropdownBtn();
    });
  });

  editDropdownBtn.addEventListener("click", () => {
    editDropdownList.style.display = editDropdownList.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", e => { if (!modal.contains(e.target)) editDropdownList.style.display = "none"; });

  updateEditDropdownBtn();

  modal.querySelector("#cancelEdit").onclick = () => modal.remove();
  modal.querySelector("#saveEdit").onclick = async () => {
    try {
      task.title = (modal.querySelector("#editTitle").value || "").trim();
      task.assignee = (modal.querySelector("#editAssign").value || "Unassigned").trim() || "Unassigned";
      task.due = modal.querySelector("#editDue").value || "";
      task.description = modal.querySelector("#editDescription").value || "";
      task.tags = editSelectedTags.slice();

      await saveTask(task, colId);

      showToast('success', 'Task saved!');
      modal.remove();
      renderBoard();
    } catch (err) {
      console.error("Failed to save task:", err);
      showToast('error', `Failed to save task: ${err?.message || err}`);
    }
  };
}

/* Drag and drop */
function makeDraggable(taskEl) {
  taskEl.addEventListener("dragstart", e => {
    taskEl.classList.add("dragging");
    e.dataTransfer.setData("text/plain", JSON.stringify({ id: taskEl.dataset.id, from: taskEl.dataset.col }));
  });

  taskEl.addEventListener("dragend", async () => {
    taskEl.classList.remove("dragging");

    const parentCol = taskEl.closest(".task-list");
    if (!parentCol) return;

    const siblings = [...parentCol.querySelectorAll("[data-id]")];
    const batch = writeBatch(db);

    for (let i = 0; i < siblings.length; i++) {
      const id = siblings[i].dataset.id;
      batch.update(doc(db, "tasks", id), { order: i, column: parentCol.dataset.col });
    }
    await batch.commit();
  });
}

function makeDroppable(el) {
  el.addEventListener("dragover", e => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    if (!dragging) return;

    const afterElement = getDragAfterElement(el, e.clientY);
    if (afterElement && afterElement instanceof Node) {
      el.insertBefore(dragging, afterElement);
    } else {
      el.appendChild(dragging);
    }
  });
  el.addEventListener("dragenter", () => el.classList.add("droppable-hover"));
  el.addEventListener("dragleave", () => el.classList.remove("droppable-hover"));
  el.addEventListener("drop", async e => {
    e.preventDefault();
    el.classList.remove("droppable-hover");

    const data = e.dataTransfer.getData("text/plain");
    if (!data) return;

    const { id, from } = JSON.parse(data);
    const to = el.dataset.col;
    const taskDocRef = doc(db, "tasks", id);
    const taskSnap = await getDoc(taskDocRef);
    if (!taskSnap.exists()) return;

    const taskData = taskSnap.data();
    const updates = { column: to };
    if (to === "done" && !taskData.completedAt) {
      updates.completedAt = Date.now();
    } else if (from === "done" && to !== "done") {
      updates.completedAt = null;
    }

    await setDoc(taskDocRef, updates, { merge: true });

    const taskEls = [...el.querySelectorAll("[data-id]")];
    const batch = writeBatch(db);
    for (let i = 0; i < taskEls.length; i++) {
      const tId = taskEls[i].dataset.id;
      batch.update(doc(db, "tasks", tId), { order: i, column: to });
    }
    await batch.commit();

    await renderBoard();
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll(".task-card:not(.dragging)")];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/* Add Task */
addBtn.onclick = async () => {
  const title = (document.getElementById("newTitle").value || "").trim();
  if (!title) return;

  const assign = document.getElementById("newAssign").value || "Unassigned";
  const due    = document.getElementById("newDue").value || "";
  const description = document.getElementById("newDescription").value || "";

  addBtn.disabled = true;
  const originalAddLabel = addBtn.textContent;
  addBtn.textContent = "Adding...";

  try {
    const snapshot = await getDocs(collection(db, "tasks"));
    const count = snapshot.size;
    const task = {
      title,
      assignee: assign,
      due,
      description,
      tags: selectedTags.slice(),
      column: "backlog",
      order: count
    };

    await addDoc(collection(db, "tasks"), task);

    document.getElementById("newTitle").value = "";
    document.getElementById("newAssign").value = "";
    document.getElementById("newDue").value = "";
    document.getElementById("newDescription").value = "";
    selectedTags = [];
    document.querySelectorAll("#dropdownList input[type=checkbox]").forEach(cb => cb.checked = false);
    updateDropdownBtn();

    await renderBoard();

    showToast('success', 'Task added successfully!');
  } catch (err) {
    console.error("Failed to add task:", err);
    showToast('error', `Failed to add task: ${err?.message || err}`);
  } finally {
    addBtn.disabled = false;
    addBtn.textContent = originalAddLabel || "Add Task";
  }
};

/* Drawer (Trash & Archive) */
async function renderDrawer() {
  const snapshot = await getDocs(collection(db, "tasks"));
  const trashTasks = [];
  const archiveTasks = [];

  snapshot.forEach(docSnap => {
    const t = { id: docSnap.id, ...docSnap.data() };
    if (t.deleted) trashTasks.push(t);
    if (t.archived) archiveTasks.push(t);
  });

  // Trash
  const trashList = document.getElementById("trashList");
  trashList.innerHTML = trashTasks
    .sort((a, b) => (b.deletedAt || 0) - (a.deletedAt || 0))
    .map(t => `
      <div class="p-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-900">
        <div class="font-medium text-slate-800 dark:text-slate-200">${t.title}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">${t.assignee || "Unassigned"} • ${formatDueDate(t.due || "")}</div>
        <div class="text-xs text-slate-400 mt-1">Deleted by ${t.deletedBy || "Unknown"}</div>
        <div class="flex gap-2 mt-2">
          <button data-id="${t.id}" class="restore-btn text-xs px-2 py-1 bg-sky-600 text-white rounded-md hover:bg-sky-700">Restore</button>
          <button data-id="${t.id}" class="permadelete-btn text-xs px-2 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">Permanently Delete</button>
        </div>
      </div>
    `).join("") || '<div class="text-sm text-slate-500 dark:text-slate-400">No items in trash</div>';

  // Archive
  const archiveList = document.getElementById("archiveList");
  archiveList.innerHTML = archiveTasks
    .sort((a, b) => (b.archivedAt || 0) - (a.archivedAt || 0))
    .map(t => `
      <div class="p-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-900">
        <div class="font-medium text-slate-800 dark:text-slate-200">${t.title}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">${t.assignee || "Unassigned"}</div>
        <div class="text-xs text-slate-400 mt-1">Completed: ${t.completedAt ? new Date(t.completedAt).toLocaleDateString() : "N/A"}</div>
        <div class="text-xs text-slate-400">Archived: ${t.archivedAt ? new Date(t.archivedAt).toLocaleDateString() : "N/A"}</div>
        <div class="flex gap-2 mt-2">
          <button data-id="${t.id}" class="unarchive-btn text-xs px-2 py-1 bg-sky-600 text-white rounded-md hover:bg-sky-700">Unarchive</button>
          <button data-id="${t.id}" class="permadelete-btn text-xs px-2 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">Permanently Delete</button>
        </div>
      </div>
    `).join("") || '<div class="text-sm text-slate-500 dark:text-slate-400">No items in archive</div>';

  // Wire actions
  trashList.querySelectorAll(".restore-btn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-id");
      await setDoc(doc(db, "tasks", id), { deleted: false, deletedAt: null, deletedBy: null }, { merge: true });
      await renderBoard(); await renderDrawer();
    };
  });
  [...trashList.querySelectorAll(".permadelete-btn"), ...archiveList.querySelectorAll(".permadelete-btn")].forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-id");
      if (!confirm("Permanently delete this task? This cannot be undone.")) return;
      await deleteTaskFirestore(id);
      await renderDrawer();
    };
  });
  archiveList.querySelectorAll(".unarchive-btn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-id");
      await setDoc(doc(db, "tasks", id), { archived: false, archivedAt: null, column: "backlog" }, { merge: true });
      await renderBoard(); await renderDrawer();
    };
  });
}

/* Filter */
filterInput.oninput = () => { renderBoard(); };

    /* Chips util */
    function chipsHTML(tags) {
      return (tags || []).map(t => `<span class="tag-chip">${t}</span>`).join("");
    }
    function getCurrentUserName() {
      return localStorage.getItem('trident.fullname') || 'Anonymous';
    }

    /* Column canonicalization */
    function canonicalizeColumn(raw) {
      const s = String(raw || '').trim().toLowerCase();
      if (!s) return 'backlog';
      // remove spaces/dashes for mapping
      const compact = s.replace(/[\s-]+/g, '');
      switch (compact) {
        case 'backlog': return 'backlog';
        case 'todo':
        case 'todolist':
        case 'to':
        case 'todo:': return 'todo';
        case 'inprogress':
        case 'inprog':
        case 'progress':
        case 'working':
        case 'doing': return 'inprogress';
        case 'done':
        case 'complete':
        case 'completed': return 'done';
        default: return s; // fallback (will render if added to order dynamically)
      }
    }

    /* Override loadTasks to normalize columns */
    const _originalLoadTasks = loadTasks;
    loadTasks = async function() {
      const snapshot = await getDocs(collection(db, "tasks"));
      console.log('[TaskBoard] Snapshot size:', snapshot.size);
      const data = {
        columns: {
          backlog: { title: "Backlog", tasks: [] },
          todo: { title: "To Do", tasks: [] },
          inprogress: { title: "In Progress", tasks: [] },
          done: { title: "Done", tasks: [] }
        },
        order: ["backlog", "todo", "inprogress", "done"]
      };
      snapshot.forEach(docSnap => {
        const t = docSnap.data();
        if (t.deleted || t.archived) return;
        const normalized = canonicalizeColumn(t.column || 'backlog');
        console.log('[TaskBoard] Doc', docSnap.id, 'raw column:', t.column, 'normalized:', normalized);
        (data.columns[normalized] ??= { title: normalized, tasks: [] })
          .tasks.push({ id: docSnap.id, ...t, column: normalized });
      });
      await checkAutoArchive(data);
      return data;
    };

    /* Optional one-time migration to fix column values in Firestore */
    async function fixColumns() {
      const snapshot = await getDocs(collection(db, "tasks"));
      const batch = writeBatch(db);
      let changed = 0;
      snapshot.forEach(docSnap => {
        const t = docSnap.data();
        const canonical = canonicalizeColumn(t.column || 'backlog');
        if (canonical !== t.column) {
          batch.update(doc(db, "tasks", docSnap.id), { column: canonical });
          changed++;
        }
      });
      if (changed) {
        await batch.commit();
        console.log(`[TaskBoard] Column migration updated ${changed} task(s).`);
      } else {
        console.log('[TaskBoard] Column migration: nothing to change.');
      }
    }

    /* Enhance renderBoard to show empty state per column */
    const _renderBoardOriginal = renderBoard;
    renderBoard = async function() {
      await _renderBoardOriginal();
      document.querySelectorAll(".task-list").forEach(list => {
        if (!list.children.length) {
          list.innerHTML = `<div class="p-3 text-xs rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400">
            No tasks
          </div>`;
        }
      });
    };

    /* Bootstrap */
    async function bootstrap() {
      try {
        // Uncomment next line ONCE if you need to normalize existing column values:
        // await fixColumns();

        await renderBoard();

        // Ensure tag dropdown starts hidden
        const dropdownList = document.getElementById("dropdownList");
        if (dropdownList) dropdownList.style.display = "none";

        console.log('[TaskBoard] Bootstrap complete');
      } catch (e) {
        console.error('Bootstrap failed:', e);
        const board = document.getElementById("board");
        if (board) {
          board.innerHTML = `<div class="col-span-4 p-6 border border-red-200 bg-red-50 rounded-xl text-red-700 text-sm">
            Failed to load tasks: ${e.message || e}
          </div>`;
        }
        if (typeof showToast === 'function') {
          showToast('error', `Load failed: ${e.message || e}`);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
    if (document.readyState === 'interactive' || document.readyState === 'complete') {
      // DOM already ready if script injected late
      bootstrap();
    }

    /* Setup edit modal toolbar - use global function when modal opens */
    const _originalOpenEditModal = openEditModal;
    openEditModal = function(task, colId) {
      _originalOpenEditModal(task, colId);
      // Setup toolbar after modal is created - use global function
      setTimeout(() => {
        if (typeof window.setupFormattingToolbar === 'function') {
          window.setupFormattingToolbar('editDescToolbar', 'editDescription');
        }
        if (typeof window.addKeyboardShortcuts === 'function') {
          const editDesc = document.getElementById('editDescription');
          if (editDesc) window.addKeyboardShortcuts(editDesc);
        }
      }, 100);
    };

</script>

<!-- Formatting Toolbar Script (standalone, not requiring Firebase) -->
<script>
(function() {
  'use strict';
  
  /* ========== Formatting Toolbar Functionality ========== */
  
  // Setup formatting toolbar for a textarea
  function setupFormattingToolbar(toolbarId, textareaId) {
    const toolbar = document.getElementById(toolbarId);
    const textarea = document.getElementById(textareaId);
    if (!toolbar || !textarea) {
      console.warn('Toolbar or textarea not found:', toolbarId, textareaId);
      return;
    }
    
    console.log('Setting up formatting toolbar:', toolbarId, 'for', textareaId);
    
    // Handle dropdown menus
    toolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('.format-btn');
      if (!btn) return;
      
      const format = btn.getAttribute('data-format');
      
      // Toggle dropdowns
      if (format === 'color' || format === 'size') {
        e.stopPropagation();
        const dropdown = btn.closest('.format-dropdown');
        const menu = dropdown.querySelector('.format-dropdown-menu');
        const wasOpen = menu.classList.contains('show');
        
        // Close all other dropdowns
        toolbar.querySelectorAll('.format-dropdown-menu').forEach(m => m.classList.remove('show'));
        
        if (!wasOpen) {
          menu.classList.add('show');
        }
        return;
      }
      
      // Apply formatting
      if (['bold', 'italic', 'underline', 'highlight'].includes(format)) {
        applyFormatting(textarea, format);
      }
    });
    
    // Handle color selection
    const colorMenus = toolbar.querySelectorAll('[id$="ColorMenu"]');
    colorMenus.forEach(menu => {
      menu.addEventListener('click', (e) => {
        const item = e.target.closest('.format-dropdown-item');
        if (!item) return;
        const color = item.getAttribute('data-color');
        if (color) {
          applyFormatting(textarea, 'color', color);
          menu.classList.remove('show');
        }
      });
    });
    
    // Handle size selection
    const sizeMenus = toolbar.querySelectorAll('[id$="SizeMenu"]');
    sizeMenus.forEach(menu => {
      menu.addEventListener('click', (e) => {
        const item = e.target.closest('.format-dropdown-item');
        if (!item) return;
        const size = item.getAttribute('data-size');
        if (size) {
          applyFormatting(textarea, 'size', size);
          menu.classList.remove('show');
        }
      });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!toolbar.contains(e.target)) {
        toolbar.querySelectorAll('.format-dropdown-menu').forEach(m => m.classList.remove('show'));
      }
    });
  }
  
  // Apply formatting to selected text in textarea
  function applyFormatting(textarea, format, value) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    if (start === end) {
      if (typeof showToast === 'function') {
        showToast('info', 'Please select text to format');
      } else {
        alert('Please select text to format');
      }
      return;
    }
    
    const selectedText = text.substring(start, end);
    let wrappedText = '';
    
    switch (format) {
      case 'bold':
        wrappedText = `<b>${selectedText}</b>`;
        break;
      case 'italic':
        wrappedText = `<i>${selectedText}</i>`;
        break;
      case 'underline':
        wrappedText = `<u class="desc-underline">${selectedText}</u>`;
        break;
      case 'highlight':
        wrappedText = `<span class="desc-hl">${selectedText}</span>`;
        break;
      case 'color':
        wrappedText = `<span class="desc-color-${value}">${selectedText}</span>`;
        break;
      case 'size':
        wrappedText = `<span class="desc-size-${value}">${selectedText}</span>`;
        break;
      default:
        return;
    }
    
    textarea.value = text.substring(0, start) + wrappedText + text.substring(end);
    
    // Restore selection after the formatted text
    const newEnd = start + wrappedText.length;
    textarea.setSelectionRange(newEnd, newEnd);
    textarea.focus();
    
    console.log('Applied formatting:', format, value, 'Result:', wrappedText);
  }
  
  // Add keyboard shortcuts for formatting
  function addKeyboardShortcuts(textarea) {
    textarea.addEventListener('keydown', (e) => {
      // Check for Ctrl/Cmd key combinations
      if (e.ctrlKey || e.metaKey) {
        let format = null;
        
        switch(e.key.toLowerCase()) {
          case 'b':
            format = 'bold';
            break;
          case 'i':
            format = 'italic';
            break;
          case 'u':
            format = 'underline';
            break;
        }
        
        if (format) {
          e.preventDefault(); // Prevent default browser behavior
          applyFormatting(textarea, format);
        }
      }
    });
  }
  
  // Setup formatting toolbars on page load
  function initFormattingToolbars() {
    console.log('Initializing formatting toolbars...');
    // New task description toolbar
    setupFormattingToolbar('newDescToolbar', 'newDescription');
    
    // Add keyboard shortcuts to new description textarea
    const newDesc = document.getElementById('newDescription');
    if (newDesc) addKeyboardShortcuts(newDesc);
  }
  
  // Expose to global scope for edit modal
  window.setupFormattingToolbar = setupFormattingToolbar;
  window.addKeyboardShortcuts = addKeyboardShortcuts;
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFormattingToolbars);
  } else {
    initFormattingToolbars();
  }
})();
</script>

<script src="/assets/js/sound.js" defer></script>
<script src="/assets/js/toast.js" defer></script>
</body>
</html>
