<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trident Robotics — Task Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, sans-serif; }
    .dragging { opacity: 0.5; transform: scale(1.05); }
    .droppable-hover { background-color: #e0f2fe !important; }
    .dropdown { position: relative; width: 10rem; }
    .dropdown-btn { width: 100%; border: 1px solid #cfe3f5; border-radius: 0.375rem; padding: 0.5rem; background: white; cursor: pointer; text-align: left; }
    .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid #cfe3f5; border-radius: 0.375rem; background: white; max-height: 200px; overflow-y: auto; display: none; z-index: 10; }
    .dropdown-list label { display: flex; align-items: center; padding: 0.25rem 0.5rem; cursor: pointer; }
    .dropdown-list label:hover { background-color: #e0f2fe; }
    .tag-chip { display: inline-block; background: #bae6fd; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; margin-right: 0.25rem; margin-bottom: 0.25rem; font-size: 0.75rem; }
  </style>
</head>
<body class="min-h-screen p-6">

<header class="max-w-6xl mx-auto mb-6 px-2">
  <!-- Top header: title and filter -->
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0">
    <!-- Title & subtitle -->
    <div class="flex flex-col gap-1 w-full md:w-auto">
      <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug">
        Trident Robotics — Task Board
      </h1>
      <p class="text-sm text-sky-600">A page made to track team tasks</p>
    </div>

    <!-- Filter input and theme text -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
      <input id="filterInput" placeholder="Search or filter by assignee..."
        class="flex-1 sm:flex-none px-3 py-2 rounded-lg border border-sky-200 shadow-sm text-sm w-full sm:w-64" />
    </div>
  </div>

  <!-- Add Task section -->
  <div class="mt-4 bg-white p-4 rounded-2xl shadow-sm border border-sky-100">
    <div class="flex flex-col sm:flex-row gap-3 flex-wrap items-start sm:items-center">
      <input id="newTitle" class="flex-1 rounded-md border border-sky-200 px-3 py-2 w-full sm:w-auto"
        placeholder="Task title (e.g. prototype the intake)" />
      <input id="newAssignee" class="w-full sm:w-40 rounded-md border border-sky-200 px-3 py-2"
        placeholder="Assignee" />
      <input id="newDue" type="date" class="w-full sm:w-40 rounded-md border border-sky-200 px-3 py-2" />

      <!-- Custom dropdown -->
      <div class="dropdown w-full sm:w-40" id="tagDropdown">
        <div class="dropdown-btn" id="dropdownBtn">Select tags...</div>
        <div class="dropdown-list" id="dropdownList">
          <label><input type="checkbox" value="Design" /> Design</label>
          <label><input type="checkbox" value="Mechanical" /> Mechanical</label>
          <label><input type="checkbox" value="Programming" /> Programming</label>
          <label><input type="checkbox" value="Electrical" /> Electrical</label>
          <label><input type="checkbox" value="Business" /> Business</label>
          <label><input type="checkbox" value="Misc" /> Misc</label>
        </div>
      </div>

      <button id="addTaskBtn"
        class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-md font-semibold w-full sm:w-auto">
        Add Task
      </button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto">
  <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
  <footer class="mt-12 text-center py-4 border-t border-sky-100 flex flex-col items-center gap-1">
    <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
    <span class="text-sky-600 text-sm">© 2025 Trident Robotics — Task Board</span>
    <span class="text-xs text-sky-400">Internal team dashboard • Customize as needed</span>
  </footer>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHFWZI",
  authDomain: "tridenttaskboard.firebaseapp.com",
  projectId: "tridenttaskboard",
  storageBucket: "tridenttaskboard.firebasestorage.appspot.com",
  messagingSenderId: "143400263387",
  appId: "1:143400263387:web:66ed521ae75af588e836fe",
  measurementId: "G-F12DDQCX87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firestoreDB = db;

const board = document.getElementById("board");
const filterInput = document.getElementById("filterInput");
const addBtn = document.getElementById("addTaskBtn");

// Dropdown
const dropdownBtn = document.getElementById("dropdownBtn");
const dropdownList = document.getElementById("dropdownList");
let selectedTags = [];

// Dropdown toggle
dropdownBtn.addEventListener("click", () => {
  dropdownList.style.display = dropdownList.style.display === "block" ? "none" : "block";
});

// Close dropdown on outside click
document.addEventListener("click", e => {
  if (!document.getElementById("tagDropdown").contains(e.target)) {
    dropdownList.style.display = "none";
    updateDropdownBtn();
  }
});

// Update button text
function updateDropdownBtn() {
  dropdownBtn.textContent = selectedTags.length ? selectedTags.join(", ") : "Select tags...";
}

// Handle checkboxes
dropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => {
  cb.addEventListener("change", () => {
    selectedTags = Array.from(dropdownList.querySelectorAll("input:checked")).map(c => c.value);
    updateDropdownBtn();
  });
});

// ---------------- Task Board Functions ----------------
async function loadTasks() {
  const snapshot = await getDocs(collection(db, "tasks"));
  const data = {
    columns: {
      todo: { title: "To Do", tasks: [] },
      inprogress: { title: "In Progress", tasks: [] },
      done: { title: "Done", tasks: [] }
    },
    order: ["todo","inprogress","done"]
  };
  snapshot.forEach(doc => {
    const t = doc.data();
    if (!data.columns[t.column]) data.columns[t.column] = { title: t.column, tasks: [] };
    data.columns[t.column].tasks.push({ id: doc.id, ...t });
  });
  return data;
}

async function saveTask(task, col) {
  await setDoc(doc(db, "tasks", task.id), {...task, column: col});
}

async function deleteTaskFirestore(taskId) {
  await deleteDoc(doc(db, "tasks", taskId));
}

// ---------------- Render Board ----------------
async function renderBoard() {
  const data = await loadTasks();
  board.innerHTML = "";
  data.order.forEach(colId => {
    const col = data.columns[colId];
    const colEl = document.createElement("section");
    colEl.className = "bg-white rounded-2xl p-4 shadow-sm border border-sky-100 flex flex-col";
    colEl.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-sky-700">${col.title}</h2>
        <div class="text-sm text-sky-500">${col.tasks.length}</div>
      </div>
      <div class="task-list min-h-[120px] space-y-3" data-col="${colId}"></div>
    `;
    board.appendChild(colEl);

    const list = colEl.querySelector(".task-list");
    col.tasks
      .filter(t => {
        const f = filterInput.value.toLowerCase();
        return (
          !f ||
          t.title.toLowerCase().includes(f) ||
          t.assignee.toLowerCase().includes(f) ||
          (t.tags || []).join(" ").toLowerCase().includes(f)
        );
      })
      .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
      .forEach(task => list.appendChild(createTaskEl(task, colId)));

    makeDroppable(list);
  });
}

// ---------------- Create Task Element ----------------
function createTaskEl(task, colId) {
  const div = document.createElement("div");
  div.className = "bg-white border border-sky-100 rounded-lg p-3 shadow-sm";
  div.draggable = true;
  div.dataset.id = task.id;
  div.dataset.col = colId;

  div.innerHTML = `
    <div class="flex items-start justify-between gap-2">
      <div>
        <h3 class="font-medium text-sky-800">${task.title}</h3>
        <div class="text-xs text-sky-500">${task.assignee} • ${task.due || "no due"}</div>
      </div>
      <div class="flex gap-2">
        <button class="text-xs px-2 py-1 border border-sky-200 rounded-md edit-btn">Edit</button>
        <button class="text-xs px-2 py-1 border border-red-100 rounded-md text-red-600 del-btn">Delete</button>
      </div>
    </div>

    <div class="mt-2 flex gap-2 flex-wrap">
      ${(task.tags || []).map(t => `<span class="tag-chip">${t}</span>`).join("")}
    </div>

    <!-- Notes Section -->
    <div class="mt-3">
      <button class="text-xs text-sky-600 underline toggle-comments">Show Notes</button>
      <div class="comments-section hidden mt-2 border-t border-sky-100 pt-2 space-y-2">
        <div class="comments-list text-sm text-sky-800">
          ${(task.comments || []).map(c => `
            <div class="border border-sky-50 rounded-md p-1 bg-sky-50">${c.text}</div>
          `).join("")}
        </div>
        <div class="flex gap-2 mt-2">
          <input type="text" placeholder="Add note..." 
            class="comment-input flex-1 border border-sky-200 rounded-md px-2 py-1 text-sm" />
          <button class="add-comment px-2 py-1 bg-sky-600 text-white rounded-md text-xs">Add</button>
        </div>
      </div>
    </div>
  `;

  // ---- Delete task ----
  div.querySelector(".del-btn").onclick = async () => {
    if (!confirm(`Delete "${task.title}"?`)) return;
    div.classList.add("transition", "duration-300", "opacity-0", "translate-x-4");
    setTimeout(async () => {
      await deleteTaskFirestore(task.id);
      div.remove();
      renderBoard();
    }, 300);
  };

  // ---- Edit task ----
  div.querySelector(".edit-btn").onclick = () => openEditModal(task, colId);

  // ---- Toggle comments visibility ----
  div.querySelector(".toggle-comments").onclick = (e) => {
    const section = div.querySelector(".comments-section");
    const isHidden = section.classList.toggle("hidden");
    e.target.textContent = isHidden ? "Show Notes" : "Hide Notes";
  };

  // ---- Add comment ----
  div.querySelector(".add-comment").onclick = async () => {
    const input = div.querySelector(".comment-input");
    const text = input.value.trim();
    if (!text) return;

    const newComment = { text, timestamp: Date.now() };
    const updatedComments = [...(task.comments || []), newComment];
    await setDoc(doc(db, "tasks", task.id), { comments: updatedComments }, { merge: true });

    task.comments = updatedComments;
    input.value = "";
    renderBoard();
  };

  makeDraggable(div);
  return div;
}

// ---------------- Edit Modal ----------------
function openEditModal(task, colId) {
  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black/30 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-xl w-80 space-y-3">
      <h3 class="text-lg font-semibold text-sky-700 mb-2">Edit Task</h3>
      <input id="editTitle" class="w-full rounded-md border border-sky-200 px-3 py-2" value="${task.title}" />
      <input id="editAssignee" class="w-full rounded-md border border-sky-200 px-3 py-2" value="${task.assignee}" />
      <input id="editDue" type="date" class="w-full rounded-md border border-sky-200 px-3 py-2" value="${task.due}" />

      <div class="dropdown mt-2" id="editTagDropdown">
        <div class="dropdown-btn" id="editDropdownBtn">Select tags...</div>
        <div class="dropdown-list" id="editDropdownList">
          <label><input type="checkbox" value="Design" /> Design</label>
          <label><input type="checkbox" value="Mechanical" /> Mechanical</label>
          <label><input type="checkbox" value="Programming" /> Programming</label>
          <label><input type="checkbox" value="Electrical" /> Electrical</label>
          <label><input type="checkbox" value="Business" /> Business</label>
          <label><input type="checkbox" value="Misc" /> Misc</label>
        </div>
      </div>

      <div class="flex gap-2 pt-2">
        <button id="saveEdit" class="px-3 py-1 bg-sky-600 text-white rounded-md text-sm">Save</button>
        <button id="cancelEdit" class="px-3 py-1 border rounded-md text-sm">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  let editSelectedTags = task.tags.slice();
  const editDropdownBtn = modal.querySelector("#editDropdownBtn");
  const editDropdownList = modal.querySelector("#editDropdownList");

  function updateEditDropdownBtn() {
    editDropdownBtn.textContent = editSelectedTags.length ? editSelectedTags.join(", ") : "Select tags...";
  }

  editDropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => {
    cb.checked = editSelectedTags.includes(cb.value);
    cb.addEventListener("change", () => {
      editSelectedTags = Array.from(editDropdownList.querySelectorAll("input:checked")).map(c => c.value);
      updateEditDropdownBtn();
    });
  });

  editDropdownBtn.addEventListener("click", e => {
    editDropdownList.style.display = editDropdownList.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", e => {
    if (!modal.contains(e.target)) editDropdownList.style.display = "none";
  });

  updateEditDropdownBtn();

  modal.querySelector("#cancelEdit").onclick = () => modal.remove();
  modal.querySelector("#saveEdit").onclick = async () => {
    task.title = modal.querySelector("#editTitle").value;
    task.assignee = modal.querySelector("#editAssignee").value;
    task.due = modal.querySelector("#editDue").value;
    task.tags = editSelectedTags.slice();
    await saveTask(task, colId);
    modal.remove();
    renderBoard();
  };
}

// ---------------- Draggable Task Cards ----------------
function makeDraggable(taskEl) {
  taskEl.addEventListener("dragstart", e => {
    taskEl.classList.add("dragging");
    e.dataTransfer.setData("text/plain", JSON.stringify({
      id: taskEl.dataset.id,
      from: taskEl.dataset.col
    }));
  });

  taskEl.addEventListener("dragend", async () => {
    taskEl.classList.remove("dragging");

    // After drag ends, recalculate order in current column
    const parentCol = taskEl.closest(".task-list");
    if (!parentCol) return;

    const siblings = [...parentCol.querySelectorAll("[data-id]")];
    for (let i = 0; i < siblings.length; i++) {
      const id = siblings[i].dataset.id;
      await setDoc(doc(db, "tasks", id), {
        order: i,
        column: parentCol.dataset.col
      }, { merge: true });
    }
  });
}
  
// ---------------- Drag & Drop ----------------
function makeDroppable(el) {
  el.addEventListener("dragover", e => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    if (!dragging) return;

    const afterElement = getDragAfterElement(el, e.clientY);
    if (afterElement && afterElement instanceof Node) {
      el.insertBefore(dragging, afterElement);
    } else {
      el.appendChild(dragging);
    }
  });

  el.addEventListener("drop", async e => {
    e.preventDefault();
    const data = e.dataTransfer.getData("text/plain");
    if (!data) return;

    const { id, from } = JSON.parse(data);
    const to = el.dataset.col;
    const taskDocRef = doc(db, "tasks", id);
    const taskSnap = await getDoc(taskDocRef);
    if (!taskSnap.exists()) return;

    const taskData = taskSnap.data();
    const newColumn = to;

    // Move to new column
    await setDoc(taskDocRef, { ...taskData, column: newColumn }, { merge: true });

    // Recalculate order
    const taskEls = [...el.querySelectorAll("[data-id]")];
    for (let i = 0; i < taskEls.length; i++) {
      const tId = taskEls[i].dataset.id;
      await setDoc(doc(db, "tasks", tId), { order: i, column: newColumn }, { merge: true });
    }

    await renderBoard();
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll(".bg-white:not(.dragging)")];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ---------------- Add Task ----------------
addBtn.onclick = async () => {
  const title = document.getElementById("newTitle").value.trim();
  if (!title) return;

  const assignee = document.getElementById("newAssignee").value || "Unassigned";
  const due = document.getElementById("newDue").value;

  const snapshot = await getDocs(collection(db, "tasks"));
  const count = snapshot.size; // for order tracking
  const task = { 
    title, assignee, due, tags: selectedTags.slice(), 
    column: "todo", 
    order: count // add order index
  };
  const docRef = await addDoc(collection(db, "tasks"), task);
  task.id = docRef.id;

  document.getElementById("newTitle").value = "";
  document.getElementById("newAssignee").value = "";
  document.getElementById("newDue").value = "";
  selectedTags = [];
  dropdownList.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
  updateDropdownBtn();

  await renderBoard();
};

filterInput.oninput = renderBoard;
renderBoard();
</script>

</body>
</html>
