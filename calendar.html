<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trident Robotics — Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Match tasks.html overall vibe */
    html, body { height: 100%; overflow: hidden; }
    body { background: linear-gradient(to bottom, #f0f9ff, white); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Day cell styling */
    .day-cell {
      background: white;
      border: 1px solid #e2e8f0; /* slate-200 */
      border-radius: 0.75rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      min-width: 0;
      transition: border-color 150ms, box-shadow 150ms, transform 150ms;
      cursor: pointer;
    }
    .day-cell:hover {
      border-color: #93c5fd; /* sky-300 */
      box-shadow: 0 6px 16px rgba(2,132,199,0.12);
      transform: translateY(-1px);
    }
    .day-muted { opacity: 0.45; }
    .today-dot {
      display: inline-block;
      width: 0.375rem;
      height: 0.375rem;
      background: #0ea5e9; /* sky-500 */
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    .event-pill,
    .task-pill {
      display: block;
      font-size: 0.75rem;
      line-height: 1.1rem;
      border-radius: 0.5rem;
      padding: 0.125rem 0.375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .event-pill {
      background: #e0f2fe;      /* sky-100 */
      color: #0369a1;           /* sky-700 */
      border: 1px solid #bae6fd;/* sky-200 */
    }
    .task-pill {
      background: #ecfdf5;       /* emerald-50 */
      color: #047857;            /* emerald-700 */
      border: 1px solid #a7f3d0; /* emerald-200 */
    }
    .more-pill {
      display: inline-block;
      font-size: 0.72rem;
      color: #64748b;            /* slate-500 */
    }

    .weekday {
      font-size: 0.75rem;
      color: #0369a1; /* sky-700 */
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; border-radius: 0.75rem; width: min(720px, calc(100vw - 2rem)); max-height: min(80vh, 640px); overflow: auto; border: 1px solid #e2e8f0; }

    /* Dark mode match (from tasks.html palette) */
    @media (prefers-color-scheme: dark) {
      html, body { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #0b1220, #0a0f1a); color: #e5e7eb; }
      .day-cell { background: #0f172a !important; border-color: #1f2937 !important; box-shadow: 0 1px 2px rgba(2, 6, 23, 0.3); }
      .day-cell:hover { border-color: #0ea5e9 !important; box-shadow: 0 6px 16px rgba(14,165,233,0.18); }

      .weekday { color: #7dd3fc !important; }
      .event-pill { background: #0c4a6e !important; color: #e0f2fe !important; border-color: #075985 !important; }
      .task-pill  { background: #052e2b !important; color: #a7f3d0 !important; border-color: #065f46 !important; }
      .more-pill { color: #94a3b8 !important; }

      .modal-card { background: #0f172a !important; border-color: #1f2937 !important; }
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <header class="max-w-7xl mx-auto mb-6 px-2">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0">
      <div class="flex flex-col gap-1 w-full md:w-auto">
        <h1 class="text-2xl md:text-3xl font-extrabold text-sky-800 leading-snug dark:text-sky-300">Trident Robotics — Calendar</h1>
        <p class="text-sm text-sky-600 dark:text-sky-400">Public events for everyone. Team tasks appear only when signed in with Google on the home page.</p>
      </div>

      <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-end">
        <div id="taskAccessBadge" class="text-xs px-2 py-1 rounded border border-slate-300 text-slate-600 bg-white shadow-sm dark:bg-slate-900 dark:text-slate-300 dark:border-slate-700">
          Tasks hidden • Sign in on the home page
        </div>
      </div>
    </div>

    <div class="mt-4 bg-white p-3 rounded-2xl shadow-sm border border-slate-200 ring-1 ring-slate-100 dark:bg-slate-900 dark:border-slate-800 dark:ring-slate-900/10">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="prevBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Previous month" aria-label="Previous month">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div id="monthLabel" class="text-base font-semibold text-slate-700 dark:text-slate-200 min-w-[10ch]"></div>
          <button id="nextBtn" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" title="Next month" aria-label="Next month">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
          <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-sky-200 border border-sky-300 dark:bg-[#0c4a6e] dark:border-[#075985]"></span> Event</span>
          <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 dark:bg-[#052e2b] dark:border-[#065f46]"></span> Task due</span>
          <span class="inline-flex items-center gap-1"><span class="today-dot"></span> Today</span>
        </div>
      </div>
    </div>
  </header>

  <!-- NOTE: removed fixed h-[calc(...)] to prevent compounding layout shrink -->
  <main class="max-w-7xl mx-auto flex flex-col">
    <!-- Weekday header -->
    <div id="weekdayHeader" class="grid grid-cols-7 px-2 py-2">
      <div class="weekday">Sun</div>
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
    </div>

    <!-- Calendar grid (7 x 6) -->
    <div id="calendarGrid" class="grid grid-cols-7 grid-rows-6 gap-2 px-2 overflow-hidden"></div>

    <footer class="mt-4 text-center py-4 border-t border-slate-100 dark:border-slate-800 flex flex-col items-center gap-1">
      <img src="/assets/logo.png" alt="Trident Robotics Logo" class="h-6 w-6" />
      <span class="text-sky-600 dark:text-sky-400 text-sm">© 2025 Trident Robotics — Calendar</span>
      <span class="text-xs text-sky-400">Public calendar • Tasks appear when signed in</span>
    </footer>
  </main>

  <!-- Modal for full day details -->
  <div id="dayModal" class="modal-overlay">
    <div class="modal-card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div id="modalDate" class="text-lg font-bold text-slate-800 dark:text-slate-200"></div>
          <div class="text-xs text-slate-500 dark:text-slate-400">All items for this date</div>
        </div>
        <button id="closeModal" class="inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div id="modalContent" class="space-y-4">
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Events</div>
          <div id="modalEvents" class="space-y-1 text-sm"></div>
        </div>
        <div>
          <div class="text-sm font-semibold mb-1 text-slate-700 dark:text-slate-300">Tasks due</div>
          <div id="modalTasks" class="space-y-1 text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    // Same Firebase project as tasks.html
    const firebaseConfig = {
      apiKey: "AIzaSyC7k3xdqmsuYOEBBDbDfnrmuaebLaHFWZI",
      authDomain: "tridenttaskboard.firebaseapp.com",
      projectId: "tridenttaskboard",
      storageBucket: "tridenttaskboard.firebasestorage.appspot.com",
      messagingSenderId: "143400263387",
      appId: "1:143400263387:web:66ed521ae75af588e836fe",
      measurementId: "G-F12DDQCX87"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const monthLabel = document.getElementById("monthLabel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const grid = document.getElementById("calendarGrid");
    const badge = document.getElementById("taskAccessBadge");

    const modal = document.getElementById("dayModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalDateEl = document.getElementById("modalDate");
    const modalEventsEl = document.getElementById("modalEvents");
    const modalTasksEl = document.getElementById("modalTasks");

    // Google Sign-In state from index.html
    const G_CRED_KEY = "g_credential_v1";
    const allowedDomains = ["wths.net"];
    const allowedEmails = ["blackshocktrooper@gmail.com"];

    function decodeJwtPayload(raw) {
      try {
        const parts = String(raw).split(".");
        if (parts.length < 2) return null;
        const base64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = atob(base64);
        try {
          // handle unicode
          const decoded = decodeURIComponent(Array.prototype.map.call(json, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
          return JSON.parse(decoded);
        } catch {
          return JSON.parse(json);
        }
      } catch {
        return null;
      }
    }

    function getGoogleProfile() {
      const raw = localStorage.getItem(G_CRED_KEY);
      if (!raw) return null;
      return decodeJwtPayload(raw);
    }

    function isTaskAccessAllowed() {
      const prof = getGoogleProfile();
      if (!prof || !prof.email) return false;
      const email = String(prof.email).toLowerCase();
      const domainAllowed = allowedDomains.some(d => email.endsWith("@" + d));
      const emailAllowed = allowedEmails.map(e => e.toLowerCase()).includes(email);
      return domainAllowed || emailAllowed;
    }

    function setTaskAccessBadge() {
      const allowed = isTaskAccessAllowed();
      if (!badge) return;
      if (allowed) {
        badge.textContent = "Tasks visible • Signed in";
        badge.classList.remove("border-slate-300", "text-slate-600");
        badge.classList.add("border-emerald-300", "text-emerald-700");
      } else {
        badge.textContent = "Tasks hidden • Sign in on the home page";
        badge.classList.remove("border-emerald-300", "text-emerald-700");
        badge.classList.add("border-slate-300", "text-slate-600");
      }
    }

    // Date state
    let current = new Date();
    current.setDate(1); // focus on the first of the month

    // Data caches
    let events = [];  // {title, date(YYYY-MM-DD), time?, location?, isPublic?}
    let tasks = [];   // firestore tasks (only when access allowed)

    function pad(n) { return String(n).padStart(2, "0"); }
    function fmtDateKey(d) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function monthMatrix(year, month) {
      // Build an array of 42 day objects for a 6-row calendar grid
      const first = new Date(year, month, 1);
      const startDay = first.getDay(); // 0..6 (Sun..Sat)
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevDays = new Date(year, month, 0).getDate();

      const cells = [];
      // Leading days from previous month
      for (let i = 0; i < startDay; i++) {
        const day = prevDays - startDay + 1 + i;
        cells.push({ date: new Date(year, month - 1, day), inMonth: false });
      }
      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        cells.push({ date: new Date(year, month, d), inMonth: true });
      }
      // Trailing days from next month
      while (cells.length < 42) {
        const last = cells[cells.length - 1].date;
        cells.push({ date: new Date(last.getFullYear(), last.getMonth(), last.getDate() + 1), inMonth: false });
      }
      return cells;
    }

    function groupByDate(items, getKey) {
      const map = new Map();
      for (const it of items) {
        const k = getKey(it);
        if (!k) continue;
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }

    async function loadEvents() {
      try {
        const snap = await getDocs(collection(db, "events"));
        const arr = [];
        snap.forEach(doc => {
          const e = doc.data() || {};
          const date = typeof e.date === "string" ? e.date : "";
          if (!date) return;
          arr.push({
            id: doc.id,
            title: e.title || "(Untitled)",
            date,
            time: e.time || "",
            location: e.location || "",
            isPublic: e.isPublic !== false // default true
          });
        });
        events = arr;
      } catch (err) {
        console.warn("Failed to load events:", err);
        events = [];
      }
    }

    async function loadTasksIfAllowed() {
      if (!isTaskAccessAllowed()) {
        tasks = [];
        return;
      }
      try {
        const snap = await getDocs(collection(db, "tasks"));
        const arr = [];
        snap.forEach(doc => {
          const t = doc.data() || {};
          if (t.deleted || t.archived) return;
          arr.push({
            id: doc.id,
            title: t.title || "(Untitled)",
            assignee: t.assignee || "Unassigned",
            due: typeof t.due === "string" ? t.due : ""
          });
        });
        tasks = arr;
      } catch (err) {
        console.warn("Failed to load tasks:", err);
        tasks = [];
      }
    }

    function renderMonthLabel(year, month) {
      const dtf = new Intl.DateTimeFormat([], { month: "long", year: "numeric" });
      monthLabel.textContent = dtf.format(new Date(year, month, 1));
    }

    function isToday(d) {
      const now = new Date();
      return d.getFullYear() === now.getFullYear() &&
             d.getMonth() === now.getMonth() &&
             d.getDate() === now.getDate();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function openModal(dateObj, dayEvents, dayTasks) {
      modalDateEl.textContent = dateObj.toLocaleDateString([], { weekday: "long", year: "numeric", month: "long", day: "numeric" });

      // Events (public only)
      modalEventsEl.innerHTML = (dayEvents.length
        ? dayEvents.map(e => {
            const time = e.time ? ` • ${e.time}` : "";
            const loc = e.location ? ` • ${e.location}` : "";
            return `<div class="p-2 rounded border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900"><span class="event-pill">${escapeHtml(e.title)}</span><div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(e.date)}${escapeHtml(time)}${escapeHtml(loc)}</div></div>`;
          }).join("")
        : '<div class="text-slate-400 text-sm">No events</div>'
      );

      // Tasks
      modalTasksEl.innerHTML = (dayTasks.length
        ? dayTasks.map(t => {
            const who = t.assignee ? ` • ${t.assignee}` : "";
            return `<div class="p-2 rounded border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900"><span class="task-pill">${escapeHtml(t.title)}</span><div class="text-xs text-slate-500 dark:text-slate-400 mt-1">${escapeHtml(t.due)}${escapeHtml(who)}</div></div>`;
          }).join("")
        : '<div class="text-slate-400 text-sm">No tasks due</div>'
      );

      modal.classList.add("open");
    }

    function closeModal() { modal.classList.remove("open"); }
    document.getElementById("closeModal").onclick = closeModal;
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    function renderGrid(year, month) {
      renderMonthLabel(year, month);
      grid.innerHTML = "";

      const cells = monthMatrix(year, month);

      const eventsByDate = groupByDate(
        events.filter(e => e.isPublic === true),
        e => e.date
      );
      const canSeeTasks = isTaskAccessAllowed();
      const tasksByDate = canSeeTasks ? groupByDate(tasks, t => t.due) : new Map();

      // Fit count depending on screen width to avoid overflow
      const MAX_VISIBLE = window.innerWidth < 640 ? 2 : 3;

      for (const { date, inMonth } of cells) {
        const key = fmtDateKey(date);
        const dayEvents = (eventsByDate.get(key) || []);
        const dayTasks = canSeeTasks ? (tasksByDate.get(key) || []) : [];
        const total = dayEvents.length + dayTasks.length;

        const cell = document.createElement("div");
        cell.className = "day-cell text-left";
        cell.setAttribute("data-date", key);
        if (!inMonth) cell.classList.add("day-muted");

        // Header row: day number (+ today marker)
        const head = document.createElement("div");
        head.className = "flex items-center justify-between gap-2 shrink-0";
        const num = document.createElement("div");
        num.className = "text-sm font-semibold text-slate-700 dark:text-slate-200";
        num.textContent = date.getDate();
        head.appendChild(num);
        if (isToday(date)) {
          const dot = document.createElement("span");
          dot.className = "today-dot";
          head.appendChild(dot);
        }
        cell.appendChild(head);

        // Items (events then tasks)
        const items = document.createElement("div");
        items.className = "flex flex-col gap-1 min-h-0 overflow-hidden";

        const addPill = (txt, cls) => {
          const span = document.createElement("span");
          span.className = cls;
          span.title = txt;
          span.textContent = txt;
          items.appendChild(span);
        };

        let shown = 0;
        for (const e of dayEvents) {
          if (shown >= MAX_VISIBLE) break;
          addPill(e.title, "event-pill");
          shown++;
        }
        for (const t of dayTasks) {
          if (shown >= MAX_VISIBLE) break;
          addPill(t.title, "task-pill");
          shown++;
        }

        if (total > shown) {
          const more = document.createElement("span");
          more.className = "more-pill";
          more.textContent = `+${total - shown} more`;
          items.appendChild(more);
        }

        cell.appendChild(items);

        // Open modal with full list
        cell.addEventListener("click", () => openModal(date, dayEvents, dayTasks));

        grid.appendChild(cell);
      }
    }

    async function render() {
      setTaskAccessBadge();
      // Load data (tasks only if allowed) in parallel
      await Promise.all([loadEvents(), loadTasksIfAllowed()]);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    }

    prevBtn.onclick = () => {
      current.setMonth(current.getMonth() - 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    };
    nextBtn.onclick = () => {
      current.setMonth(current.getMonth() + 1);
      renderGrid(current.getFullYear(), current.getMonth());
      layoutHeights();
    };

    // Stable layout sizing to prevent “shrinking then disappearing”
    function layoutHeights() {
      const viewport = window.innerHeight;
      const outerHeader = document.querySelector("header");
      const main = document.querySelector("main");
      const weekHeader = document.getElementById("weekdayHeader");
      const footer = main.querySelector("footer");

      const headerH = outerHeader.offsetHeight;
      const footerH = footer.offsetHeight;
      const vhRemaining = Math.max(0, viewport - headerH - 24); // small margin

      // Set main to fill remaining viewport
      main.style.height = `${vhRemaining}px`;
      main.style.minHeight = `${vhRemaining}px`;

      // Give the calendar grid a precise height (no page scroll)
      const gridH = Math.max(180, vhRemaining - weekHeader.offsetHeight - footerH - 16);
      grid.style.height = `${gridH}px`;

      // Ensure equal 6 rows that won't collapse
      grid.style.gridAutoRows = "minmax(0, 1fr)";
    }

    window.addEventListener("resize", () => {
      layoutHeights();
    });

    // Initial load
    render();
  </script>
</body>
</html>
